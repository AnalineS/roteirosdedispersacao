# -*- coding: utf-8 -*-
name: QA Automation Suite
on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to test (local, hml, development)'
        required: true
        default: 'local'
        type: choice
        options:
          - local
          - hml
          - development
      test_depth:
        description: 'Test depth'
        required: true
        default: 'extensive'
        type: choice
        options:
          - basic
          - extensive
      create_issues:
        description: 'Create GitHub issues for failures'
        required: true
        default: true
        type: boolean

  schedule:
    # Executa diariamente Ã s 02:00 UTC (23:00 BRT)
    - cron: '0 2 * * *'

  pull_request:
    branches: [ main, feature/* ]
    paths:
      - 'apps/backend/**'
      - 'apps/frontend-nextjs/**'
      - 'tests/**'

jobs:
  qa-automation:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      actions: read
    
    env:
      # Backend Configuration
      SECRET_KEY: ${{ secrets.SECRET_KEY }}
      OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
      
      # Firebase Configuration
      FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
      FIREBASE_API_KEY: ${{ secrets.FIREBASE_API_KEY }}
      FIREBASE_AUTH_DOMAIN: ${{ secrets.FIREBASE_AUTH_DOMAIN }}
      FIREBASE_STORAGE_BUCKET: ${{ secrets.FIREBASE_STORAGE_BUCKET }}
      FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}
      FIREBASE_APP_ID: ${{ secrets.FIREBASE_APP_ID }}
      
      # Google Cloud Configuration
      GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      GCP_REGION: ${{ secrets.GCP_REGION }}
      
      # Supabase Configuration
      SUPABASE_PROJECT_URL: ${{ secrets.SUPABASE_PROJECT_URL }}
      SUPABASE_API_KEY: ${{ secrets.SUPABASE_API_KEY }}
      
      # Environment Settings
      ENVIRONMENT: ${{ github.event.inputs.environment || 'local' }}
      CORS_ORIGINS: 'http://localhost:3000,http://127.0.0.1:3000,http://localhost:5173,http://127.0.0.1:5173'
      FIRESTORE_CACHE_ENABLED: 'true'
      HYBRID_CACHE_STRATEGY: 'firestore_first'
      
      # GitHub Configuration for Issues
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      GITHUB_REPOSITORY_OWNER: ${{ github.repository_owner }}
      GITHUB_REPOSITORY_NAME: ${{ github.event.repository.name }}

    steps:
      - name: ğŸ”„ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: 'apps/frontend-nextjs/package-lock.json'

      - name: ğŸ”§ Install Python Dependencies
        run: |
          cd apps/backend
          pip install -r requirements.txt

      - name: ğŸ“± Install Node.js Dependencies
        run: |
          cd apps/frontend-nextjs
          npm ci

      - name: ğŸ§ª Prepare QA Environment
        run: |
          # Criar diretÃ³rios necessÃ¡rios
          mkdir -p tests/qa-automation/reports
          mkdir -p tests/qa-automation/logs
          
          # Configurar permissÃµes
          chmod +x tests/qa-automation/*.py

      - name: ğŸš€ Start Backend Service
        run: |
          cd apps/backend
          python main.py &
          echo $! > backend.pid
          
          # Aguardar inicializaÃ§Ã£o
          sleep 10
          
          # Verificar se estÃ¡ rodando
          if curl -f -H "User-Agent: QA-Automation-Health-Check/1.0" http://localhost:8080/api/health; then
            echo "âœ… Backend iniciado com sucesso"
          else
            echo "âŒ Falha ao iniciar backend"
            exit 1
          fi
        timeout-minutes: 2

      - name: ğŸ” Execute QA Test Suite
        id: qa_tests
        run: |
          cd tests/qa-automation
          
          # Definir parÃ¢metros baseados nos inputs
          TEST_ENV="${{ github.event.inputs.environment || 'local' }}"
          TEST_DEPTH="${{ github.event.inputs.test_depth || 'extensive' }}"
          
          echo "ğŸ§ª Executando testes QA - Ambiente: $TEST_ENV, Profundidade: $TEST_DEPTH"
          
          # Executar suite principal com timeout
          timeout 600 python main_test_runner.py --env="$TEST_ENV" --$TEST_DEPTH \
            --report-format=json \
            --output-dir=reports \
            --create-issues="${{ github.event.inputs.create_issues || 'true' }}" \
            || echo "qa_tests_failed=true" >> $GITHUB_OUTPUT
          
        timeout-minutes: 12
        continue-on-error: true

      - name: ğŸ§¹ Stop Backend Service
        if: always()
        run: |
          if [ -f apps/backend/backend.pid ]; then
            kill $(cat apps/backend/backend.pid) || true
            rm apps/backend/backend.pid
          fi
          # Cleanup adicional
          pkill -f "python main.py" || true

      - name: ğŸ“Š Process Test Results
        if: always()
        run: |
          cd tests/qa-automation
          
          echo "ğŸ“‹ Processando resultados dos testes..."
          
          # Verificar se arquivos de resultado existem
          if [ -f "reports/qa_results.json" ]; then
            echo "âœ… Arquivo de resultados encontrado"
            
            # Extrair estatÃ­sticas bÃ¡sicas
            TOTAL_TESTS=$(jq -r '.summary.total_tests // 0' reports/qa_results.json)
            PASSED_TESTS=$(jq -r '.summary.passed // 0' reports/qa_results.json)
            FAILED_TESTS=$(jq -r '.summary.failed // 0' reports/qa_results.json)
            WARNINGS=$(jq -r '.summary.warnings // 0' reports/qa_results.json)
            
            echo "ğŸ“ˆ EstatÃ­sticas:"
            echo "   - Total de testes: $TOTAL_TESTS"
            echo "   - Testes aprovados: $PASSED_TESTS" 
            echo "   - Testes falhados: $FAILED_TESTS"
            echo "   - Warnings: $WARNINGS"
            
            # Salvar estatÃ­sticas para o job summary
            {
              echo "## ğŸ“Š Resultados QA Automation"
              echo "| MÃ©trica | Valor |"
              echo "|---------|-------|"
              echo "| Total de Testes | $TOTAL_TESTS |"
              echo "| âœ… Aprovados | $PASSED_TESTS |" 
              echo "| âŒ Falhados | $FAILED_TESTS |"
              echo "| âš ï¸ Warnings | $WARNINGS |"
            } >> $GITHUB_STEP_SUMMARY
            
          else
            echo "âš ï¸ Arquivo de resultados nÃ£o encontrado"
            echo "## âš ï¸ Resultados QA Automation" >> $GITHUB_STEP_SUMMARY
            echo "NÃ£o foi possÃ­vel processar os resultados - arquivo nÃ£o encontrado" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ğŸ“„ Upload Test Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: qa-reports-${{ github.run_number }}
          path: |
            tests/qa-automation/reports/
            tests/qa-automation/logs/
          retention-days: 30

      - name: ğŸ› Create Issues for Critical Failures
        if: always() && (steps.qa_tests.outputs.qa_tests_failed == 'true' || github.event.inputs.create_issues == 'true')
        run: |
          cd tests/qa-automation
          
          echo "ğŸ› Verificando falhas crÃ­ticas para criaÃ§Ã£o de issues..."
          
          if [ -f "reports/qa_results.json" ]; then
            # Executar script de criaÃ§Ã£o de issues
            python utils/github_issues.py \
              --results-file="reports/qa_results.json" \
              --repository="${{ github.repository }}" \
              --token="${{ secrets.GITHUB_TOKEN }}" \
              --run-id="${{ github.run_id }}" \
              --environment="${{ github.event.inputs.environment || 'local' }}" \
              --create-on-failure=true \
              --create-on-warning=true
          else
            echo "âš ï¸ NÃ£o foi possÃ­vel criar issues - arquivo de resultados nÃ£o encontrado"
          fi

      - name: ğŸ’¬ Comment on PR (if applicable)
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            let comment = '## ğŸ§ª QA Automation Results\n\n';
            
            try {
              const results = JSON.parse(fs.readFileSync('tests/qa-automation/reports/qa_results.json', 'utf8'));
              
              const total = results.summary?.total_tests || 0;
              const passed = results.summary?.passed || 0;
              const failed = results.summary?.failed || 0;
              const warnings = results.summary?.warnings || 0;
              
              comment += `ğŸ“Š **Summary**: ${passed}/${total} tests passed`;
              if (failed > 0) comment += `, ${failed} failed`;
              if (warnings > 0) comment += `, ${warnings} warnings`;
              
              comment += '\n\n';
              
              if (failed > 0 || warnings > 0) {
                comment += 'âš ï¸ **Issues detected** - check the detailed report in the action artifacts.\n\n';
              } else {
                comment += 'âœ… **All tests passed successfully!**\n\n';
              }
              
            } catch (error) {
              comment += 'âŒ **Could not parse test results** - check action logs for details.\n\n';
            }
            
            comment += `ğŸ”— [View full report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: ğŸ¯ Set Job Status
        if: always()
        run: |
          if [[ "${{ steps.qa_tests.outputs.qa_tests_failed }}" == "true" ]]; then
            echo "âŒ QA tests failed - setting job as failed"
            exit 1
          else
            echo "âœ… QA tests completed successfully"
          fi