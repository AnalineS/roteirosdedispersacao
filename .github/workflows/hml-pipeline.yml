name: ğŸ§ª Pipeline de HomologaÃ§Ã£o (HML)

on:
  push:
    branches: [hml]
    paths:
      - 'apps/backend/**'
      - 'apps/frontend-nextjs/**'
      - '.github/workflows/hml-pipeline.yml'
      # MANTER documentaÃ§Ã£o - nunca ignorar
      - '**/*.md'
      - '**/README*'
      - '**/*.json'  # package.json, etc
  pull_request:
    branches: [hml]
    # PRs para HML devem ser testados
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'ForÃ§ar deploy mesmo com falhas nos testes'
        required: false
        default: false
        type: boolean
      run_extended_tests:
        description: 'Executar testes estendidos (demorado)'
        required: false
        default: false
        type: boolean

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'

jobs:
  # =====================================
  # 1. DETECÃ‡ÃƒO DE MUDANÃ‡AS HML
  # =====================================
  hml-validation:
    name: ğŸ§ª ValidaÃ§Ã£o para HML (PrÃ©-ProduÃ§Ã£o)
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.changes.outputs.backend }}
      frontend: ${{ steps.changes.outputs.frontend }}
      should-deploy: ${{ steps.decision.outputs.deploy }}
      is-promotion: ${{ steps.decision.outputs.promotion }}
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: ğŸ” Detectar MudanÃ§as HML
        id: changes
        run: |
          echo "ğŸ§ª Detectando mudanÃ§as para ambiente de HML..."
          
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "ğŸ“‹ Analisando PR para HML: comparando com branch base ${{ github.base_ref }}"
            git fetch origin ${{ github.base_ref }}
            BACKEND_CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '^apps/backend/' | wc -l || echo "0")
            FRONTEND_CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '^apps/frontend-nextjs/' | wc -l || echo "0")
            WORKFLOW_CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '^\.github/workflows/' | wc -l || echo "0")
          else
            echo "ğŸ“‹ Analisando push para HML: comparando commits"
            if [ "${{ github.event.before }}" != "0000000000000000000000000000000000000000" ] && [ -n "${{ github.event.before }}" ]; then
              BACKEND_CHANGED=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -E '^apps/backend/' | wc -l || echo "0")
              FRONTEND_CHANGED=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -E '^apps/frontend-nextjs/' | wc -l || echo "0")
              WORKFLOW_CHANGED=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -E '^\.github/workflows/' | wc -l || echo "0")
            else
              echo "âš ï¸ Primeiro commit ou before nÃ£o disponÃ­vel - assumindo mudanÃ§as"
              BACKEND_CHANGED=1
              FRONTEND_CHANGED=1
              WORKFLOW_CHANGED=1
            fi
          fi
          
          echo "ğŸ“Š Resultados da detecÃ§Ã£o HML:"
          echo "  Backend alterado: $BACKEND_CHANGED arquivos"
          echo "  Frontend alterado: $FRONTEND_CHANGED arquivos" 
          echo "  Workflows alterados: $WORKFLOW_CHANGED arquivos"
          
          echo "backend=$([ $BACKEND_CHANGED -gt 0 ] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "frontend=$([ $FRONTEND_CHANGED -gt 0 ] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "workflow=$([ $WORKFLOW_CHANGED -gt 0 ] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT

      - name: ğŸ¯ DecisÃ£o de Deploy HML
        id: decision
        run: |
          echo "ğŸ¯ Determinando estratÃ©gia de deploy para HML..."
          
          SHOULD_DEPLOY="false"
          IS_PROMOTION="false"
          
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            SHOULD_DEPLOY="true"
            echo "ğŸ”§ Deploy manual solicitado para HML"
          elif [ "${{ github.event_name }}" == "push" ]; then
            if [ "${{ steps.changes.outputs.backend }}" == "true" ] || [ "${{ steps.changes.outputs.frontend }}" == "true" ]; then
              SHOULD_DEPLOY="true"
              echo "âœ… Push em HML com mudanÃ§as - deploy automÃ¡tico"
              
              # Verificar se Ã© um merge/promote da main
              RECENT_COMMITS=$(git log --oneline -5)
              if echo "$RECENT_COMMITS" | grep -qi "merge.*main\|promote.*production"; then
                IS_PROMOTION="true"
                echo "ğŸš€ Detectado promote/merge da produÃ§Ã£o para HML"
              fi
            else
              echo "â„¹ï¸ Push em HML sem mudanÃ§as relevantes"
            fi
          elif [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "ğŸ§ª Pull Request - executar apenas testes (sem deploy)"
          fi
          
          echo "deploy=$SHOULD_DEPLOY" >> $GITHUB_OUTPUT
          echo "promotion=$IS_PROMOTION" >> $GITHUB_OUTPUT
          
          echo "ğŸ“‹ DECISÃƒO DE DEPLOY HML:"
          echo "  Deploy: $SHOULD_DEPLOY"
          echo "  PromoÃ§Ã£o: $IS_PROMOTION"
          echo "  Evento: ${{ github.event_name }}"

  # =====================================
  # 2. TESTES E QUALIDADE HML
  # =====================================
  hml-quality-gates:
    name: ğŸ›¡ï¸ Testes e Qualidade HML
    runs-on: ubuntu-latest
    needs: hml-validation
    if: needs.hml-validation.outputs.backend == 'true' || needs.hml-validation.outputs.frontend == 'true' || github.event.inputs.force_deploy == 'true'
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        if: needs.hml-validation.outputs.backend == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ğŸ“¦ Setup Node.js
        if: needs.hml-validation.outputs.frontend == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: apps/frontend-nextjs/package-lock.json

      - name: ğŸ§ª Testes Backend HML
        if: needs.hml-validation.outputs.backend == 'true'
        run: |
          echo "ğŸ§ª Executando testes backend para HML..."
          cd apps/backend
          pip install -r requirements.txt
          pip install pytest flake8 mypy
          
          # Linting mais permissivo para HML
          echo "ğŸ” Verificando qualidade de cÃ³digo..."
          flake8 . --count --max-complexity=12 --max-line-length=140 --statistics || echo "âš ï¸ Avisos de linting encontrados (nÃ£o bloqueante para HML)"
          
          # Testes
          echo "ğŸ§ª Executando testes..."
          python -m pytest --tb=short -v || echo "âš ï¸ Alguns testes falharam (verificar se sÃ£o crÃ­ticos)"
          
          # Testes estendidos se solicitado
          if [ "${{ github.event.inputs.run_extended_tests }}" == "true" ]; then
            echo "ğŸ”¬ Executando testes estendidos..."
            python -m pytest --tb=short -v --cov=. --cov-report=html || true
          fi

      - name: ğŸ§ª Testes Frontend HML  
        if: needs.hml-validation.outputs.frontend == 'true'
        run: |
          echo "ğŸ§ª Executando testes frontend para HML..."
          cd apps/frontend-nextjs
          npm ci
          
          # Linting mais permissivo para HML
          echo "ğŸ” Verificando qualidade de cÃ³digo..."
          npm run lint || echo "âš ï¸ Avisos de linting encontrados (nÃ£o bloqueante para HML)"
          
          echo "ğŸ” Verificando tipos..."
          npm run type-check || echo "âš ï¸ Avisos de TypeScript encontrados (nÃ£o bloqueante para HML)"
          
          echo "ğŸ§ª Executando testes..."
          npm run test -- --passWithNoTests || echo "âš ï¸ Alguns testes falharam (verificar se sÃ£o crÃ­ticos)"
          
          echo "ğŸ—ï¸ Testando build..."
          npm run build || echo "âŒ Build falhou - pode afetar deploy"

      - name: ğŸ”’ VerificaÃ§Ã£o de SeguranÃ§a BÃ¡sica
        continue-on-error: true
        run: |
          echo "ğŸ”’ VerificaÃ§Ã£o bÃ¡sica de seguranÃ§a para HML..."
          echo "ğŸ’¡ AnÃ¡lise completa de seguranÃ§a executada pelo workflow security-unified"
          echo "âœ… VerificaÃ§Ã£o delegada para pipeline de seguranÃ§a"

  # =====================================
  # 3. DEPLOY HML (PRÃ‰-PRODUÃ‡ÃƒO)
  # =====================================
  hml-deploy:
    name: ğŸš€ Deploy HML (PrÃ©-ProduÃ§Ã£o)
    runs-on: ubuntu-latest
    needs: [hml-validation, hml-quality-gates]
    if: needs.hml-validation.outputs.should-deploy == 'true' && (needs.hml-quality-gates.result == 'success' || github.event.inputs.force_deploy == 'true')
    
    outputs:
      backend-url: ${{ steps.backend-deploy.outputs.url }}
      frontend-url: ${{ steps.frontend-deploy.outputs.url }}
    
    steps:
      - name: ğŸ“¥ Checkout  
        uses: actions/checkout@v4

      - name: ğŸ” Autenticar no Google Cloud
        uses: google-github-actions/auth@v3
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          export_environment_variables: true
          create_credentials_file: true

      - name: ğŸ› ï¸ Setup Cloud SDK
        uses: google-github-actions/setup-gcloud@v3
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: ğŸš€ Deploy Backend HML
        id: backend-deploy
        if: needs.hml-validation.outputs.backend == 'true'
        run: |
          cd apps/backend
          
          # ConfiguraÃ§Ã£o especÃ­fica de HML
          SERVICE_NAME="roteiro-dispensacao-api-hml"
          ENV_VARS="ENVIRONMENT=homologacao,FLASK_ENV=production"
          
          echo "ğŸ§ª DEPLOY EM HML - BACKEND"
          echo "  ServiÃ§o: $SERVICE_NAME"
          echo "  Environment: homologacao"
          
          if [ "${{ needs.hml-validation.outputs.is-promotion }}" == "true" ]; then
            echo "ğŸš€ PROMOÃ‡ÃƒO: Deploy de versÃ£o testada da produÃ§Ã£o"
          fi
          
          # Deploy com configuraÃ§Ãµes mais flexÃ­veis para HML
          echo "ğŸš€ Iniciando deploy do backend HML..."
          if gcloud run deploy $SERVICE_NAME \
            --source . \
            --region=${{ secrets.GCP_REGION }} \
            --allow-unauthenticated \
            --port=8080 \
            --memory=512Mi \
            --cpu=0.5 \
            --set-env-vars="$ENV_VARS,SECRET_KEY=${{ secrets.SECRET_KEY }},OPENROUTER_API_KEY=${{ secrets.OPENROUTER_API_KEY }}" \
            --max-instances=5 \
            --timeout=300 \
            --quiet; then
            echo "âœ… Deploy do backend HML concluÃ­do com sucesso"
          else
            echo "âŒ Falha no deploy do backend HML. Tentando novamente..."
            sleep 10
            gcloud run deploy $SERVICE_NAME \
              --source . \
              --region=${{ secrets.GCP_REGION }} \
              --allow-unauthenticated \
              --port=8080 \
              --memory=512Mi \
              --cpu=0.5 \
              --set-env-vars="$ENV_VARS,SECRET_KEY=${{ secrets.SECRET_KEY }},OPENROUTER_API_KEY=${{ secrets.OPENROUTER_API_KEY }}" \
              --max-instances=5 \
              --timeout=300
          fi
          
          SERVICE_URL=$(gcloud run services describe $SERVICE_NAME --region=${{ secrets.GCP_REGION }} --format="value(status.url)")
          echo "url=$SERVICE_URL" >> $GITHUB_OUTPUT
          echo "ğŸŒ Backend HML deployed: $SERVICE_URL"

      - name: ğŸ¨ Deploy Frontend HML
        id: frontend-deploy
        if: needs.hml-validation.outputs.frontend == 'true'
        run: |
          cd apps/frontend-nextjs
          echo "ğŸ”§ Instalando dependÃªncias do frontend para HML..."
          npm ci
          
          echo "ğŸ—ï¸ Construindo aplicaÃ§Ã£o frontend para HML..."
          npm run build
          
          # Firebase deploy para HML
          echo "ğŸ”§ Configurando Firebase CLI..."
          npm install -g firebase-tools
          
          echo "ğŸ” Autenticando no Firebase..."
          echo "${{ secrets.FIREBASE_TOKEN }}" | firebase login:ci
          
          echo "ğŸ§ª DEPLOY EM HML - FRONTEND"
          if [ "${{ needs.hml-validation.outputs.is-promotion }}" == "true" ]; then
            echo "ğŸš€ PROMOÃ‡ÃƒO: Deploy de versÃ£o testada da produÃ§Ã£o"
          fi
          
          firebase deploy --project ${{ secrets.FIREBASE_PROJECT_ID }} --only hosting:hml --non-interactive
          echo "url=https://hml-${{ secrets.FIREBASE_PROJECT_ID }}.web.app" >> $GITHUB_OUTPUT  
          echo "âœ… Frontend implantado em HML: https://hml-${{ secrets.FIREBASE_PROJECT_ID }}.web.app"

  # =====================================
  # 4. TESTES DE INTEGRAÃ‡ÃƒO HML
  # =====================================
  hml-integration-tests:
    name: ğŸ§ª Testes de IntegraÃ§Ã£o HML
    runs-on: ubuntu-latest
    needs: [hml-validation, hml-deploy]
    if: needs.hml-validation.outputs.should-deploy == 'true' && needs.hml-deploy.result == 'success'
    
    steps:
      - name: ğŸ¥ Health Checks HML
        run: |
          echo "ğŸ¥ Verificando saÃºde dos serviÃ§os HML..."
          
          if [ -n "${{ needs.hml-deploy.outputs.backend-url }}" ]; then
            echo "ğŸ” Testando saÃºde do backend HML..."
            for i in {1..3}; do
              if curl -f "${{ needs.hml-deploy.outputs.backend-url }}/health" --max-time 30; then
                echo "âœ… Backend HML estÃ¡ saudÃ¡vel (tentativa $i)"
                break
              else
                echo "âš ï¸ Backend HML nÃ£o responde (tentativa $i/3)"
                sleep 10
              fi
            done
          fi
          
          if [ -n "${{ needs.hml-deploy.outputs.frontend-url }}" ]; then
            echo "ğŸ” Testando frontend HML..."
            for i in {1..3}; do
              if curl -f "${{ needs.hml-deploy.outputs.frontend-url }}" --max-time 30; then
                echo "âœ… Frontend HML estÃ¡ acessÃ­vel (tentativa $i)"
                break
              else
                echo "âš ï¸ Frontend HML nÃ£o estÃ¡ acessÃ­vel (tentativa $i/3)"
                sleep 10
              fi
            done
          fi

      - name: ğŸ§ª Testes de Smoke HML
        run: |
          echo "ğŸ§ª Executando testes de smoke em HML..."
          
          if [ -n "${{ needs.hml-deploy.outputs.backend-url }}" ]; then
            echo "ğŸ” Testando endpoints bÃ¡sicos do backend..."
            
            # Test health endpoint
            curl -f "${{ needs.hml-deploy.outputs.backend-url }}/health" || echo "âŒ Health endpoint falhou"
            
            # Test API root (if exists)
            curl -f "${{ needs.hml-deploy.outputs.backend-url }}/api" --max-time 10 || echo "â„¹ï¸ API root endpoint nÃ£o disponÃ­vel"
          fi
          
          echo "âœ… Testes de smoke HML concluÃ­dos"

      - name: ğŸ“Š RelatÃ³rio de Deploy HML
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ“Š Gerando relatÃ³rio de deploy HML..."
          
          # Criar issue de tracking do deploy HML
          cat > hml_deploy_report.md << 'EOF'
          # ğŸ§ª Deploy HML (PrÃ©-ProduÃ§Ã£o) ConcluÃ­do
          
          ## ğŸ“‹ InformaÃ§Ãµes do Deploy
          EOF
          
          echo "- **Data**: $(date '+%d/%m/%Y %H:%M:%S')" >> hml_deploy_report.md
          echo "- **Commit**: ${{ github.sha }}" >> hml_deploy_report.md
          echo "- **Executado por**: ${{ github.actor }}" >> hml_deploy_report.md
          echo "- **Evento**: ${{ github.event_name }}" >> hml_deploy_report.md
          
          if [ "${{ needs.hml-validation.outputs.is-promotion }}" == "true" ]; then
            echo "- **Tipo**: ğŸš€ PromoÃ§Ã£o da ProduÃ§Ã£o" >> hml_deploy_report.md
          else
            echo "- **Tipo**: ğŸ§ª Deploy de desenvolvimento" >> hml_deploy_report.md
          fi
          
          echo "" >> hml_deploy_report.md
          echo "## ğŸŒ URLs de HML" >> hml_deploy_report.md
          echo "- **Backend**: ${{ needs.hml-deploy.outputs.backend-url || 'Sem mudanÃ§as' }}" >> hml_deploy_report.md
          echo "- **Frontend**: ${{ needs.hml-deploy.outputs.frontend-url || 'Sem mudanÃ§as' }}" >> hml_deploy_report.md
          echo "" >> hml_deploy_report.md
          echo "## âœ… Status dos Testes" >> hml_deploy_report.md
          echo "- Health checks: ${{ job.status == 'success' && 'âœ… Aprovado' || 'âŒ Falhou' }}" >> hml_deploy_report.md
          echo "- Testes de smoke: ${{ job.status == 'success' && 'âœ… Aprovado' || 'âŒ Falhou' }}" >> hml_deploy_report.md
          echo "- Ambiente: ğŸ§ª HML Operacional" >> hml_deploy_report.md
          echo "" >> hml_deploy_report.md
          echo "## ğŸ”„ PrÃ³ximos Passos" >> hml_deploy_report.md
          echo "- Executar testes manuais em HML" >> hml_deploy_report.md
          echo "- Validar funcionalidades principais" >> hml_deploy_report.md
          echo "- ApÃ³s validaÃ§Ã£o, considerar promote para produÃ§Ã£o" >> hml_deploy_report.md
          echo "" >> hml_deploy_report.md
          echo "## ğŸš€ Para Promover para ProduÃ§Ã£o" >> hml_deploy_report.md
          echo "1. Validar completamente em HML" >> hml_deploy_report.md
          echo "2. Fazer merge/promote de HML para main" >> hml_deploy_report.md
          echo "3. Pipeline de produÃ§Ã£o serÃ¡ executado automaticamente" >> hml_deploy_report.md
          echo "" >> hml_deploy_report.md
          echo "---" >> hml_deploy_report.md
          echo "*Deploy realizado automaticamente pelo pipeline HML*" >> hml_deploy_report.md
          
          gh issue create \
            --title "ğŸ§ª Deploy HML - $(date '+%d/%m/%Y %H:%M')" \
            --body-file hml_deploy_report.md \
            --label "deployment,hml,pre-production"
          
          echo "âœ… RelatÃ³rio de deploy HML criado"

      - name: ğŸ¯ Resumo Final HML
        run: |
          echo "ğŸ¯ RESUMO DO DEPLOY HML:"
          echo "  Backend: ${{ needs.hml-deploy.outputs.backend-url || 'Sem mudanÃ§as' }}"
          echo "  Frontend: ${{ needs.hml-deploy.outputs.frontend-url || 'Sem mudanÃ§as' }}"
          echo "  Status: âœ… Ambiente HML operacional"

      - name: ğŸ“± Alerta Telegram - Deploy HML Sucesso
        if: success()
        run: |
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
            -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
            -d parse_mode=HTML \
            -d text="ğŸ§ª <b>Deploy HML ConcluÃ­do</b>%0A%0AğŸ“… <b>Data:</b> $(date '+%d/%m/%Y %H:%M:%S')%0AğŸ”„ <b>Commit:</b> ${{ github.sha }}%0AğŸ‘¤ <b>Por:</b> ${{ github.actor }}%0A%0AğŸŒ <b>URLs:</b>%0Aâ€¢ Backend: ${{ needs.hml-deploy.outputs.backend-url || 'Sem mudanÃ§as' }}%0Aâ€¢ Frontend: ${{ needs.hml-deploy.outputs.frontend-url || 'Sem mudanÃ§as' }}%0A%0Aâœ… Sistema HML operacional"

      - name: ğŸ“± Alerta Telegram - Deploy HML Falhou  
        if: failure()
        run: |
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
            -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
            -d parse_mode=HTML \
            -d text="âŒ <b>FALHA no Deploy HML</b>%0A%0AğŸ“… <b>Data:</b> $(date '+%d/%m/%Y %H:%M:%S')%0AğŸ”„ <b>Commit:</b> ${{ github.sha }}%0AğŸ‘¤ <b>Por:</b> ${{ github.actor }}%0A%0AğŸ”— <b>Ver logs:</b> https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}%0A%0AğŸš¨ IntervenÃ§Ã£o necessÃ¡ria"
          echo ""
          echo "ğŸ§ª AMBIENTE DE PRÃ‰-PRODUÃ‡ÃƒO ATUALIZADO"
          echo "ğŸ’¡ Execute testes manuais antes de promover para produÃ§Ã£o"

# =====================================
# CONFIGURAÃ‡ÃƒO DO WORKFLOW
# =====================================
concurrency:
  group: hml-deploy-${{ github.ref }}
  cancel-in-progress: true  # Pode cancelar deploys HML duplicados