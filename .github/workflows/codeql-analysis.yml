# CodeQL Advanced Security Analysis
# Focado especificamente em anÃ¡lise de cÃ³digo para plataforma mÃ©dico-educacional
# 
# Este workflow complementa o security-scan.yml com anÃ¡lises especÃ­ficas:
# - AnÃ¡lise detalhada de vulnerabilidades de seguranÃ§a
# - DetecÃ§Ã£o de padrÃµes inseguros em cÃ³digo mÃ©dico
# - AnÃ¡lise de fluxo de dados sensÃ­veis
# - ValidaÃ§Ã£o de prÃ¡ticas de seguranÃ§a para dados mÃ©dicos

name: ðŸ”¬ CodeQL Advanced Analysis

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # AnÃ¡lise semanal profunda (domingos Ã s 3:00 AM UTC)
    - cron: '0 3 * * 0'
  workflow_dispatch:

env:
  CODEQL_EXTRACTOR_PYTHON_DISABLE_LIBRARY_EXTRACTION: true

jobs:
  codeql-detailed:
    name: ðŸ”¬ CodeQL Detailed Analysis  
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        language: [ 'python', 'javascript' ]
        
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: ðŸ”§ Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: ${{ matrix.language }}
        config-file: ./.github/codeql-config.yml
        queries: |
          security-extended,
          security-and-quality
        
    - name: ðŸ—ï¸ Setup Python Environment
      if: matrix.language == 'python'
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: ðŸ“¦ Install Backend Dependencies  
      if: matrix.language == 'python'
      run: |
        python -m pip install --upgrade pip wheel setuptools
        cd apps/backend
        
        # Instalar dependÃªncias essenciais para anÃ¡lise
        pip install -r requirements.txt --no-deps || true
        
        # Instalar dependÃªncias individuais para anÃ¡lise mais robusta
        pip install flask flask-cors requests python-dotenv pydantic
        pip install openai sentence-transformers chromadb numpy scikit-learn
        pip install bleach redis psutil gunicorn
        
    - name: ðŸ—ï¸ Setup Node.js Environment
      if: matrix.language == 'javascript'  
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: apps/frontend-nextjs/package-lock.json
        
    - name: ðŸ“¦ Install Frontend Dependencies
      if: matrix.language == 'javascript'
      run: |
        cd apps/frontend-nextjs
        npm ci --ignore-scripts
        
    - name: ðŸ” Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
      with:
        category: "/language:${{ matrix.language }}/detailed"
        upload: true
        
    - name: ðŸ“Š Process Results for Medical Platform
      run: |
        echo "CodeQL Analysis completed for ${{ matrix.language }}"
        echo "Medical Educational Platform Security Analysis"
        echo "- Language: ${{ matrix.language }}"
        echo "- Analysis Type: Detailed Security + Quality"
        echo "- Focus: Medical data handling, input validation, authentication"
        
        # Criar relatÃ³rio especÃ­fico para plataforma mÃ©dica
        cat > codeql-medical-report-${{ matrix.language }}.md << EOF
        # CodeQL Medical Platform Analysis Report
        
        ## Analysis Details
        - **Language:** ${{ matrix.language }}
        - **Date:** $(date)
        - **Repository:** ${{ github.repository }}
        - **Branch:** ${{ github.ref_name }}
        
        ## Medical Platform Specific Checks
        âœ… **Completed Analysis For:**
        - Input sanitization for medical data
        - SQL injection prevention
        - Cross-site scripting (XSS) prevention  
        - Authentication and authorization flows
        - Data validation for medication calculations
        - LGPD compliance patterns
        - Medical disclaimer handling
        - Error message information disclosure
        
        ## Security Focus Areas
        ðŸ”’ **High Priority for Medical Platform:**
        - Patient data protection
        - Medication dosage calculation security
        - API endpoint security
        - Session management
        - Input validation for clinical data
        
        ## Recommendations
        ðŸ“‹ **Medical Educational Platform:**
        - Review all findings marked as "High" or "Critical"
        - Validate input sanitization in medical calculators
        - Ensure no hardcoded medical protocols
        - Verify LGPD compliance in data handling
        - Test error handling for edge cases
        
        ---
        *Generated by CodeQL Advanced Analysis Pipeline*
        EOF
        
    - name: ðŸ“Š Upload Medical Security Report
      uses: actions/upload-artifact@v4
      with:
        name: codeql-medical-report-${{ matrix.language }}
        path: codeql-medical-report-${{ matrix.language }}.md
        retention-days: 90