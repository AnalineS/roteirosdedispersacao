name: ðŸ”’ Security Monitoring & Continuous Scanning

on:
  schedule:
    # Runs every Monday at 9:00 AM UTC (6:00 AM BrasÃ­lia)
    - cron: '0 9 * * 1'
    # Daily security scans at 2:00 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to scan (hml/production/both)'
        required: false
        default: 'both'
        type: choice
        options:
          - both
          - hml
          - production
      severity_threshold:
        description: 'Minimum severity to report'
        required: false
        default: 'medium'
        type: choice
        options:
          - low
          - medium
          - high
          - critical
      check_patches:
        description: 'Check for new patches'
        required: false
        default: 'true'
      notify:
        description: 'Send notifications'
        required: false
        default: 'true'

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'

jobs:
  # =====================================
  # Check for Security Updates
  # =====================================
  check-patches:
    name: [SEARCH] Check for Security Patches
    runs-on: ubuntu-latest
    outputs:
      has_updates: ${{ steps.check.outputs.has_updates }}
      torch_patch_available: ${{ steps.torch.outputs.patch_available }}
      
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: [SEARCH] Check PyTorch Updates
        id: torch
        continue-on-error: true
        run: |
          # Check if PyTorch has released patches for known vulnerabilities
          pip install --upgrade pip
          
          # Get latest torch version using pip search alternative
          LATEST_TORCH=$(python -c "import requests; r=requests.get('https://pypi.org/pypi/torch/json'); print(r.json()['info']['version'])" 2>/dev/null || echo "2.8.0")
          CURRENT_TORCH="2.8.0"
          
          echo "Latest PyTorch version: $LATEST_TORCH"
          echo "Current version in use: $CURRENT_TORCH"
          
          if [ "$LATEST_TORCH" != "$CURRENT_TORCH" ]; then
            echo "patch_available=true" >> $GITHUB_OUTPUT
            echo "latest_version=$LATEST_TORCH" >> $GITHUB_OUTPUT
            echo "[WARNING] New PyTorch version available: $LATEST_TORCH"
          else
            echo "patch_available=false" >> $GITHUB_OUTPUT
            echo "[OK] PyTorch is up to date"
          fi

      - name: [SECURITY] Run Snyk Test
        id: snyk
        continue-on-error: true
        run: |
          # Install Snyk
          npm install -g snyk
          
          # Test backend
          cd apps/backend
          snyk test --severity-threshold=medium --json > ../../snyk-backend-report.json || true
          
          # Test frontend
          cd ../frontend-nextjs
          snyk test --severity-threshold=medium --json > ../../snyk-frontend-report.json || true
          
          cd ../..
          
          # Check for new vulnerabilities
          NEW_VULNS=0
          NEW_VULNS_FRONT=0
          
          if [ -f snyk-backend-report.json ]; then
            NEW_VULNS=$(jq '.vulnerabilities | length' snyk-backend-report.json || echo "0")
            echo "Found $NEW_VULNS vulnerabilities in backend"
            echo "NEW_VULNS=$NEW_VULNS" >> $GITHUB_ENV
          fi
          
          if [ -f snyk-frontend-report.json ]; then
            NEW_VULNS_FRONT=$(jq '.vulnerabilities | length' snyk-frontend-report.json || echo "0")
            echo "Found $NEW_VULNS_FRONT vulnerabilities in frontend"
            echo "NEW_VULNS_FRONT=$NEW_VULNS_FRONT" >> $GITHUB_ENV
          fi
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      - name: [REPORT] Generate Security Report
        id: report
        run: |
          echo "# ðŸ”’ Weekly Security Check Report" > security-report.md
          echo "" >> security-report.md
          echo "**Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> security-report.md
          echo "**Branch**: ${{ github.ref_name }}" >> security-report.md
          echo "" >> security-report.md
          echo "## PyTorch Status" >> security-report.md
          
          if [ "${{ steps.torch.outputs.patch_available }}" == "true" ]; then
            echo "[WARNING] **UPDATE AVAILABLE**: PyTorch ${{ steps.torch.outputs.latest_version }}" >> security-report.md
            echo "Action Required: Review and test PyTorch update" >> security-report.md
          else
            echo "[OK] No PyTorch updates available" >> security-report.md
          fi
          
          echo "" >> security-report.md
          echo "## Vulnerability Summary" >> security-report.md
          
          # Parse Snyk results
          if [ -f snyk-backend-report.json ]; then
            echo "### Backend" >> security-report.md
            jq -r '.vulnerabilities[] | "- \(.severity): \(.title) in \(.packageName)@\(.version)"' snyk-backend-report.json >> security-report.md || echo "No new vulnerabilities" >> security-report.md
          fi
          
          if [ -f snyk-frontend-report.json ]; then
            echo "### Frontend" >> security-report.md
            jq -r '.vulnerabilities[] | "- \(.severity): \(.title) in \(.packageName)@\(.version)"' snyk-frontend-report.json >> security-report.md || echo "No new vulnerabilities" >> security-report.md
          fi
          
          # Check if updates are needed
          if [ "${{ steps.torch.outputs.patch_available }}" == "true" ] || [ "${NEW_VULNS:-0}" -gt "7" ] || [ "${NEW_VULNS_FRONT:-0}" -gt "0" ]; then
            echo "has_updates=true" >> $GITHUB_OUTPUT
          else
            echo "has_updates=false" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ“¤ Upload Security Reports
        uses: actions/upload-artifact@v3
        with:
          name: security-reports
          path: |
            security-report.md
            snyk-backend-report.json
            snyk-frontend-report.json

  # =====================================
  # Update Documentation
  # =====================================
  update-docs:
    name: [NOTE] Update Security Documentation
    runs-on: ubuntu-latest
    needs: check-patches
    if: needs.check-patches.outputs.has_updates == 'true'
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“… Update SECURITY_VULNERABILITIES.md
        run: |
          # Update last check date
          sed -i "s/\*\*Ãšltima AtualizaÃ§Ã£o\*\*: .*/\*\*Ãšltima AtualizaÃ§Ã£o\*\*: $(date +%Y-%m-%d)/" SECURITY_VULNERABILITIES.md
          
          # Add torch update note if available
          if [ "${{ needs.check-patches.outputs.torch_patch_available }}" == "true" ]; then
            echo "" >> SECURITY_VULNERABILITIES.md
            echo "## [ALERT] ALERTA: AtualizaÃ§Ã£o DisponÃ­vel" >> SECURITY_VULNERABILITIES.md
            echo "" >> SECURITY_VULNERABILITIES.md
            echo "- PyTorch tem nova versÃ£o disponÃ­vel com possÃ­veis correÃ§Ãµes de seguranÃ§a" >> SECURITY_VULNERABILITIES.md
            echo "- Verificar changelog e testar atualizaÃ§Ã£o" >> SECURITY_VULNERABILITIES.md
            echo "- Data do alerta: $(date +%Y-%m-%d)" >> SECURITY_VULNERABILITIES.md
          fi

      - name: ðŸ”„ Create Pull Request
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: atualizaÃ§Ã£o semanal de seguranÃ§a"
          title: "ðŸ”’ [Security] AtualizaÃ§Ã£o Semanal de Vulnerabilidades"
          body: |
            ## ðŸ”’ VerificaÃ§Ã£o Semanal de SeguranÃ§a
            
            Este PR foi criado automaticamente pelo workflow de seguranÃ§a.
            
            ### MudanÃ§as:
            - AtualizaÃ§Ã£o da data de Ãºltima verificaÃ§Ã£o
            - Novos patches disponÃ­veis identificados
            - RelatÃ³rio de vulnerabilidades atualizado
            
            ### AÃ§Ãµes Requeridas:
            1. Revisar mudanÃ§as no SECURITY_VULNERABILITIES.md
            2. Testar atualizaÃ§Ãµes disponÃ­veis
            3. Aprovar e fazer merge se apropriado
            
            ---
            *Gerado automaticamente em $(date -u)*
          branch: security-updates-${{ github.run_number }}
          labels: security, automated, dependencies

  # =====================================
  # Send Notifications
  # =====================================
  notify:
    name: ðŸ“¢ Send Notifications
    runs-on: ubuntu-latest
    needs: [check-patches, update-docs]
    if: needs.check-patches.outputs.has_updates == 'true' || github.event.inputs.notify == 'true'
    
    steps:
      - name: ðŸ“¥ Download Reports
        uses: actions/download-artifact@v3
        with:
          name: security-reports

      - name: ðŸ“§ Send Email Notification
        if: needs.check-patches.outputs.has_updates == 'true'
        run: |
          echo "ðŸ“§ Email notification would be sent here"
          echo "Subject: [SECURITY] AtualizaÃ§Ãµes de SeguranÃ§a DisponÃ­veis"
          echo "To: security@roteirosdedispensacao.com"
          
          # In production, integrate with email service like SendGrid
          # curl -X POST https://api.sendgrid.com/v3/mail/send ...

      - name: ðŸ“± Send Telegram Notification
        if: needs.check-patches.outputs.has_updates == 'true'
        run: |
          if [ "${{ needs.check-patches.outputs.torch_patch_available }}" == "true" ]; then
            MESSAGE="ðŸ”’ Alerta de SeguranÃ§a
          
          [WARNING] PyTorch Update DisponÃ­vel
          Nova versÃ£o pode conter correÃ§Ãµes de seguranÃ§a.
          
          ðŸ“… Data: $(date +%Y-%m-%d)
          ðŸ”— PR Criado: Verificar GitHub
          
          AÃ§Ã£o Requerida: Revisar e testar atualizaÃ§Ã£o"
          else
            MESSAGE="ðŸ”’ VerificaÃ§Ã£o Semanal de SeguranÃ§a
          
          [OK] VerificaÃ§Ã£o completa
          [REPORT] Novos problemas detectados
          
          ðŸ“… Data: $(date +%Y-%m-%d)
          ðŸ”— Detalhes: Verificar GitHub
          
          AÃ§Ã£o: Revisar relatÃ³rio de seguranÃ§a"
          fi
          
          # Send to Telegram (if token is configured)
          if [ -n "${{ secrets.TELEGRAM_BOT_TOKEN }}" ]; then
            curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
              -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
              -d text="$MESSAGE" \
              -d parse_mode="Markdown"
          else
            echo "Telegram notification skipped (no token configured)"
          fi

      - name: ðŸ’¬ Comment on Open PRs
        run: |
          # Add comment to any open security-related PRs
          echo "Would add comments to open security PRs about new findings"

  # =====================================
  # Summary
  # =====================================
  summary:
    name: [REPORT] Generate Summary
    runs-on: ubuntu-latest
    needs: [check-patches, update-docs, notify]
    if: always()
    
    steps:
      - name: [NOTE] Create Summary
        run: |
          echo "# ðŸ”’ Security Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run Date**: $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "**Run Number**: ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.check-patches.outputs.has_updates }}" == "true" ]; then
            echo "## [WARNING] Updates Available" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Security updates have been detected. Please review:" >> $GITHUB_STEP_SUMMARY
            echo "- Check the created Pull Request" >> $GITHUB_STEP_SUMMARY
            echo "- Review security reports in artifacts" >> $GITHUB_STEP_SUMMARY
            echo "- Test and deploy updates as appropriate" >> $GITHUB_STEP_SUMMARY
          else
            echo "## [OK] No Updates Required" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All known vulnerabilities are already addressed or accepted." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Review SECURITY_VULNERABILITIES.md" >> $GITHUB_STEP_SUMMARY
          echo "2. Check Snyk dashboard for details" >> $GITHUB_STEP_SUMMARY
          echo "3. Schedule patch testing if needed" >> $GITHUB_STEP_SUMMARY

# =====================================
# Workflow Configuration
# =====================================
concurrency:
  group: security-check-${{ github.ref }}
  cancel-in-progress: false