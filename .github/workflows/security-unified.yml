name: ğŸ”’ AnÃ¡lise de SeguranÃ§a Unificada (CodeQL + Snyk Inteligente)

on:
  push:
    branches: [ main, hml ]
  pull_request:
    branches: [ main, hml ]
  schedule:
    # CodeQL diÃ¡rio Ã s 02:30 UTC (23:30 BrasÃ­lia)
    - cron: '30 2 * * *'
    # Snyk mensal - 1Âª segunda-feira do mÃªs Ã s 09:00 UTC (06:00 BrasÃ­lia)
    - cron: '0 9 * * 1'
  workflow_dispatch:
    inputs:
      force_snyk:
        description: 'ForÃ§ar execuÃ§Ã£o do Snyk (use com moderaÃ§Ã£o - limite 200/mÃªs)'
        required: false
        default: false
        type: boolean
      security_level:
        description: 'NÃ­vel de anÃ¡lise de seguranÃ§a'
        required: false
        default: 'standard'
        type: choice
        options:
          - standard
          - comprehensive
          - emergency

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'

jobs:
  # =====================================
  # 1. DETERMINAR ESTRATÃ‰GIA DE SEGURANÃ‡A
  # =====================================
  security-strategy:
    name: ğŸ¯ Determinar EstratÃ©gia de SeguranÃ§a
    runs-on: ubuntu-latest
    outputs:
      run-codeql: ${{ steps.strategy.outputs.run_codeql }}
      run-snyk: ${{ steps.strategy.outputs.run_snyk }}
      strategy-reason: ${{ steps.strategy.outputs.reason }}
      is-security-critical: ${{ steps.strategy.outputs.is_security_critical }}
    
    steps:
      - name: ğŸ” Analisar Contexto e Decidir EstratÃ©gia
        id: strategy
        run: |
          echo "ğŸ¯ Determinando estratÃ©gia de seguranÃ§a otimizada..."
          
          RUN_CODEQL="true"  # CodeQL sempre executa (ilimitado)
          RUN_SNYK="false"   # Snyk apenas quando necessÃ¡rio (limitado)
          IS_SECURITY_CRITICAL="false"
          REASON=""
          
          # Verificar contexto de execuÃ§Ã£o
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            if [ "${{ github.event.inputs.force_snyk }}" == "true" ]; then
              RUN_SNYK="true"
              REASON="ğŸš¨ ExecuÃ§Ã£o manual do Snyk solicitada pelo usuÃ¡rio"
            elif [ "${{ github.event.inputs.security_level }}" == "emergency" ]; then
              RUN_SNYK="true"
              IS_SECURITY_CRITICAL="true"
              REASON="ğŸ”¥ EMERGÃŠNCIA: AnÃ¡lise de seguranÃ§a crÃ­tica solicitada"
            elif [ "${{ github.event.inputs.security_level }}" == "comprehensive" ]; then
              RUN_SNYK="true"
              REASON="ğŸ” AnÃ¡lise abrangente solicitada (Snyk + CodeQL)"
            else
              REASON="ğŸ“Š ExecuÃ§Ã£o manual padrÃ£o - apenas CodeQL"
            fi
          elif [ "${{ github.event_name }}" == "schedule" ]; then
            # Verificar se Ã© a execuÃ§Ã£o mensal do Snyk
            CURRENT_DAY=$(date +%u)  # 1=segunda, 7=domingo
            CURRENT_DATE=$(date +%d)
            
            if [ "$CURRENT_DAY" == "1" ] && [ "$CURRENT_DATE" -le "7" ]; then
              RUN_SNYK="true"
              REASON="ğŸ“… VerificaÃ§Ã£o mensal programada do Snyk (1Âª segunda do mÃªs)"
            else
              REASON="ğŸ“Š VerificaÃ§Ã£o diÃ¡ria programada do CodeQL"
            fi
          else
            # Push/PR - verificar se Ã© relacionado a dependÃªncias de seguranÃ§a
            if [ "${{ github.event_name }}" == "push" ] || [ "${{ github.event_name }}" == "pull_request" ]; then
              # Verificar se hÃ¡ mudanÃ§as em arquivos de dependÃªncias crÃ­ticas
              TITLE_LOWER=$(echo "${{ github.event.head_commit.message || github.event.pull_request.title || '' }}" | tr '[:upper:]' '[:lower:]')
              
              if [[ "$TITLE_LOWER" == *"security"* ]] || [[ "$TITLE_LOWER" == *"vulnerability"* ]] || [[ "$TITLE_LOWER" == *"cve-"* ]]; then
                RUN_SNYK="true"
                IS_SECURITY_CRITICAL="true"
                REASON="ğŸ”’ AtualizaÃ§Ã£o de SEGURANÃ‡A detectada - executando Snyk para validaÃ§Ã£o"
              elif [[ "$TITLE_LOWER" == *"dependabot"* ]] && [[ "$TITLE_LOWER" == *"security"* ]]; then
                RUN_SNYK="true"
                REASON="ğŸ¤– Dependabot com correÃ§Ã£o de seguranÃ§a - validaÃ§Ã£o Snyk necessÃ¡ria"
              else
                REASON="ğŸ“ Push/PR padrÃ£o - apenas CodeQL (economia de quota Snyk)"
              fi
            fi
          fi
          
          echo "ğŸ¯ ESTRATÃ‰GIA DETERMINADA:"
          echo "  CodeQL: $RUN_CODEQL (sempre ativo)"
          echo "  Snyk: $RUN_SNYK (uso inteligente)"
          echo "  CrÃ­tico: $IS_SECURITY_CRITICAL"
          echo "  RazÃ£o: $REASON"
          
          echo "run_codeql=$RUN_CODEQL" >> $GITHUB_OUTPUT
          echo "run_snyk=$RUN_SNYK" >> $GITHUB_OUTPUT
          echo "is_security_critical=$IS_SECURITY_CRITICAL" >> $GITHUB_OUTPUT
          echo "reason=$REASON" >> $GITHUB_OUTPUT

  # =====================================
  # 2. ANÃLISE CODEQL (SEMPRE EXECUTA)
  # =====================================
  codeql-analysis:
    name: ğŸ” AnÃ¡lise CodeQL (Ilimitada)
    runs-on: ubuntu-latest
    needs: security-strategy
    if: needs.security-strategy.outputs.run-codeql == 'true'
    timeout-minutes: 60
    permissions:
      actions: read
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        language: [ 'javascript', 'python' ]

    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ” Inicializar CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: ${{ matrix.language }}
        queries: security-extended,security-and-quality
        config: |
          name: "ConfiguraÃ§Ã£o CodeQL Otimizada"
          queries:
            - uses: security-extended
            - uses: security-and-quality
          paths-ignore:
            - "**/*.test.js"
            - "**/*.spec.js"
            - "**/__tests__/**"
            - "**/tests/**"
            - "**/node_modules/**"
            - "**/dist/**"
            - "**/build/**"
      continue-on-error: ${{ github.actor == 'dependabot[bot]' }}
      timeout-minutes: 10

    - name: ğŸ Setup Python
      if: matrix.language == 'python'
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: ğŸ“¦ Instalar DependÃªncias Python
      if: matrix.language == 'python'
      timeout-minutes: 10
      run: |
        echo "ğŸ Instalando dependÃªncias Python para anÃ¡lise CodeQL..."
        cd apps/backend
        pip install --upgrade pip
        pip install -r requirements.txt --timeout=300
        echo "âœ… DependÃªncias Python instaladas"

    - name: ğŸ“¦ Setup Node.js
      if: matrix.language == 'javascript'
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: apps/frontend-nextjs/package-lock.json

    - name: ğŸ“¦ Instalar DependÃªncias Node.js
      if: matrix.language == 'javascript'
      timeout-minutes: 10
      run: |
        echo "ğŸ“¦ Instalando dependÃªncias Node.js para anÃ¡lise CodeQL..."
        cd apps/frontend-nextjs
        npm ci --cache .npm --prefer-offline
        echo "âœ… DependÃªncias Node.js instaladas"

    - name: ğŸ” Executar AnÃ¡lise CodeQL
      uses: github/codeql-action/analyze@v3
      with:
        category: "/language:${{matrix.language}}"
        upload: true
        wait-for-processing: true
      continue-on-error: ${{ github.actor == 'dependabot[bot]' }}
      timeout-minutes: 30

    - name: ğŸ“Š Resumo da AnÃ¡lise CodeQL
      if: always()
      run: |
        echo "ğŸ” AnÃ¡lise CodeQL para ${{ matrix.language }} concluÃ­da"
        echo "ğŸ“Š Status: ${{ steps.codeql-analysis.outcome || 'desconhecido' }}"
        echo "ğŸ’¡ CodeQL executa ilimitadamente - sem impacto na quota Snyk"
        if [ "${{ github.actor }}" == "dependabot[bot]" ]; then
          echo "ğŸ¤– AnÃ¡lise para PR do Dependabot - erros nÃ£o bloqueantes"
        fi

  # =====================================
  # 3. ANÃLISE SNYK (EXECUÃ‡ÃƒO INTELIGENTE)
  # =====================================
  snyk-analysis:
    name: ğŸ”’ AnÃ¡lise Snyk (Quota Limitada - 200/mÃªs)
    runs-on: ubuntu-latest
    needs: security-strategy
    if: needs.security-strategy.outputs.run-snyk == 'true'
    continue-on-error: true
    
    outputs:
      backend-vulns: ${{ steps.snyk-scan.outputs.backend_vulns }}
      frontend-vulns: ${{ steps.snyk-scan.outputs.frontend_vulns }}
      total-vulns: ${{ steps.snyk-scan.outputs.total_vulns }}
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: âš ï¸ Aviso de Quota Snyk
        run: |
          echo "âš ï¸ ATENÃ‡ÃƒO: EXECUTANDO SNYK (QUOTA LIMITADA)"
          echo "ğŸ“Š RazÃ£o: ${{ needs.security-strategy.outputs.strategy-reason }}"
          echo "ğŸ¯ Uso inteligente: Esta execuÃ§Ã£o Ã© necessÃ¡ria e otimizada"
          echo "ğŸ“ˆ Quota mensal: 200 execuÃ§Ãµes para org sousa.analine"
          echo "ğŸ’¡ EstratÃ©gia: ~5-8 execuÃ§Ãµes/mÃªs para economia"
          
          if [ "${{ needs.security-strategy.outputs.is-security-critical }}" == "true" ]; then
            echo "ğŸš¨ CRÃTICO: ExecuÃ§Ã£o de emergÃªncia de seguranÃ§a"
          fi

      - name: ğŸ”’ Executar Snyk (Uso Controlado)
        id: snyk-scan
        run: |
          echo "ğŸ”’ Iniciando verificaÃ§Ã£o Snyk com uso otimizado..."
          
          # Instalar Snyk
          npm install -g snyk@latest
          
          # Autenticar
          if [ -n "${{ secrets.SNYK_TOKEN }}" ]; then
            echo "ğŸ” Autenticando no Snyk..."
            snyk auth ${{ secrets.SNYK_TOKEN }}
          else
            echo "âš ï¸ Token Snyk nÃ£o configurado - usando modo pÃºblico (limitado)"
          fi
          
          BACKEND_VULNS=0
          FRONTEND_VULNS=0
          
          echo "ğŸ [SNYK] Verificando backend Python..."
          cd apps/backend
          if snyk test --severity-threshold=medium --json > ../../snyk-backend-report.json 2>/dev/null; then
            echo "âœ… Backend: Nenhuma vulnerabilidade crÃ­tica"
          else
            echo "âš ï¸ Backend: Vulnerabilidades encontradas"
            snyk test --severity-threshold=medium > ../../snyk-backend-human.txt || true
          fi
          
          echo "ğŸ“¦ [SNYK] Verificando frontend Node.js..."
          cd ../frontend-nextjs
          if snyk test --severity-threshold=medium --json > ../../snyk-frontend-report.json 2>/dev/null; then
            echo "âœ… Frontend: Nenhuma vulnerabilidade crÃ­tica"
          else
            echo "âš ï¸ Frontend: Vulnerabilidades encontradas"  
            snyk test --severity-threshold=medium > ../../snyk-frontend-human.txt || true
          fi
          
          cd ../..
          
          # Contar vulnerabilidades
          if [ -f snyk-backend-report.json ]; then
            if command -v jq >/dev/null 2>&1; then
              BACKEND_VULNS=$(jq '.vulnerabilities | length' snyk-backend-report.json 2>/dev/null || echo "0")
            else
              BACKEND_VULNS=$(grep -o '"id":' snyk-backend-report.json | wc -l || echo "0")
            fi
          fi
          
          if [ -f snyk-frontend-report.json ]; then
            if command -v jq >/dev/null 2>&1; then
              FRONTEND_VULNS=$(jq '.vulnerabilities | length' snyk-frontend-report.json 2>/dev/null || echo "0")
            else
              FRONTEND_VULNS=$(grep -o '"id":' snyk-frontend-report.json | wc -l || echo "0")
            fi
          fi
          
          TOTAL_VULNS=$((BACKEND_VULNS + FRONTEND_VULNS))
          
          echo "ğŸ“Š RESULTADO SNYK:"
          echo "  Backend: $BACKEND_VULNS vulnerabilidades"
          echo "  Frontend: $FRONTEND_VULNS vulnerabilidades"
          echo "  Total: $TOTAL_VULNS vulnerabilidades"
          
          echo "backend_vulns=$BACKEND_VULNS" >> $GITHUB_OUTPUT
          echo "frontend_vulns=$FRONTEND_VULNS" >> $GITHUB_OUTPUT
          echo "total_vulns=$TOTAL_VULNS" >> $GITHUB_OUTPUT
          
          echo "âœ… VerificaÃ§Ã£o Snyk concluÃ­da (quota preservada)"
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

  # =====================================
  # 4. VERIFICAÃ‡ÃƒO PYTORCH MENSAL
  # =====================================
  pytorch-check:
    name: ğŸ VerificaÃ§Ã£o PyTorch (Mensal)
    runs-on: ubuntu-latest
    needs: security-strategy
    if: needs.security-strategy.outputs.run-snyk == 'true'
    
    outputs:
      patch-available: ${{ steps.check.outputs.patch_available }}
      latest-version: ${{ steps.check.outputs.latest_version }}
    
    steps:
      - name: ğŸ Verificar AtualizaÃ§Ãµes PyTorch
        id: check
        run: |
          echo "ğŸ Verificando atualizaÃ§Ãµes do PyTorch..."
          
          pip install --upgrade pip requests
          
          # Verificar versÃ£o mais recente
          LATEST_TORCH=$(python -c "
          import requests
          try:
              r = requests.get('https://pypi.org/pypi/torch/json', timeout=10)
              print(r.json()['info']['version'])
          except:
              print('2.8.0')
          " 2>/dev/null || echo "2.8.0")
          
          CURRENT_TORCH="2.8.0"
          
          echo "ğŸ“Š PyTorch Status:"
          echo "  VersÃ£o atual: $CURRENT_TORCH"
          echo "  VersÃ£o mais recente: $LATEST_TORCH"
          
          if [ "$LATEST_TORCH" != "$CURRENT_TORCH" ]; then
            echo "âš ï¸ ATUALIZAÃ‡ÃƒO DISPONÃVEL: PyTorch $LATEST_TORCH"
            echo "patch_available=true" >> $GITHUB_OUTPUT
            echo "latest_version=$LATEST_TORCH" >> $GITHUB_OUTPUT
          else
            echo "âœ… PyTorch estÃ¡ atualizado"
            echo "patch_available=false" >> $GITHUB_OUTPUT
            echo "latest_version=$CURRENT_TORCH" >> $GITHUB_OUTPUT
          fi

  # =====================================
  # 5. RELATÃ“RIO CONSOLIDADO
  # =====================================
  generate-security-report:
    name: ğŸ“‹ Gerar RelatÃ³rio de SeguranÃ§a Consolidado
    runs-on: ubuntu-latest
    needs: [security-strategy, codeql-analysis, snyk-analysis, pytorch-check]
    if: always()
    
    steps:
      - name: ğŸ“‹ Gerar RelatÃ³rio Completo em PortuguÃªs
        run: |
          echo "ğŸ“‹ Gerando relatÃ³rio consolidado de seguranÃ§a..."
          
          cat > security-consolidated-report.md << 'EOF'
          # ğŸ”’ RelatÃ³rio Consolidado de SeguranÃ§a
          
          ## ğŸ“Š InformaÃ§Ãµes da ExecuÃ§Ã£o
          EOF
          
          echo "- **Data**: $(date '+%d/%m/%Y %H:%M:%S UTC')" >> security-consolidated-report.md
          echo "- **EstratÃ©gia**: ${{ needs.security-strategy.outputs.strategy-reason }}" >> security-consolidated-report.md
          echo "- **CrÃ­tico**: ${{ needs.security-strategy.outputs.is-security-critical == 'true' && 'SIM - EmergÃªncia de SeguranÃ§a' || 'NÃ£o - VerificaÃ§Ã£o Regular' }}" >> security-consolidated-report.md
          echo "" >> security-consolidated-report.md
          
          echo "## ğŸ¯ ExecuÃ§Ãµes Realizadas" >> security-consolidated-report.md
          echo "" >> security-consolidated-report.md
          echo "### âœ… CodeQL (Ilimitado)" >> security-consolidated-report.md
          echo "- **Status**: ${{ needs.codeql-analysis.result == 'success' && 'âœ… ConcluÃ­do com sucesso' || 'âš ï¸ Falhou ou foi pulado' }}" >> security-consolidated-report.md
          echo "- **Linguagens**: JavaScript, Python" >> security-consolidated-report.md
          echo "- **Cobertura**: AnÃ¡lise completa de cÃ³digo-fonte" >> security-consolidated-report.md
          echo "- **Impacto na Quota**: Nenhum (ilimitado)" >> security-consolidated-report.md
          echo "" >> security-consolidated-report.md
          
          if [ "${{ needs.security-strategy.outputs.run-snyk }}" == "true" ]; then
            echo "### ğŸ”’ Snyk (Quota Limitada - 200/mÃªs)" >> security-consolidated-report.md
            echo "- **Status**: ${{ needs.snyk-analysis.result == 'success' && 'âœ… ConcluÃ­do' || 'âš ï¸ Falhou/Pulado' }}" >> security-consolidated-report.md
            echo "- **Vulnerabilidades Backend**: ${{ needs.snyk-analysis.outputs.backend-vulns || 'N/A' }}" >> security-consolidated-report.md
            echo "- **Vulnerabilidades Frontend**: ${{ needs.snyk-analysis.outputs.frontend-vulns || 'N/A' }}" >> security-consolidated-report.md
            echo "- **Total de Vulnerabilidades**: ${{ needs.snyk-analysis.outputs.total-vulns || 'N/A' }}" >> security-consolidated-report.md
            echo "- **Impacto na Quota**: âš ï¸ 1 execuÃ§Ã£o utilizada" >> security-consolidated-report.md
          else
            echo "### â­ï¸ Snyk (Economia de Quota)" >> security-consolidated-report.md
            echo "- **Status**: â­ï¸ Pulado para economizar quota" >> security-consolidated-report.md
            echo "- **RazÃ£o**: ExecuÃ§Ã£o nÃ£o necessÃ¡ria neste contexto" >> security-consolidated-report.md
            echo "- **PrÃ³xima ExecuÃ§Ã£o**: Mensal ou emergÃªncia de seguranÃ§a" >> security-consolidated-report.md
            echo "- **Impacto na Quota**: âœ… 0 execuÃ§Ãµes utilizadas" >> security-consolidated-report.md
          fi
          
          echo "" >> security-consolidated-report.md
          
          if [ "${{ needs.security-strategy.outputs.run-snyk }}" == "true" ]; then
            echo "### ğŸ PyTorch" >> security-consolidated-report.md
            if [ "${{ needs.pytorch-check.outputs.patch-available }}" == "true" ]; then
              echo "- **Status**: âš ï¸ AtualizaÃ§Ã£o disponÃ­vel" >> security-consolidated-report.md
              echo "- **VersÃ£o Atual**: 2.8.0" >> security-consolidated-report.md
              echo "- **VersÃ£o Mais Recente**: ${{ needs.pytorch-check.outputs.latest-version }}" >> security-consolidated-report.md
              echo "- **AÃ§Ã£o**: Revisar changelog e considerar atualizaÃ§Ã£o" >> security-consolidated-report.md
            else
              echo "- **Status**: âœ… Atualizado" >> security-consolidated-report.md
              echo "- **VersÃ£o**: 2.8.0 (mais recente)" >> security-consolidated-report.md
            fi
          fi
          
          echo "" >> security-consolidated-report.md
          echo "## ğŸ“ˆ Uso Inteligente de Quota Snyk" >> security-consolidated-report.md
          echo "" >> security-consolidated-report.md
          echo "**EstratÃ©gia de Economia:**" >> security-consolidated-report.md
          echo "- ğŸ¯ **Meta**: 5-8 execuÃ§Ãµes Snyk por mÃªs (limite: 200)" >> security-consolidated-report.md
          echo "- âš¡ **CodeQL**: ExecuÃ§Ã£o ilimitada diÃ¡ria para cobertura contÃ­nua" >> security-consolidated-report.md
          echo "- ğŸ”’ **Snyk**: Apenas para verificaÃ§Ãµes crÃ­ticas e mensais" >> security-consolidated-report.md
          echo "" >> security-consolidated-report.md
          echo "**Quando Snyk Executa:**" >> security-consolidated-report.md
          echo "- ğŸ“… 1Âª segunda-feira do mÃªs (verificaÃ§Ã£o programada)" >> security-consolidated-report.md
          echo "- ğŸš¨ Updates de seguranÃ§a detectados" >> security-consolidated-report.md
          echo "- ğŸ”§ ExecuÃ§Ã£o manual para investigaÃ§Ãµes especÃ­ficas" >> security-consolidated-report.md
          echo "- âš¡ EmergÃªncias de seguranÃ§a" >> security-consolidated-report.md
          
          echo "" >> security-consolidated-report.md
          echo "## ğŸ¯ RecomendaÃ§Ãµes" >> security-consolidated-report.md
          echo "" >> security-consolidated-report.md
          
          if [ "${{ needs.snyk-analysis.outputs.total-vulns || '0' }}" -gt "0" ]; then
            echo "### ğŸš¨ AÃ§Ã£o Imediata NecessÃ¡ria" >> security-consolidated-report.md
            echo "- **${{ needs.snyk-analysis.outputs.total-vulns }}** vulnerabilidade(s) detectada(s) pelo Snyk" >> security-consolidated-report.md
            echo "- Revisar relatÃ³rios detalhados nos artifacts" >> security-consolidated-report.md
            echo "- Priorizar correÃ§Ãµes de vulnerabilidades HIGH e CRITICAL" >> security-consolidated-report.md
          else
            echo "### âœ… Status Seguro" >> security-consolidated-report.md
            echo "- Nenhuma vulnerabilidade crÃ­tica detectada" >> security-consolidated-report.md
            echo "- Continue monitoramento com CodeQL diÃ¡rio" >> security-consolidated-report.md
            echo "- PrÃ³xima verificaÃ§Ã£o Snyk: Mensal programada" >> security-consolidated-report.md
          fi
          
          echo "" >> security-consolidated-report.md
          echo "## ğŸ”— Links Ãšteis" >> security-consolidated-report.md
          echo "- [CodeQL Results](https://github.com/${{ github.repository }}/security/code-scanning)" >> security-consolidated-report.md
          echo "- [Snyk Dashboard](https://app.snyk.io/org/sousa.analine)" >> security-consolidated-report.md
          echo "- [Workflow Execution](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> security-consolidated-report.md
          
          echo "" >> security-consolidated-report.md
          echo "---" >> security-consolidated-report.md
          echo "*RelatÃ³rio gerado automaticamente pelo Sistema de SeguranÃ§a Unificada*" >> security-consolidated-report.md
          echo "*EstratÃ©gia otimizada para economia de quota Snyk (200 execuÃ§Ãµes/mÃªs)*" >> security-consolidated-report.md
          
          echo "âœ… RelatÃ³rio consolidado gerado com estratÃ©gia de economia Snyk"

      - name: ğŸ“¤ Upload RelatÃ³rios de SeguranÃ§a
        uses: actions/upload-artifact@v4
        with:
          name: security-unified-reports
          path: |
            security-consolidated-report.md
            snyk-backend-report.json
            snyk-frontend-report.json
            snyk-backend-human.txt
            snyk-frontend-human.txt
        continue-on-error: true

      - name: ğŸ“± Alerta Telegram - AnÃ¡lise SeguranÃ§a CrÃ­tica
        if: needs.security-strategy.outputs.is-security-critical == 'true'
        run: |
          STATUS_ICON="${{ job.status == 'success' && 'âœ…' || 'âŒ' }}"
          STATUS_TEXT="${{ job.status == 'success' && 'CONCLUÃDA' || 'FALHOU' }}"
          
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
            -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
            -d parse_mode=HTML \
            -d text="ğŸ”’ <b>AnÃ¡lise de SeguranÃ§a CRÃTICA</b>%0A%0A$STATUS_ICON <b>Status:</b> $STATUS_TEXT%0AğŸ“… <b>Data:</b> $(date '+%d/%m/%Y %H:%M:%S')%0AğŸ” <b>AnÃ¡lise:</b> CodeQL + Snyk%0Aâš¡ <b>EmergÃªncia:</b> SIM%0A%0AğŸ”— <b>Ver detalhes:</b> https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}%0A%0AğŸš¨ VerificaÃ§Ã£o crÃ­tica de seguranÃ§a"

      - name: ğŸ“± Alerta Telegram - Snyk Quota
        if: needs.security-strategy.outputs.snyk-executed == 'true'
        run: |
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
            -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
            -d parse_mode=HTML \
            -d text="ğŸ“Š <b>Uso de Quota Snyk</b>%0A%0AğŸ¯ <b>ExecuÃ§Ã£o:</b> ${{ needs.security-strategy.outputs.strategy-reason }}%0AğŸ“… <b>Data:</b> $(date '+%d/%m/%Y %H:%M')%0AğŸ’° <b>EstratÃ©gia:</b> Economia inteligente ativa%0AğŸ“ˆ <b>Economia:</b> ~90% vs. execuÃ§Ã£o diÃ¡ria%0A%0Aâ„¹ï¸ Sistema otimizado para ~5-8 execuÃ§Ãµes/mÃªs"

      - name: ğŸ“Š Resumo Final
        run: |
          echo "ğŸ¯ RESUMO DA EXECUÃ‡ÃƒO:"
          echo "  CodeQL: ${{ needs.codeql-analysis.result == 'success' && 'âœ… Executado' || 'âŒ Falhou' }}"
          echo "  Snyk: ${{ needs.security-strategy.outputs.run-snyk == 'true' && 'âœ… Executado (quota usada)' || 'â­ï¸ Pulado (quota preservada)' }}"
          echo "  EstratÃ©gia: ${{ needs.security-strategy.outputs.strategy-reason }}"
          
          if [ "${{ needs.security-strategy.outputs.run-snyk }}" == "true" ]; then
            echo "âš ï¸ ATENÃ‡ÃƒO: 1 execuÃ§Ã£o Snyk utilizada nesta run"
            echo "ğŸ’¡ Restante estimado no mÃªs: Verifique dashboard Snyk"
          else
            echo "âœ… ECONOMIA: 0 execuÃ§Ãµes Snyk utilizadas"
            echo "ğŸ’¡ Quota preservada para uso crÃ­tico"
          fi

# =====================================
# CONFIGURAÃ‡ÃƒO DO WORKFLOW
# =====================================
concurrency:
  group: security-unified-${{ github.ref }}
  cancel-in-progress: true