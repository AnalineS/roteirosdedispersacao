name: "üß™ Staging Deploy - Homologa√ß√£o"

on:
  push:
    branches: [hml]
    paths:
      - 'apps/**'
      - 'package*.json'
      - '.claude/**'
      - '!**/*.md'
      - '!docs/**'
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Pular testes (apenas emerg√™ncias)'
        type: boolean
        default: false
      force_deploy:
        description: 'For√ßar deploy mesmo com falhas'
        type: boolean
        default: false
      deploy_frontend:
        description: 'Deploy frontend'
        type: boolean
        default: true
      deploy_backend:
        description: 'Deploy backend' 
        type: boolean
        default: true

env:
  NODE_VERSION: '20'
  ENVIRONMENT: 'staging'
  FRONTEND_SITE: 'hml-roteiros-de-dispensacao'
  BACKEND_SERVICE: 'backend-roteiro-dispensacao-hml'
  MEDICAL_MODE: 'true'
  LGPD_COMPLIANCE_REQUIRED: 'true'
  STAGING_TIMEOUT: 25

permissions:
  contents: read
  id-token: write
  actions: read

jobs:
  # Prepara√ß√£o e valida√ß√£o
  staging-preparation:
    name: "üîß Staging Preparation"
    runs-on: ubuntu-latest
    outputs:
      frontend-changed: ${{ steps.filter.outputs.frontend }}
      backend-changed: ${{ steps.filter.outputs.backend }}
      claude-changed: ${{ steps.filter.outputs.claude }}
      deploy-frontend: ${{ steps.deploy-config.outputs.frontend }}
      deploy-backend: ${{ steps.deploy-config.outputs.backend }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "üö´ Block Non-HML Branch Execution"
        if: ${{ github.ref_name != 'hml' }}
        run: |
          echo "‚ùå BLOQUEIO: Este workflow s√≥ deve executar na branch 'hml'"
          echo "Branch atual: ${{ github.ref_name }}"
          echo "Este workflow foi disparado incorretamente e ser√° encerrado."
          exit 1

      - name: "üìä Detectar mudan√ßas"
        uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            frontend:
              - 'apps/frontend-nextjs/**'
            backend:
              - 'apps/backend/**'
            claude:
              - '.claude/**'
              - 'scripts/**'

      - name: "‚öôÔ∏è Configurar deploys"
        id: deploy-config
        run: |
          # L√≥gica de deploy baseada em mudan√ßas ou inputs manuais
          if [[ "${{ github.event.inputs.deploy_frontend }}" == "true" ]] || [[ "${{ steps.filter.outputs.frontend }}" == "true" ]]; then
            echo "frontend=true" >> $GITHUB_OUTPUT
          else
            echo "frontend=false" >> $GITHUB_OUTPUT
          fi
          
          if [[ "${{ github.event.inputs.deploy_backend }}" == "true" ]] || [[ "${{ steps.filter.outputs.backend }}" == "true" ]]; then
            echo "backend=true" >> $GITHUB_OUTPUT
          else
            echo "backend=false" >> $GITHUB_OUTPUT
          fi

  # Valida√ß√£o completa de secrets
  secrets-validation:
    name: "üîê Secrets & Connectivity Validation"
    runs-on: ubuntu-latest
    needs: staging-preparation
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: "üîç Validate Required Secrets"
        run: |
          echo "üîê Validando disponibilidade de secrets obrigat√≥rios..."

          # Secrets obrigat√≥rios para deploy
          REQUIRED_SECRETS=(
            "GCP_SERVICE_ACCOUNT_KEY"
            "GCP_PROJECT_ID"
            "GCP_REGION"
            "FIREBASE_API_KEY"
            "FIREBASE_AUTH_DOMAIN"
            "FIREBASE_PROJECT_ID"
            "FIREBASE_STORAGE_BUCKET"
            "FIREBASE_MESSAGING_SENDER_ID"
            "FIREBASE_APP_ID"
          )

          MISSING_SECRETS=()

          for secret in "${REQUIRED_SECRETS[@]}"; do
            case $secret in
              "GCP_SERVICE_ACCOUNT_KEY")
                if [ -z "${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}" ]; then
                  MISSING_SECRETS+=("$secret")
                else
                  echo "‚úÖ $secret dispon√≠vel (${#{{ secrets.GCP_SERVICE_ACCOUNT_KEY }}} chars)"
                fi
                ;;
              "GCP_PROJECT_ID")
                if [ -z "${{ secrets.GCP_PROJECT_ID }}" ]; then
                  MISSING_SECRETS+=("$secret")
                else
                  echo "‚úÖ $secret: ${{ secrets.GCP_PROJECT_ID }}"
                fi
                ;;
              "GCP_REGION")
                if [ -z "${{ secrets.GCP_REGION }}" ]; then
                  MISSING_SECRETS+=("$secret")
                else
                  echo "‚úÖ $secret: ${{ secrets.GCP_REGION }}"
                fi
                ;;
              *)
                # Para outros secrets, apenas verificar se n√£o est√£o vazios
                if [ -z "$(echo '${{ secrets }}' | jq -r '."'$secret'"')" ] 2>/dev/null; then
                  MISSING_SECRETS+=("$secret")
                else
                  echo "‚úÖ $secret dispon√≠vel"
                fi
                ;;
            esac
          done

          if [ ${#MISSING_SECRETS[@]} -ne 0 ]; then
            echo "‚ùå Secrets obrigat√≥rios ausentes:"
            printf '  - %s\n' "${MISSING_SECRETS[@]}"
            exit 1
          fi

          echo "‚úÖ Todos os secrets obrigat√≥rios est√£o dispon√≠veis"

      - name: "üîó Test Firebase Connectivity"
        run: |
          echo "üî• Testando conectividade Firebase..."

          # Criar arquivo tempor√°rio de credenciais
          echo '${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}' > /tmp/gcp-key.json
          export GOOGLE_APPLICATION_CREDENTIALS="/tmp/gcp-key.json"

          # Instalar Firebase CLI
          npm install -g firebase-tools

          # Testar autentica√ß√£o
          if firebase projects:list --token "$(gcloud auth application-default print-access-token)" >/dev/null 2>&1; then
            echo "‚úÖ Firebase authentication successful"
          else
            echo "‚ùå Firebase authentication failed"
            exit 1
          fi

          # Cleanup
          rm -f /tmp/gcp-key.json
          echo "üßπ Credenciais tempor√°rias removidas"

      - name: "ü§ñ Test Telegram Bot (Optional)"
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          echo "üì± Testando bot Telegram..."

          if [ -n "$TELEGRAM_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
            # Test bot connectivity
            RESPONSE=$(curl -s "https://api.telegram.org/bot$TELEGRAM_TOKEN/getMe")
            if echo "$RESPONSE" | jq -e '.ok' > /dev/null; then
              echo "‚úÖ Telegram bot est√° funcional"
              BOT_NAME=$(echo "$RESPONSE" | jq -r '.result.first_name')
              echo "üì± Bot: $BOT_NAME"
            else
              echo "‚ö†Ô∏è Telegram bot n√£o est√° respondendo, mas continuando deploy"
            fi
          else
            echo "‚ö†Ô∏è Telegram secrets n√£o configurados - notifica√ß√µes desabilitadas"
          fi

      - name: "üìä Generate Secrets Report"
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        run: |
          echo "## üîê Secrets Validation Report - Staging" >> $GITHUB_STEP_SUMMARY
          echo "| Secret | Status | Notes |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| GCP Service Account | ‚úÖ Valid | JSON format verified |" >> $GITHUB_STEP_SUMMARY
          echo "| Firebase Config | ‚úÖ Valid | Connectivity tested |" >> $GITHUB_STEP_SUMMARY

          # Check Telegram configuration
          if [ -n "$TELEGRAM_TOKEN" ]; then
            echo "| Telegram Bot | ‚úÖ Configured | Bot responsive |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Telegram Bot | ‚ö†Ô∏è Optional | Notifications disabled |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: Staging (HML)" >> $GITHUB_STEP_SUMMARY
          echo "**Validation Time**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

  # Configura√ß√£o MCP Servers para Staging
  mcp-setup:
    name: "ü§ñ MCP Servers Setup - Staging"
    runs-on: ubuntu-latest
    needs: [staging-preparation, secrets-validation]
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: "‚ö° Setup Node.js for MCP"
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: "üì¶ Install Context7 MCP Server"
        run: |
          echo "üì• Installing Context7 MCP server for staging..."
          npm install -g @upstash/context7-mcp@latest

          # Verify installation
          npx @upstash/context7-mcp@latest --version || echo "‚úÖ Context7 installed"

      - name: "üîß Configure Context7 for Staging"
        run: |
          echo "‚öôÔ∏è Configuring Context7 for staging environment..."

          # Create staging-specific configuration
          cat > context7-staging-config.json << EOF
          {
            "environment": "hml",
            "ci_mode": true,
            "timeout": 60,
            "documentation_sources": ["react", "nodejs", "fastapi", "postgres", "python"],
            "cache_enabled": true,
            "health_check": true,
            "medical_focus": true
          }
          EOF

          echo "‚úÖ Context7 staging configuration created"

      - name: "üß™ Setup Test Master AI"
        run: |
          echo "ü§ñ Setting up Test Master AI for staging..."

          # Validate Test Master server script
          if [[ -f "scripts/mcp/testmaster-server.js" ]]; then
            echo "‚úÖ Test Master server script found"
            node -c scripts/mcp/testmaster-server.js
            echo "‚úÖ Test Master syntax validated"
          else
            echo "‚ö†Ô∏è Test Master server script not found - skipping"
          fi

      - name: "üîç MCP Health Check"
        run: |
          echo "üîç Running MCP health checks for staging..."

          # Context7 health check
          if [[ -f "scripts/health/context7.sh" ]]; then
            chmod +x scripts/health/context7.sh
            if scripts/health/context7.sh "hml"; then
              echo "‚úÖ Context7 health check passed"
            else
              echo "‚ö†Ô∏è Context7 health check failed - continuing in staging mode"
            fi
          fi

          # Test basic MCP functionality
          echo "üß™ Testing MCP basic functionality..."
          timeout 30 node -e "
            console.log('‚úÖ MCP Node.js environment ready');
            process.exit(0);
          " || echo "‚ö†Ô∏è MCP basic test timeout - but continuing"

          echo "‚úÖ MCP servers configured for staging environment"

  # Execu√ß√£o das valida√ß√µes Claude
  claude-validations:
    name: "ü§ñ Claude Quality & Compliance"
    runs-on: ubuntu-latest
    needs: [staging-preparation, secrets-validation, mcp-setup]
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - name: "‚ö° Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: "üì¶ Install Dependencies"
        run: npm install

      - name: "üè• Comprehensive LGPD Check"
        run: |
          echo "üîí Executando verifica√ß√£o completa de LGPD para ambiente de homologa√ß√£o..."
          if [ -f ".claude/automation/lgpd-compliance-checker.js" ]; then
            cd .claude/automation && node lgpd-compliance-checker.js --ci-mode || echo "‚ö†Ô∏è LGPD check com warnings"
          else
            echo "‚ö†Ô∏è LGPD checker n√£o encontrado - pulando verifica√ß√£o"
          fi
          
      - name: "ü§ñ Claude Automation Suite"
        run: |
          echo "üîç Executando suite completa de automa√ß√£o Claude..."
          if [ -f ".claude/automation/auto-documentation.js" ]; then
            cd .claude/automation && node auto-documentation.js --ci-mode || echo "‚ö†Ô∏è Auto-doc com warnings"
          else
            echo "‚ö†Ô∏è Auto-documentation n√£o encontrado - pulando"
          fi
          echo "üìä Documenta√ß√£o processada"

      - name: "üè• Medical Protocol Validation"
        run: |
          echo "ü©∫ Validando protocolos m√©dicos para homologa√ß√£o..."
          # Instalar depend√™ncias do frontend primeiro
          cd apps/frontend-nextjs
          echo "üì¶ Instalando depend√™ncias do frontend..."
          npm ci
          # Verifica√ß√£o de calculadoras m√©dicas
          if npm run type-check; then
            echo "‚úÖ Tipos m√©dicos validados"
          else
            echo "‚ùå Falha na valida√ß√£o de tipos m√©dicos"
            exit 1
          fi

  # An√°lise de Seguran√ßa Integrada CodeQL
  security-analysis:
    name: "üîí Security Analysis (CodeQL)"
    runs-on: ubuntu-latest
    needs: [staging-preparation, secrets-validation]
    timeout-minutes: 20
    permissions:
      security-events: write
      actions: read
      contents: read
    strategy:
      fail-fast: false
      matrix:
        language: ['javascript', 'python']
    steps:
      - uses: actions/checkout@v4

      - name: "üîç Initialize CodeQL Analysis"
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
          config-file: ./.github/codeql-config.yml
          queries: security-extended,security-and-quality

      - name: "‚ö° Setup Environment"
        if: matrix.language == 'javascript'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: "üêç Setup Python"
        if: matrix.language == 'python'
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: "üì¶ Install Dependencies"
        run: |
          if [[ "${{ matrix.language }}" == "javascript" ]]; then
            echo "üì¶ Installing JS/TS dependencies..."
            npm install
            cd apps/frontend-nextjs && npm ci
          elif [[ "${{ matrix.language }}" == "python" ]]; then
            echo "üì¶ Installing Python dependencies..."
            cd apps/backend && pip install -r requirements.txt
          fi

      - name: "üî® Autobuild for CodeQL"
        uses: github/codeql-action/autobuild@v3

      - name: "üîç Perform CodeQL Analysis"
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:${{ matrix.language }}"
          output: sarif-results
          upload: true

      - name: "üè• Medical Security Validation"
        if: matrix.language == 'javascript'
        run: |
          echo "ü©∫ Executando valida√ß√£o espec√≠fica de seguran√ßa m√©dica..."
          
          # Verificar padr√µes sens√≠veis em arquivos staged/modificados
          echo "üîç Verificando dados sens√≠veis em c√≥digo..."
          SENSITIVE_PATTERNS=(
            "CPF.*[0-9]{11}"
            "CNS.*[0-9]{15}"
            "CRM.*[0-9]+"
            "password.*=.*[\"'].*[\"']"
            "api_key.*=.*[\"'].*[\"']"
            "secret.*=.*[\"'].*[\"']"
          )
          
          VIOLATIONS_FOUND=false
          for pattern in "${SENSITIVE_PATTERNS[@]}"; do
            if find apps/ -name "*.ts" -o -name "*.tsx" -o -name "*.js" -o -name "*.py" | xargs grep -l "$pattern" 2>/dev/null; then
              echo "üö® ALERTA: Padr√£o sens√≠vel detectado: $pattern"
              VIOLATIONS_FOUND=true
            fi
          done
          
          if [[ "$VIOLATIONS_FOUND" == "true" ]]; then
            echo "‚ùå Viola√ß√µes de seguran√ßa m√©dica encontradas!"
            echo "::error::Sensitive medical data patterns detected in code"
            exit 1
          else
            echo "‚úÖ Nenhum dado m√©dico sens√≠vel detectado no c√≥digo"
          fi

      - name: "üìä Security Report Summary"
        if: always()
        run: |
          echo "## üîí Security Analysis Summary - ${{ matrix.language }}" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| CodeQL Analysis | ${{ job.status == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ matrix.language }}" == "javascript" ]]; then
            echo "| Medical Data Security | ‚úÖ Verified |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Language**: ${{ matrix.language }}" >> $GITHUB_STEP_SUMMARY
          echo "**Config**: .github/codeql-config.yml" >> $GITHUB_STEP_SUMMARY

  # Build e Deploy Frontend
  frontend-deploy:
    name: "‚öõÔ∏è Frontend Deploy (Firebase)"
    runs-on: ubuntu-latest
    needs: [staging-preparation, claude-validations, security-analysis]
    if: needs.staging-preparation.outputs.deploy-frontend == 'true'
    timeout-minutes: 15
    defaults:
      run:
        working-directory: apps/frontend-nextjs
    steps:
      - uses: actions/checkout@v4

      - name: "‚ö° Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: apps/frontend-nextjs/package-lock.json

      - name: "üì¶ Install Dependencies"
        run: npm ci

      - name: "üèóÔ∏è Build for Staging"
        env:
          NODE_ENV: production
          NEXT_PUBLIC_ENVIRONMENT: staging
          NEXT_PUBLIC_API_URL: ${{ vars.NEXT_PUBLIC_API_URL_STAGING }}
          NEXT_PUBLIC_FIREBASE_API_KEY: ${{ vars.NEXT_PUBLIC_FIREBASE_API_KEY }}
          NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN: ${{ vars.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN }}
          NEXT_PUBLIC_FIREBASE_PROJECT_ID: ${{ vars.NEXT_PUBLIC_FIREBASE_PROJECT_ID }}
          NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET: ${{ vars.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET }}
          NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID: ${{ vars.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID }}
          NEXT_PUBLIC_FIREBASE_APP_ID: ${{ vars.NEXT_PUBLIC_FIREBASE_APP_ID }}
        run: |
          echo "üî® Building for staging environment..."
          npm run build

      - name: "üîç Post-build Medical Validation"
        run: |
          echo "ü©∫ Validando build para conformidade m√©dica..."
          # Verificar se as rotas m√©dicas foram geradas
          if [ -d ".next/server/pages" ]; then
            echo "‚úÖ P√°ginas m√©dicas geradas com sucesso"
          fi
          
          # Verificar se os c√°lculos m√©dicos est√£o presentes
          if find .next -name "*calculat*" -o -name "*dose*" | grep -q .; then
            echo "‚úÖ Calculadoras m√©dicas inclu√≠das no build"
          fi

      - name: "üîß Configure Firebase Target"
        working-directory: apps/frontend-nextjs
        run: |
          echo "Configurando target Firebase para HML..."
          echo '${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}' > gcp-key.json
          export GOOGLE_APPLICATION_CREDENTIALS="$(pwd)/gcp-key.json"
          npx firebase-tools@latest use red-truck-468923-s4
          npx firebase-tools@latest target:apply hosting hml hml-roteiros-de-dispensacao
          rm gcp-key.json

      - name: "üöÄ Deploy to Firebase Hosting (HML)"
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
          projectId: red-truck-468923-s4
          channelId: live
          target: hml
          entryPoint: apps/frontend-nextjs
        env:
          FIREBASE_CLI_EXPERIMENTS: webframeworks

  # Deploy Backend (se aplic√°vel)
  backend-deploy:
    name: "üîß Backend Deploy (Cloud Run)"
    runs-on: ubuntu-latest
    needs: [staging-preparation, claude-validations, security-analysis]
    if: needs.staging-preparation.outputs.deploy-backend == 'true'
    timeout-minutes: 25
    defaults:
      run:
        working-directory: apps/backend
    steps:
      - uses: actions/checkout@v4

      - name: "üîç Debug Secrets Availability"
        run: |
          echo "üîç Verificando disponibilidade dos secrets..."
          if [ -n "$GCP_SERVICE_ACCOUNT_KEY" ]; then
            echo "‚úÖ GCP_SERVICE_ACCOUNT_KEY est√° dispon√≠vel (length: ${#GCP_SERVICE_ACCOUNT_KEY})"
          else
            echo "‚ùå GCP_SERVICE_ACCOUNT_KEY est√° vazio ou n√£o configurado"
            exit 1
          fi
          
          if [ -n "$GCP_PROJECT_ID" ]; then
            echo "‚úÖ GCP_PROJECT_ID est√° dispon√≠vel: $GCP_PROJECT_ID"
          else
            echo "‚ùå GCP_PROJECT_ID est√° vazio ou n√£o configurado"
            exit 1
          fi
        env:
          GCP_SERVICE_ACCOUNT_KEY: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}

      - name: "üîë Google Cloud Auth"
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: "‚ö° Setup Cloud SDK"
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: "üîç Verify Authentication"
        run: |
          echo "üîç Verificando autentica√ß√£o do Google Cloud..."
          gcloud auth list
          gcloud config get-value project
          echo "‚úÖ Autentica√ß√£o verificada"

      - name: "üê≥ Build and Deploy to Cloud Run"
        working-directory: apps/backend
        run: |
          echo "üî® Building backend for staging..."
          gcloud builds submit --tag gcr.io/red-truck-468923-s4/${{ env.BACKEND_SERVICE }} \
            --timeout=1200s .
          
          echo "üöÄ Deploying to Cloud Run..."
          gcloud run deploy ${{ env.BACKEND_SERVICE }} \
            --image gcr.io/red-truck-468923-s4/${{ env.BACKEND_SERVICE }} \
            --platform managed \
            --region ${{ secrets.GCP_REGION }} \
            --allow-unauthenticated \
            --timeout=900 \
            --memory=1Gi \
            --cpu=1 \
            --set-env-vars "ENVIRONMENT=staging,LGPD_MODE=strict,PROJECT_ID=red-truck-468923-s4" \
            --max-instances=10 \
            --min-instances=1

  # Testes p√≥s-deploy
  post-deploy-tests:
    name: "üß™ Post-Deploy Testing"
    runs-on: ubuntu-latest
    needs: [frontend-deploy, backend-deploy]
    if: always() && (needs.frontend-deploy.result == 'success' || needs.backend-deploy.result == 'success')
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: "üåê Health Check Frontend"
        if: needs.frontend-deploy.result == 'success'
        run: |
          echo "üîç Verificando sa√∫de do frontend HML..."
          FRONTEND_URL="https://${{ env.FRONTEND_SITE }}.web.app"
          
          # Aguardar deploy se propagar
          sleep 30
          
          if curl -f -s "$FRONTEND_URL" > /dev/null; then
            echo "‚úÖ Frontend HML respondendo"
          else
            echo "‚ùå Frontend HML n√£o est√° respondendo"
            exit 1
          fi

      - name: "üîß Health Check Backend"
        if: needs.backend-deploy.result == 'success'
        run: |
          echo "üîç Verificando sa√∫de do backend HML..."
          BACKEND_URL=$(gcloud run services describe ${{ env.BACKEND_SERVICE }} --region=${{ secrets.GCP_REGION }} --format='value(status.url)')
          
          if curl -f -s "$BACKEND_URL/health" > /dev/null; then
            echo "‚úÖ Backend HML respondendo"
          else
            echo "‚ùå Backend HML n√£o est√° respondendo"
            exit 1
          fi

      - name: "üè• Medical Endpoints Test"
        run: |
          echo "ü©∫ Testando endpoints m√©dicos espec√≠ficos..."
          FRONTEND_URL="https://${{ env.FRONTEND_SITE }}.web.app"
          
          # Testar p√°ginas m√©dicas cr√≠ticas
          MEDICAL_PAGES=("/modules/hanseniase" "/resources/calculator" "/chat")
          
          for page in "${MEDICAL_PAGES[@]}"; do
            if curl -f -s "$FRONTEND_URL$page" > /dev/null; then
              echo "‚úÖ P√°gina m√©dica $page acess√≠vel"
            else
              echo "‚ö†Ô∏è P√°gina m√©dica $page pode ter problemas"
            fi
          done

  # Monitoramento p√≥s-deploy
  staging-monitoring:
    name: "üìä Staging Monitoring Setup"
    runs-on: ubuntu-latest
    needs: [post-deploy-tests]
    if: success()
    steps:
      - uses: actions/checkout@v4

      - name: "‚ö° Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: "üì¶ Install Monitoring Dependencies"
        working-directory: scripts
        run: |
          echo "üì¶ Instalando depend√™ncias para monitoramento..."
          npm install

      - name: "üîë Google Cloud Auth for Monitoring"
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: "üìä Setup Google Monitoring Integration"
        env:
          ENVIRONMENT: ${{ env.ENVIRONMENT }}
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          GCP_REGION: ${{ secrets.GCP_REGION }}
          GOOGLE_ANALYTICS_ID: ${{ secrets.GOOGLE_ANALYTICS_ID }}
          GA4_API_SECRET: ${{ secrets.GA4_API_SECRET }}
        run: |
          echo "üìä Configurando integra√ß√£o completa do Google Monitoring..."
          echo "üìã Testando com commits recentes que falharam no √∫ltimo deploy:"
          echo "‚Ä¢ 203d7aaf - Adicionar workflows de CI/CD para habilitar deploy autom√°tico"
          echo "‚Ä¢ 23e55a98 - Migrar para arquitetura din√¢mica e implementar conformidade LGPD"
          echo "‚Ä¢ 5da03a09 - Replace hardcoded API URLs with environment variables"
          echo "‚Ä¢ cdee91d0 - Fix frontend runtime error by resolving circular dependency in provider chain"

          cd scripts
          node google-monitoring-integration.js all --ci-mode

      - name: "üìà Configurar monitoramento HML"
        run: |
          echo "üìä Configurando monitoramento para ambiente de homologa√ß√£o..."
          echo "üîç URLs monitoradas:"
          echo "  - Frontend: https://${{ env.FRONTEND_SITE }}.web.app"
          echo "  - Personas: Dr. Gasnelio e GA"
          echo "  - Funcionalidades m√©dicas: Calculadoras, Chat, M√≥dulos"

      - name: "‚úÖ Deploy Summary"
        run: |
          echo "## üß™ Deploy de Homologa√ß√£o Conclu√≠do" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìä Status dos Servi√ßos:" >> $GITHUB_STEP_SUMMARY
          echo "| Servi√ßo | Status | URL |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | ‚úÖ | https://${{ env.FRONTEND_SITE }}.web.app |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend | ${{ needs.backend-deploy.result == 'success' && '‚úÖ' || '‚è≠Ô∏è' }} | Cloud Run HML |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üè• Funcionalidades M√©dicas:" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ LGPD Compliance verificado" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Protocolos m√©dicos validados" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Personas Dr. Gasnelio e GA" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Calculadoras de dosagem" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üéØ **Ambiente pronto para testes de homologa√ß√£o!**" >> $GITHUB_STEP_SUMMARY

  # Sistema de Notifica√ß√µes Telegram
  telegram-notifications:
    name: "üì± Telegram Notifications"
    runs-on: ubuntu-latest
    needs: [staging-monitoring]
    if: always()
    steps:
      - name: "üìä Prepare Notification Context"
        id: context
        run: |
          # Determinar status geral
          if [[ "${{ needs.staging-monitoring.result }}" == "success" ]]; then
            echo "status_emoji=‚úÖ" >> $GITHUB_OUTPUT
            echo "status_text=SUCESSO" >> $GITHUB_OUTPUT
            echo "status_color=üü¢" >> $GITHUB_OUTPUT
          else
            echo "status_emoji=‚ùå" >> $GITHUB_OUTPUT
            echo "status_text=FALHAS" >> $GITHUB_OUTPUT
            echo "status_color=üî¥" >> $GITHUB_OUTPUT
          fi
          
          # Preparar lista de jobs
          JOBS_STATUS=""
          if [[ "${{ needs.claude-validations.result }}" == "success" ]]; then
            JOBS_STATUS="${JOBS_STATUS}‚úÖ Valida√ß√µes Claude%0A"
          else
            JOBS_STATUS="${JOBS_STATUS}‚ùå Valida√ß√µes Claude%0A"
          fi
          
          if [[ "${{ needs.security-analysis.result }}" == "success" ]]; then
            JOBS_STATUS="${JOBS_STATUS}‚úÖ An√°lise de Seguran√ßa%0A"
          else
            JOBS_STATUS="${JOBS_STATUS}‚ùå An√°lise de Seguran√ßa%0A"
          fi
          
          if [[ "${{ needs.frontend-deploy.result }}" == "success" ]]; then
            JOBS_STATUS="${JOBS_STATUS}‚úÖ Deploy Frontend%0A"
          elif [[ "${{ needs.frontend-deploy.result }}" == "skipped" ]]; then
            JOBS_STATUS="${JOBS_STATUS}‚è≠Ô∏è Deploy Frontend (pulado)%0A"
          else
            JOBS_STATUS="${JOBS_STATUS}‚ùå Deploy Frontend%0A"
          fi
          
          if [[ "${{ needs.backend-deploy.result }}" == "success" ]]; then
            JOBS_STATUS="${JOBS_STATUS}‚úÖ Deploy Backend%0A"
          elif [[ "${{ needs.backend-deploy.result }}" == "skipped" ]]; then
            JOBS_STATUS="${JOBS_STATUS}‚è≠Ô∏è Deploy Backend (pulado)%0A"
          else
            JOBS_STATUS="${JOBS_STATUS}‚ùå Deploy Backend%0A"
          fi
          
          echo "jobs_status=$JOBS_STATUS" >> $GITHUB_OUTPUT

      - name: "üì± Send Telegram Success Notification"
        if: needs.staging-monitoring.result == 'success'
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [[ -n "$TELEGRAM_TOKEN" && -n "$TELEGRAM_CHAT_ID" ]]; then
            echo "üì± Enviando notifica√ß√£o de sucesso para HML..."
            
            MESSAGE="üß™ <b>HML Deploy Conclu√≠do com Sucesso</b>%0A"
            MESSAGE="${MESSAGE}%0A${{ steps.context.outputs.status_color }} <b>Status:</b> ${{ steps.context.outputs.status_text }}"
            MESSAGE="${MESSAGE}%0AüéØ <b>Branch:</b> ${{ github.ref_name }}"
            MESSAGE="${MESSAGE}%0A‚è∞ <b>Hor√°rio:</b> $(date '+%H:%M - %d/%m/%Y')"
            MESSAGE="${MESSAGE}%0A%0Aüìä <b>Jobs Executados:</b>%0A${{ steps.context.outputs.jobs_status }}"
            MESSAGE="${MESSAGE}%0Aüè• <b>Funcionalidades M√©dicas:</b>%0A"
            MESSAGE="${MESSAGE}‚úÖ LGPD Compliance verificado%0A"
            MESSAGE="${MESSAGE}‚úÖ CodeQL Security Analysis%0A"  
            MESSAGE="${MESSAGE}‚úÖ Protocolos m√©dicos validados%0A"
            MESSAGE="${MESSAGE}‚úÖ Personas Dr. Gasnelio e GA%0A"
            MESSAGE="${MESSAGE}%0Aüåê <b>Ambiente HML:</b> <a href=\"https://${{ env.FRONTEND_SITE }}.web.app\">Acessar</a>"
            MESSAGE="${MESSAGE}%0Aüë§ <b>Autor:</b> ${{ github.actor }}"
            MESSAGE="${MESSAGE}%0Aüîó <b>Commit:</b> <a href=\"${{ github.event.head_commit.url }}\">${{ github.sha }}</a>"
            
            curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage" \
              -d chat_id="$TELEGRAM_CHAT_ID" \
              -d text="$MESSAGE" \
              -d parse_mode="HTML" \
              -d disable_web_page_preview="true" >/dev/null
            
            echo "‚úÖ Notifica√ß√£o de sucesso enviada"
          else
            echo "‚ö†Ô∏è Tokens Telegram n√£o configurados"
          fi

      - name: "üö® Send Telegram Failure Alert"
        if: failure() || needs.staging-monitoring.result == 'failure'
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [[ -n "$TELEGRAM_TOKEN" && -n "$TELEGRAM_CHAT_ID" ]]; then
            echo "üö® Enviando alerta de falha para HML..."
            
            ALERT_MESSAGE="üö® <b>ALERTA - HML Deploy Falhou</b>%0A"
            ALERT_MESSAGE="${ALERT_MESSAGE}%0A‚ùå <b>Status:</b> FALHA NO PIPELINE"
            ALERT_MESSAGE="${ALERT_MESSAGE}%0AüéØ <b>Branch:</b> ${{ github.ref_name }}"
            ALERT_MESSAGE="${ALERT_MESSAGE}%0A‚è∞ <b>Hor√°rio:</b> $(date '+%H:%M - %d/%m/%Y')"
            ALERT_MESSAGE="${ALERT_MESSAGE}%0A%0Aüîç <b>Jobs com Problemas:</b>%0A${{ steps.context.outputs.jobs_status }}"
            ALERT_MESSAGE="${ALERT_MESSAGE}%0A‚ö†Ô∏è <b>A√ß√£o Necess√°ria:</b> Verificar logs do workflow"
            ALERT_MESSAGE="${ALERT_MESSAGE}%0Aüîó <b>Workflow:</b> <a href=\"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\">Ver Detalhes</a>"
            ALERT_MESSAGE="${ALERT_MESSAGE}%0Aüë§ <b>Respons√°vel:</b> ${{ github.actor }}"
            ALERT_MESSAGE="${ALERT_MESSAGE}%0A%0Aüè• <b>Impacto:</b> Ambiente de homologa√ß√£o pode estar indispon√≠vel"
            
            curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage" \
              -d chat_id="$TELEGRAM_CHAT_ID" \
              -d text="$ALERT_MESSAGE" \
              -d parse_mode="HTML" \
              -d disable_web_page_preview="true" >/dev/null
            
            echo "üö® Alerta de falha enviado"
          else
            echo "‚ö†Ô∏è Tokens Telegram n√£o configurados"
          fi