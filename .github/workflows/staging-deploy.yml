name: "ðŸ§ª Staging Deploy - HomologaÃ§Ã£o"

on:
  push:
    branches: [hml]
    paths:
      - 'apps/**'
      - 'package*.json'
      - '.github/workflows/**'
      - '.claude/**'
      - '!**/*.md'
      - '!docs/**'
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Pular testes (apenas emergÃªncias)'
        type: boolean
        default: false
      force_deploy:
        description: 'ForÃ§ar deploy mesmo com falhas'
        type: boolean
        default: false
      deploy_frontend:
        description: 'Deploy frontend'
        type: boolean
        default: true
      deploy_backend:
        description: 'Deploy backend' 
        type: boolean
        default: true

env:
  NODE_VERSION: '20'
  ENVIRONMENT: 'staging'
  FRONTEND_SITE: 'hml-roteiros-de-dispensacao'
  BACKEND_SERVICE: 'hml-roteiro-dispensacao-api'
  MEDICAL_MODE: 'true'
  LGPD_COMPLIANCE_REQUIRED: 'true'
  STAGING_TIMEOUT: 25

permissions:
  contents: read
  id-token: write
  actions: read

jobs:
  # PreparaÃ§Ã£o e validaÃ§Ã£o
  staging-preparation:
    name: "ðŸ”§ Staging Preparation"
    runs-on: ubuntu-latest
    outputs:
      frontend-changed: ${{ steps.filter.outputs.frontend }}
      backend-changed: ${{ steps.filter.outputs.backend }}
      claude-changed: ${{ steps.filter.outputs.claude }}
      deploy-frontend: ${{ steps.deploy-config.outputs.frontend }}
      deploy-backend: ${{ steps.deploy-config.outputs.backend }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "ðŸ“Š Detectar mudanÃ§as"
        uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            frontend:
              - 'apps/frontend-nextjs/**'
            backend:
              - 'apps/backend/**'
            claude:
              - '.claude/**'
              - 'scripts/**'

      - name: "âš™ï¸ Configurar deploys"
        id: deploy-config
        run: |
          # LÃ³gica de deploy baseada em mudanÃ§as ou inputs manuais
          if [[ "${{ github.event.inputs.deploy_frontend }}" == "true" ]] || [[ "${{ steps.filter.outputs.frontend }}" == "true" ]]; then
            echo "frontend=true" >> $GITHUB_OUTPUT
          else
            echo "frontend=false" >> $GITHUB_OUTPUT
          fi
          
          if [[ "${{ github.event.inputs.deploy_backend }}" == "true" ]] || [[ "${{ steps.filter.outputs.backend }}" == "true" ]]; then
            echo "backend=true" >> $GITHUB_OUTPUT
          else
            echo "backend=false" >> $GITHUB_OUTPUT
          fi

  # ExecuÃ§Ã£o das validaÃ§Ãµes Claude
  claude-validations:
    name: "ðŸ¤– Claude Quality & Compliance"
    runs-on: ubuntu-latest
    needs: staging-preparation
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - name: "âš¡ Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: "ðŸ“¦ Install Dependencies"
        run: npm install

      - name: "ðŸ¥ Comprehensive LGPD Check"
        run: |
          echo "ðŸ”’ Executando verificaÃ§Ã£o completa de LGPD para ambiente de homologaÃ§Ã£o..."
          npm run compliance:check
          
      - name: "ðŸ¤– Claude Automation Suite"
        run: |
          echo "ðŸ” Executando suite completa de automaÃ§Ã£o Claude..."
          npm run automation:docs
          echo "ðŸ“Š DocumentaÃ§Ã£o atualizada"

      - name: "ðŸ¥ Medical Protocol Validation"
        run: |
          echo "ðŸ©º Validando protocolos mÃ©dicos para homologaÃ§Ã£o..."
          # VerificaÃ§Ã£o de calculadoras mÃ©dicas
          cd apps/frontend-nextjs
          if npm run type-check; then
            echo "âœ… Tipos mÃ©dicos validados"
          else
            echo "âŒ Falha na validaÃ§Ã£o de tipos mÃ©dicos"
            exit 1
          fi

  # Build e Deploy Frontend
  frontend-deploy:
    name: "âš›ï¸ Frontend Deploy (Firebase)"
    runs-on: ubuntu-latest
    needs: [staging-preparation, claude-validations]
    if: needs.staging-preparation.outputs.deploy-frontend == 'true'
    timeout-minutes: 15
    defaults:
      run:
        working-directory: apps/frontend-nextjs
    steps:
      - uses: actions/checkout@v4

      - name: "âš¡ Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: apps/frontend-nextjs/package-lock.json

      - name: "ðŸ“¦ Install Dependencies"
        run: npm ci

      - name: "ðŸ—ï¸ Build for Staging"
        env:
          NODE_ENV: production
          NEXT_PUBLIC_ENVIRONMENT: staging
          NEXT_PUBLIC_API_URL: ${{ secrets.HML_API_URL }}
          NEXT_PUBLIC_FIREBASE_CONFIG: ${{ secrets.HML_FIREBASE_CONFIG }}
        run: |
          echo "ðŸ”¨ Building for staging environment..."
          npm run build

      - name: "ðŸ” Post-build Medical Validation"
        run: |
          echo "ðŸ©º Validando build para conformidade mÃ©dica..."
          # Verificar se as rotas mÃ©dicas foram geradas
          if [ -d ".next/server/pages" ]; then
            echo "âœ… PÃ¡ginas mÃ©dicas geradas com sucesso"
          fi
          
          # Verificar se os cÃ¡lculos mÃ©dicos estÃ£o presentes
          if find .next -name "*calculat*" -o -name "*dose*" | grep -q .; then
            echo "âœ… Calculadoras mÃ©dicas incluÃ­das no build"
          fi

      - name: "ðŸš€ Deploy to Firebase Hosting (HML)"
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.HML_FIREBASE_SERVICE_ACCOUNT }}
          projectId: ${{ secrets.GCP_PROJECT_ID }}
          channelId: live
          target: ${{ env.FRONTEND_SITE }}
        env:
          FIREBASE_CLI_EXPERIMENTS: webframeworks

  # Deploy Backend (se aplicÃ¡vel)
  backend-deploy:
    name: "ðŸ”§ Backend Deploy (Cloud Run)"
    runs-on: ubuntu-latest
    needs: [staging-preparation, claude-validations]
    if: needs.staging-preparation.outputs.deploy-backend == 'true'
    timeout-minutes: 25
    defaults:
      run:
        working-directory: apps/backend
    steps:
      - uses: actions/checkout@v4

      - name: "ðŸ”‘ Google Cloud Auth"
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.HML_GCP_SERVICE_ACCOUNT }}

      - name: "âš¡ Setup Cloud SDK"
        uses: google-github-actions/setup-gcloud@v1

      - name: "ðŸ³ Build and Deploy to Cloud Run"
        run: |
          echo "ðŸ”¨ Building backend for staging..."
          gcloud builds submit --tag gcr.io/${{ secrets.GCP_PROJECT_ID }}/${{ env.BACKEND_SERVICE }} \
            --timeout=1200s
          
          echo "ðŸš€ Deploying to Cloud Run..."
          gcloud run deploy ${{ env.BACKEND_SERVICE }} \
            --image gcr.io/${{ secrets.GCP_PROJECT_ID }}/${{ env.BACKEND_SERVICE }} \
            --platform managed \
            --region ${{ secrets.GCP_REGION }} \
            --allow-unauthenticated \
            --timeout=1200 \
            --memory=2Gi \
            --cpu=2 \
            --set-env-vars "ENVIRONMENT=staging,LGPD_MODE=strict,PROJECT_ID=${{ secrets.GCP_PROJECT_ID }}" \
            --max-instances=10 \
            --min-instances=1

  # Testes pÃ³s-deploy
  post-deploy-tests:
    name: "ðŸ§ª Post-Deploy Testing"
    runs-on: ubuntu-latest
    needs: [frontend-deploy, backend-deploy]
    if: always() && (needs.frontend-deploy.result == 'success' || needs.backend-deploy.result == 'success')
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: "ðŸŒ Health Check Frontend"
        if: needs.frontend-deploy.result == 'success'
        run: |
          echo "ðŸ” Verificando saÃºde do frontend HML..."
          FRONTEND_URL="https://${{ env.FRONTEND_SITE }}.web.app"
          
          # Aguardar deploy se propagar
          sleep 30
          
          if curl -f -s "$FRONTEND_URL" > /dev/null; then
            echo "âœ… Frontend HML respondendo"
          else
            echo "âŒ Frontend HML nÃ£o estÃ¡ respondendo"
            exit 1
          fi

      - name: "ðŸ”§ Health Check Backend"
        if: needs.backend-deploy.result == 'success'
        run: |
          echo "ðŸ” Verificando saÃºde do backend HML..."
          BACKEND_URL=$(gcloud run services describe ${{ env.BACKEND_SERVICE }} --region=${{ secrets.GCP_REGION }} --format='value(status.url)')
          
          if curl -f -s "$BACKEND_URL/health" > /dev/null; then
            echo "âœ… Backend HML respondendo"
          else
            echo "âŒ Backend HML nÃ£o estÃ¡ respondendo"
            exit 1
          fi

      - name: "ðŸ¥ Medical Endpoints Test"
        run: |
          echo "ðŸ©º Testando endpoints mÃ©dicos especÃ­ficos..."
          FRONTEND_URL="https://${{ env.FRONTEND_SITE }}.web.app"
          
          # Testar pÃ¡ginas mÃ©dicas crÃ­ticas
          MEDICAL_PAGES=("/modules/hanseniase" "/resources/calculator" "/chat")
          
          for page in "${MEDICAL_PAGES[@]}"; do
            if curl -f -s "$FRONTEND_URL$page" > /dev/null; then
              echo "âœ… PÃ¡gina mÃ©dica $page acessÃ­vel"
            else
              echo "âš ï¸ PÃ¡gina mÃ©dica $page pode ter problemas"
            fi
          done

  # Monitoramento pÃ³s-deploy
  staging-monitoring:
    name: "ðŸ“Š Staging Monitoring Setup"
    runs-on: ubuntu-latest
    needs: [post-deploy-tests]
    if: success()
    steps:
      - name: "ðŸ“ˆ Configurar monitoramento HML"
        run: |
          echo "ðŸ“Š Configurando monitoramento para ambiente de homologaÃ§Ã£o..."
          echo "ðŸ” URLs monitoradas:"
          echo "  - Frontend: https://${{ env.FRONTEND_SITE }}.web.app"
          echo "  - Personas: Dr. Gasnelio e GA"
          echo "  - Funcionalidades mÃ©dicas: Calculadoras, Chat, MÃ³dulos"

      - name: "âœ… Deploy Summary"
        run: |
          echo "## ðŸ§ª Deploy de HomologaÃ§Ã£o ConcluÃ­do" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Status dos ServiÃ§os:" >> $GITHUB_STEP_SUMMARY
          echo "| ServiÃ§o | Status | URL |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | âœ… | https://${{ env.FRONTEND_SITE }}.web.app |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend | ${{ needs.backend-deploy.result == 'success' && 'âœ…' || 'â­ï¸' }} | Cloud Run HML |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ¥ Funcionalidades MÃ©dicas:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… LGPD Compliance verificado" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Protocolos mÃ©dicos validados" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Personas Dr. Gasnelio e GA" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Calculadoras de dosagem" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ¯ **Ambiente pronto para testes de homologaÃ§Ã£o!**" >> $GITHUB_STEP_SUMMARY