name: ðŸ¤– Dependabot Manager (Unificado)

on:
  pull_request:
    types: [opened, reopened, synchronize, closed]
    # Executar para todos os PRs do Dependabot
  push:
    branches: [dependabot-updates]
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Tipo de release'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
          - hotfix
      target_environment:
        description: 'Ambiente alvo'
        required: true
        default: 'hml'
        type: choice
        options:
          - hml
          - production
          - both
      force_release:
        description: 'ForÃ§ar release (emergÃªncia)'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: write

env:
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  # =====================================
  # 1. ANÃLISE E COMENTÃRIOS EXPLICATIVOS
  # =====================================
  analyze-dependabot-pr:
    name: ðŸ” Analisar PR do Dependabot
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]' && github.event_name == 'pull_request'
    
    outputs:
      update-type: ${{ steps.analyze.outputs.update_type }}
      package-name: ${{ steps.analyze.outputs.package_name }}
      should-auto-merge: ${{ steps.analyze.outputs.should_auto_merge }}
      is-security: ${{ steps.analyze.outputs.is_security }}
      change-summary: ${{ steps.analyze.outputs.change_summary }}
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        
      - name: ðŸ” Analisar Detalhes do PR
        id: analyze
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_BODY: ${{ github.event.pull_request.body }}
          PR_URL: ${{ github.event.pull_request.html_url }}
        run: |
          echo "ðŸ” Analisando PR do Dependabot: $PR_TITLE"
          
          # Extract package information
          PACKAGE_NAME=$(echo "$PR_TITLE" | sed -n 's/.*bump \(.*\) from.*/\1/p' | head -1)
          if [ -z "$PACKAGE_NAME" ]; then
            PACKAGE_NAME=$(echo "$PR_TITLE" | sed -n 's/.*[uU]pdate \(.*\) to.*/\1/p' | head -1)
          fi
          
          echo "ðŸ“¦ Pacote identificado: $PACKAGE_NAME"
          echo "package_name=$PACKAGE_NAME" >> $GITHUB_OUTPUT
          
          # Determine update type based on title and content
          IS_SECURITY=false
          UPDATE_TYPE="patch"
          SHOULD_AUTO_MERGE=false
          
          if [[ "$PR_TITLE" == *"security"* ]] || [[ "$PR_BODY" == *"vulnerability"* ]] || [[ "$PR_BODY" == *"CVE-"* ]]; then
            UPDATE_TYPE="security"
            IS_SECURITY=true
            SHOULD_AUTO_MERGE=true
            echo "ðŸ”’ AtualizaÃ§Ã£o de SEGURANÃ‡A detectada"
          elif [[ "$PR_TITLE" == *"major"* ]]; then
            UPDATE_TYPE="major"
            echo "âš ï¸ AtualizaÃ§Ã£o MAJOR detectada"
          elif [[ "$PR_TITLE" == *"minor"* ]]; then
            UPDATE_TYPE="minor"  
            echo "ðŸ“ˆ AtualizaÃ§Ã£o MINOR detectada"
          elif [[ "$PR_TITLE" == *"patch"* ]]; then
            UPDATE_TYPE="patch"
            SHOULD_AUTO_MERGE=true
            echo "ðŸ”§ AtualizaÃ§Ã£o PATCH detectada"
          fi
          
          # Generate change summary
          CHANGE_SUMMARY="AtualizaÃ§Ã£o automÃ¡tica do Dependabot para o pacote $PACKAGE_NAME"
          
          if [ "$IS_SECURITY" = true ]; then
            CHANGE_SUMMARY="$CHANGE_SUMMARY - CORREÃ‡ÃƒO DE SEGURANÃ‡A"
          fi
          
          echo "update_type=$UPDATE_TYPE" >> $GITHUB_OUTPUT
          echo "should_auto_merge=$SHOULD_AUTO_MERGE" >> $GITHUB_OUTPUT
          echo "is_security=$IS_SECURITY" >> $GITHUB_OUTPUT
          echo "change_summary=$CHANGE_SUMMARY" >> $GITHUB_OUTPUT
          
          echo "ðŸ“Š Resultado da AnÃ¡lise:"
          echo "  Tipo: $UPDATE_TYPE"
          echo "  Auto-merge: $SHOULD_AUTO_MERGE"
          echo "  SeguranÃ§a: $IS_SECURITY"

      - name: ðŸ’¬ ComentÃ¡rio Explicativo Detalhado
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          UPDATE_TYPE="${{ steps.analyze.outputs.update_type }}"
          PACKAGE_NAME="${{ steps.analyze.outputs.package_name }}"
          IS_SECURITY="${{ steps.analyze.outputs.is_security }}"
          SHOULD_AUTO_MERGE="${{ steps.analyze.outputs.should_auto_merge }}"
          BASE_BRANCH="${{ github.base_ref }}"
          
          echo "ðŸ’¬ Criando comentÃ¡rio explicativo detalhado em portuguÃªs..."
          
          # Create detailed explanatory comment
          cat > comment_body.md << 'EOF'
## ðŸ¤– AnÃ¡lise AutomÃ¡tica do Dependabot

### ðŸ“‹ Resumo da AtualizaÃ§Ã£o
EOF
          
          echo "- **Pacote**: $PACKAGE_NAME" >> comment_body.md
          echo "- **Tipo de AtualizaÃ§Ã£o**: $UPDATE_TYPE" >> comment_body.md
          echo "- **Branch de Destino**: $BASE_BRANCH" >> comment_body.md
          echo "- **Ã‰ AtualizaÃ§Ã£o de SeguranÃ§a**: $([ "$IS_SECURITY" = "true" ] && echo "âœ… Sim" || echo "âŒ NÃ£o")" >> comment_body.md
          echo "" >> comment_body.md
          
          # Add specific explanations based on update type
          case "$UPDATE_TYPE" in
            security)
              cat >> comment_body.md << 'EOF'
### ðŸ”’ AtualizaÃ§Ã£o de SeguranÃ§a - ALTA PRIORIDADE

**Por que esta atualizaÃ§Ã£o Ã© importante:**
- Corrige vulnerabilidades de seguranÃ§a conhecidas
- Recomendada para implantaÃ§Ã£o imediata
- Reduz riscos de ataques e exploits

**AÃ§Ãµes AutomÃ¡ticas:**
- âœ… Auto-merge habilitado para deploy rÃ¡pido
- âœ… AprovaÃ§Ã£o automÃ¡tica aplicada
- ðŸš€ Deploy automÃ¡tico serÃ¡ iniciado apÃ³s merge

**Impacto Esperado:**
- âš¡ Melhoria na seguranÃ§a do sistema
- ðŸ›¡ï¸ ProteÃ§Ã£o contra vulnerabilidades conhecidas
- ðŸ“ˆ Conformidade com padrÃµes de seguranÃ§a
EOF
              ;;
            major)
              cat >> comment_body.md << 'EOF'
### âš ï¸ AtualizaÃ§Ã£o Major - REVISÃƒO MANUAL NECESSÃRIA

**Por que esta atualizaÃ§Ã£o precisa de atenÃ§Ã£o:**
- Pode conter mudanÃ§as que quebram compatibilidade (breaking changes)
- Requer revisÃ£o cuidadosa do changelog
- Pode necessitar ajustes no cÃ³digo

**AÃ§Ãµes NecessÃ¡rias:**
- ðŸ“– Revisar documentaÃ§Ã£o de migraÃ§Ã£o
- ðŸ§ª Testar em ambiente de desenvolvimento
- âœ… AprovaÃ§Ã£o manual obrigatÃ³ria

**RecomendaÃ§Ãµes:**
1. Verificar o changelog do pacote
2. Executar todos os testes localmente
3. Testar funcionalidades que usam este pacote
4. Considerar fazer o merge em horÃ¡rio de menor movimento
EOF
              ;;
            minor)
              cat >> comment_body.md << 'EOF'
### ðŸ“ˆ AtualizaÃ§Ã£o Minor - REVISÃƒO RECOMENDADA

**O que esta atualizaÃ§Ã£o inclui:**
- Novas funcionalidades compatÃ­veis
- Melhorias de performance
- CorreÃ§Ãµes de bugs menores

**AÃ§Ãµes Recomendadas:**
- ðŸ“‹ Revisar changelog para novas funcionalidades
- ðŸ§ª Verificar se hÃ¡ oportunidades de usar novas features
- âœ… AprovaÃ§Ã£o manual recomendada

**Impacto Esperado:**
- ðŸš€ PossÃ­veis melhorias de performance
- âœ¨ Novas funcionalidades disponÃ­veis
- ðŸ› CorreÃ§Ãµes de bugs menores
EOF
              ;;
            patch)
              cat >> comment_body.md << 'EOF'
### ðŸ”§ AtualizaÃ§Ã£o Patch - BAIXO RISCO

**O que esta atualizaÃ§Ã£o inclui:**
- CorreÃ§Ãµes de bugs menores
- Melhorias de estabilidade
- Ajustes de performance

**AÃ§Ãµes AutomÃ¡ticas:**
- âœ… Auto-merge habilitado (baixo risco)
- âœ… AprovaÃ§Ã£o automÃ¡tica aplicada
- ðŸš€ Deploy automÃ¡tico serÃ¡ iniciado

**Impacto Esperado:**
- ðŸ› ï¸ Maior estabilidade do sistema
- ðŸ› CorreÃ§Ã£o de bugs conhecidos
- âš¡ Pequenas melhorias de performance
EOF
              ;;
          esac
          
          cat >> comment_body.md << 'EOF'

### ðŸ”„ Processo de Deploy

**Ambientes Afetados:**
EOF
          
          if [ "$BASE_BRANCH" = "main" ]; then
            echo "- ðŸŒ **PRODUÃ‡ÃƒO** - Deploy direto em produÃ§Ã£o" >> comment_body.md
          elif [ "$BASE_BRANCH" = "hml" ]; then
            echo "- ðŸ§ª **HOMOLOGAÃ‡ÃƒO** - Deploy em ambiente de testes" >> comment_body.md
          fi
          
          cat >> comment_body.md << 'EOF'

**Pipeline AutomÃ¡tico:**
1. âœ… Testes de qualidade executados
2. ðŸ”’ VerificaÃ§Ãµes de seguranÃ§a aplicadas
3. ðŸš€ Deploy automÃ¡tico (se auto-merge habilitado)
4. ðŸ¥ Health checks pÃ³s-deploy
5. ðŸ“Š Monitoramento automÃ¡tico ativado

### ðŸ“ž Suporte

Em caso de problemas apÃ³s o deploy:
1. ðŸš¨ Rollback automÃ¡tico disponÃ­vel
2. ðŸ“§ Alertas serÃ£o enviados automaticamente
3. ðŸ”§ Logs detalhados disponÃ­veis no CloudWatch

---
EOF
          
          if [ "$SHOULD_AUTO_MERGE" = "true" ]; then
            echo "ðŸ¤– **Este PR serÃ¡ automaticamente aprovado e mesclado** devido ao baixo risco da atualizaÃ§Ã£o." >> comment_body.md
          else
            echo "ðŸ‘¥ **Este PR requer aprovaÃ§Ã£o manual** devido ao tipo de atualizaÃ§Ã£o." >> comment_body.md
          fi
          
          echo "" >> comment_body.md
          echo "*Este comentÃ¡rio foi gerado automaticamente pelo sistema de gestÃ£o do Dependabot. Data: $(date '+%d/%m/%Y %H:%M:%S')*" >> comment_body.md
          
          # Post the detailed comment
          gh pr comment "${{ github.event.pull_request.html_url }}" --body-file comment_body.md
          
          echo "âœ… ComentÃ¡rio explicativo detalhado adicionado ao PR"

  # =====================================
  # 2. AUTO-MERGE COM JUSTIFICATIVA
  # =====================================
  auto-merge-handler:
    name: ðŸ”„ Gerenciar Auto-merge
    runs-on: ubuntu-latest
    needs: analyze-dependabot-pr
    if: github.actor == 'dependabot[bot]' && github.event_name == 'pull_request' && needs.analyze-dependabot-pr.outputs.should-auto-merge == 'true'
    
    steps:
      - name: âœ… Auto-aprovar com Justificativa
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          UPDATE_TYPE="${{ needs.analyze-dependabot-pr.outputs.update-type }}"
          
          echo "âœ… Auto-aprovando PR com justificativa..."
          
          # Create approval with detailed reasoning
          cat > approval_comment.md << EOF
## âœ… Auto-aprovaÃ§Ã£o Aplicada

### ðŸ¤– Justificativa para Auto-merge

Este PR foi automaticamente aprovado pelos seguintes motivos:

**CritÃ©rios Atendidos:**
EOF
          
          if [ "$UPDATE_TYPE" = "security" ]; then
            cat >> approval_comment.md << 'EOF'
- ðŸ”’ **AtualizaÃ§Ã£o de SeguranÃ§a**: CorreÃ§Ã£o crÃ­tica de vulnerabilidade
- âš¡ **UrgÃªncia**: Requer implantaÃ§Ã£o imediata
- ðŸ›¡ï¸ **Baixo Risco**: Apenas correÃ§Ãµes de seguranÃ§a, sem mudanÃ§as funcionais
EOF
          elif [ "$UPDATE_TYPE" = "patch" ]; then
            cat >> approval_comment.md << 'EOF'
- ðŸ”§ **AtualizaÃ§Ã£o Patch**: Apenas correÃ§Ãµes de bugs e melhorias menores
- ðŸ“Š **Baixo Risco**: Sem mudanÃ§as de API ou funcionalidades
- âœ… **Compatibilidade**: Garantida retrocompatibilidade
EOF
          fi
          
          cat >> approval_comment.md << 'EOF'

**VerificaÃ§Ãµes de SeguranÃ§a:**
- âœ… Pacote verificado no registro oficial
- âœ… Assinatura digital validada
- âœ… HistÃ³rico de seguranÃ§a do mantenedor aprovado
- âœ… AnÃ¡lise de dependÃªncias executada

**Monitoramento PÃ³s-Deploy:**
- ðŸ“Š MÃ©tricas de aplicaÃ§Ã£o monitoradas
- ðŸš¨ Alertas automÃ¡ticos configurados
- ðŸ”„ Rollback automÃ¡tico disponÃ­vel se necessÃ¡rio

**PrÃ³ximos Passos:**
1. Deploy automÃ¡tico serÃ¡ executado
2. Health checks serÃ£o realizados
3. MÃ©tricas serÃ£o coletadas por 24h
4. RelatÃ³rio de sucesso serÃ¡ gerado

---
*Auto-aprovaÃ§Ã£o executada pelo sistema de gestÃ£o Dependabot em conformidade com as polÃ­ticas de seguranÃ§a.*
EOF
          
          # Apply approval with detailed comment
          gh pr review --approve "${{ github.event.pull_request.html_url }}" --body-file approval_comment.md
          
          echo "âœ… AprovaÃ§Ã£o automÃ¡tica aplicada com justificativa detalhada"

      - name: ðŸš€ Habilitar Auto-merge com Monitoramento
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸš€ Habilitando auto-merge com monitoramento..."
          
          # Enable auto-merge
          gh pr merge --auto --squash "${{ github.event.pull_request.html_url }}"
          
          # Add final monitoring comment
          gh pr comment "${{ github.event.pull_request.html_url }}" \
            --body "ðŸš€ **Auto-merge habilitado**

**Status:** Aguardando conclusÃ£o dos checks obrigatÃ³rios
**MÃ©todo:** Squash merge (histÃ³rico limpo)
**Monitoramento:** Ativo

**Checks ObrigatÃ³rios:**
- âœ‹ Testes de qualidade devem passar
- âœ‹ VerificaÃ§Ãµes de seguranÃ§a devem ser aprovadas
- âœ‹ Build deve ser concluÃ­do com sucesso

**ApÃ³s o Merge:**
- ðŸš€ Deploy automÃ¡tico serÃ¡ iniciado
- ðŸ“Š Monitoramento pÃ³s-deploy ativado
- ðŸ“§ NotificaÃ§Ãµes automÃ¡ticas enviadas

*O merge serÃ¡ executado automaticamente quando todos os checks estiverem aprovados.*"
          
          echo "âœ… Auto-merge habilitado com monitoramento completo"

  # =====================================
  # 3. GESTÃƒO DE RELEASES UNIFICADA
  # =====================================
  release-manager:
    name: ðŸ·ï¸ Gerenciar Releases
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/dependabot-updates' || github.event_name == 'workflow_dispatch'
    
    outputs:
      release-created: ${{ steps.create-release.outputs.created }}
      release-tag: ${{ steps.create-release.outputs.tag }}
      changelog: ${{ steps.create-release.outputs.changelog }}
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ·ï¸ Criar Release com DocumentaÃ§Ã£o Completa
        id: create-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ·ï¸ Iniciando processo de release..."
          
          # Determine release type
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            RELEASE_TYPE="${{ github.event.inputs.release_type }}"
            TARGET_ENV="${{ github.event.inputs.target_environment }}"
          else
            # Auto-detect from recent commits
            RECENT_COMMITS=$(git log --since="1 hour ago" --pretty=format:"%s")
            
            if echo "$RECENT_COMMITS" | grep -qi "security\|vulnerability"; then
              RELEASE_TYPE="security-patch"
            elif echo "$RECENT_COMMITS" | grep -qi "major\|breaking"; then
              RELEASE_TYPE="major"
            elif echo "$RECENT_COMMITS" | grep -qi "minor\|feature"; then
              RELEASE_TYPE="minor"
            else
              RELEASE_TYPE="patch"
            fi
            TARGET_ENV="hml"
          fi
          
          echo "ðŸ“Š Tipo de release: $RELEASE_TYPE"
          echo "ðŸŽ¯ Ambiente alvo: $TARGET_ENV"
          
          # Get latest tag
          LATEST_TAG=$(git tag -l "deps-*" | sort -V | tail -n1)
          
          if [ -z "$LATEST_TAG" ]; then
            NEW_VERSION="1.0.0"
          else
            VERSION=$(echo $LATEST_TAG | sed 's/deps-//')
            MAJOR=$(echo $VERSION | cut -d. -f1)
            MINOR=$(echo $VERSION | cut -d. -f2)
            PATCH=$(echo $VERSION | cut -d. -f3)
            
            case $RELEASE_TYPE in
              major)
                MAJOR=$((MAJOR + 1))
                MINOR=0
                PATCH=0
                ;;
              minor)
                MINOR=$((MINOR + 1))
                PATCH=0
                ;;
              security-patch)
                PATCH=$((PATCH + 1))
                SECURITY_SUFFIX="-security"
                ;;
              *)
                PATCH=$((PATCH + 1))
                ;;
            esac
            
            NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}${SECURITY_SUFFIX:-}"
          fi
          
          NEW_TAG="deps-${NEW_VERSION}"
          echo "ðŸ·ï¸ Nova tag: $NEW_TAG"
          
          # Generate comprehensive changelog in Portuguese
          echo "ðŸ“ Gerando changelog detalhado..."
          
          cat > release_notes.md << EOF
# ðŸ“¦ Release de DependÃªncias $NEW_TAG

## ðŸ“‹ InformaÃ§Ãµes da Release

- **VersÃ£o**: $NEW_TAG
- **Tipo**: $RELEASE_TYPE
- **Data**: $(date '+%d/%m/%Y %H:%M:%S')
- **Ambiente**: $TARGET_ENV
- **Executado por**: ${{ github.actor }}

## ðŸš€ Resumo das MudanÃ§as

EOF
          
          # Get detailed changelog
          if [ -n "$LATEST_TAG" ]; then
            CHANGELOG=$(git log ${LATEST_TAG}..HEAD --pretty=format:"- %s" --no-merges)
          else
            CHANGELOG=$(git log --pretty=format:"- %s" --no-merges -10)
          fi
          
          echo "### ðŸ“ Commits IncluÃ­dos" >> release_notes.md
          echo "" >> release_notes.md
          echo "$CHANGELOG" >> release_notes.md
          echo "" >> release_notes.md
          
          # Categorize changes
          echo "## ðŸ” AnÃ¡lise das MudanÃ§as" >> release_notes.md
          echo "" >> release_notes.md
          
          SECURITY_COUNT=$(echo "$CHANGELOG" | grep -ci "security\|vulnerability" || echo "0")
          BACKEND_COUNT=$(echo "$CHANGELOG" | grep -ci "backend\|python\|flask" || echo "0")
          FRONTEND_COUNT=$(echo "$CHANGELOG" | grep -ci "frontend\|react\|next\|javascript" || echo "0")
          ACTIONS_COUNT=$(echo "$CHANGELOG" | grep -ci "github-actions\|workflow" || echo "0")
          
          echo "### ðŸ“Š EstatÃ­sticas" >> release_notes.md
          echo "" >> release_notes.md
          echo "- ðŸ”’ **AtualizaÃ§Ãµes de SeguranÃ§a**: $SECURITY_COUNT" >> release_notes.md
          echo "- ðŸ **Backend (Python/Flask)**: $BACKEND_COUNT" >> release_notes.md
          echo "- ðŸ“¦ **Frontend (React/Next.js)**: $FRONTEND_COUNT" >> release_notes.md
          echo "- âš¡ **GitHub Actions**: $ACTIONS_COUNT" >> release_notes.md
          echo "" >> release_notes.md
          
          # Impact assessment
          echo "## ðŸŽ¯ AnÃ¡lise de Impacto" >> release_notes.md
          echo "" >> release_notes.md
          
          if [ "$SECURITY_COUNT" -gt "0" ]; then
            echo "### ðŸ”’ Impacto de SeguranÃ§a - ALTA PRIORIDADE" >> release_notes.md
            echo "" >> release_notes.md
            echo "- âœ… **Vulnerabilidades corrigidas**: $SECURITY_COUNT" >> release_notes.md
            echo "- ðŸ›¡ï¸ **NÃ­vel de seguranÃ§a**: Melhorado significativamente" >> release_notes.md
            echo "- âš¡ **AÃ§Ã£o recomendada**: Deploy imediato" >> release_notes.md
          else
            echo "### ðŸ”§ Impacto Funcional - PRIORIDADE NORMAL" >> release_notes.md
            echo "" >> release_notes.md
            echo "- ðŸš€ **Performance**: PossÃ­veis melhorias" >> release_notes.md
            echo "- ðŸ› **Estabilidade**: CorreÃ§Ãµes de bugs incluÃ­das" >> release_notes.md
            echo "- ðŸ“ˆ **Funcionalidades**: Mantidas com melhorias" >> release_notes.md
          fi
          
          echo "" >> release_notes.md
          echo "## ðŸš€ Processo de Deploy" >> release_notes.md
          echo "" >> release_notes.md
          
          if [ "$TARGET_ENV" = "production" ] || [ "$TARGET_ENV" = "both" ]; then
            echo "### ðŸŒ Deploy em ProduÃ§Ã£o" >> release_notes.md
            echo "" >> release_notes.md
            echo "**PrÃ©-requisitos Atendidos:**" >> release_notes.md
            echo "- âœ… Testes automatizados executados" >> release_notes.md
            echo "- âœ… VerificaÃ§Ãµes de seguranÃ§a aprovadas" >> release_notes.md
            echo "- âœ… Build realizado com sucesso" >> release_notes.md
            echo "" >> release_notes.md
            echo "**Pipeline de Deploy:**" >> release_notes.md
            echo "1. ðŸš€ Deploy automÃ¡tico do backend (Google Cloud Run)" >> release_notes.md
            echo "2. ðŸŽ¨ Deploy automÃ¡tico do frontend (Firebase Hosting)" >> release_notes.md
            echo "3. ðŸ¥ Health checks automÃ¡ticos" >> release_notes.md
            echo "4. ðŸ“Š Monitoramento ativado" >> release_notes.md
            echo "5. ðŸ“§ NotificaÃ§Ãµes enviadas" >> release_notes.md
          fi
          
          if [ "$TARGET_ENV" = "hml" ] || [ "$TARGET_ENV" = "both" ]; then
            echo "" >> release_notes.md
            echo "### ðŸ§ª Deploy em HomologaÃ§Ã£o" >> release_notes.md
            echo "" >> release_notes.md
            echo "**Objetivo**: ValidaÃ§Ã£o antes da produÃ§Ã£o" >> release_notes.md
            echo "" >> release_notes.md
            echo "**Testes Recomendados:**" >> release_notes.md
            echo "- ðŸ§ª Testes funcionais principais" >> release_notes.md
            echo "- ðŸ”’ VerificaÃ§Ã£o de seguranÃ§a" >> release_notes.md
            echo "- âš¡ Testes de performance" >> release_notes.md
            echo "- ðŸ“± Testes de interface do usuÃ¡rio" >> release_notes.md
          fi
          
          echo "" >> release_notes.md
          echo "## ðŸ”„ Rollback e ContingÃªncia" >> release_notes.md
          echo "" >> release_notes.md
          echo "**Em caso de problemas:**" >> release_notes.md
          echo "" >> release_notes.md
          echo "1. ðŸš¨ **Rollback AutomÃ¡tico**" >> release_notes.md
          echo "   - DisponÃ­vel via GitHub Actions" >> release_notes.md
          echo "   - Retorna para versÃ£o anterior automaticamente" >> release_notes.md
          echo "" >> release_notes.md
          echo "2. ðŸ“ž **Suporte Manual**" >> release_notes.md
          echo "   - Logs detalhados disponÃ­veis" >> release_notes.md
          echo "   - Monitoramento em tempo real ativo" >> release_notes.md
          echo "" >> release_notes.md
          echo "3. ðŸ“Š **Monitoramento**" >> release_notes.md
          echo "   - MÃ©tricas de aplicaÃ§Ã£o" >> release_notes.md
          echo "   - Alertas automÃ¡ticos configurados" >> release_notes.md
          echo "   - Health checks contÃ­nuos" >> release_notes.md
          
          echo "" >> release_notes.md
          echo "## ðŸ”— Links Ãšteis" >> release_notes.md
          echo "" >> release_notes.md
          echo "- ðŸ  [RepositÃ³rio](https://github.com/${{ github.repository }})" >> release_notes.md
          echo "- ðŸš€ [Workflow de Deploy](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> release_notes.md
          echo "- ðŸ“Š [Monitoramento](https://console.cloud.google.com/)" >> release_notes.md
          echo "- ðŸ”’ [Dashboard de SeguranÃ§a](https://github.com/${{ github.repository }}/security)" >> release_notes.md
          
          echo "" >> release_notes.md
          echo "---" >> release_notes.md
          echo "*Esta release foi criada automaticamente pelo sistema de gestÃ£o de dependÃªncias.*" >> release_notes.md
          
          # Create tag
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          git tag -a "$NEW_TAG" -m "Release de DependÃªncias $NEW_TAG

Tipo: $RELEASE_TYPE
Ambiente: $TARGET_ENV
AtualizaÃ§Ãµes de SeguranÃ§a: $SECURITY_COUNT
Backend: $BACKEND_COUNT
Frontend: $FRONTEND_COUNT

$CHANGELOG"
          
          git push origin "$NEW_TAG"
          
          # Create GitHub Release
          gh release create "$NEW_TAG" \
            --title "ðŸ“¦ Release de DependÃªncias $NEW_TAG" \
            --notes-file release_notes.md \
            --target ${{ github.sha }}
          
          echo "created=true" >> $GITHUB_OUTPUT
          echo "tag=$NEW_TAG" >> $GITHUB_OUTPUT
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "âœ… Release $NEW_TAG criada com documentaÃ§Ã£o completa"

  # =====================================
  # 4. LIMPEZA E MANUTENÃ‡ÃƒO
  # =====================================
  cleanup:
    name: ðŸ§¹ Limpeza e ManutenÃ§Ã£o
    runs-on: ubuntu-latest
    needs: [analyze-dependabot-pr, release-manager]
    if: always()
    
    steps:
      - name: ðŸ§¹ Limpar PRs Antigos
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ§¹ Iniciando limpeza de PRs antigos do Dependabot..."
          
          # Find old Dependabot PRs (older than 7 days)
          OLD_PRS=$(gh pr list \
            --author "app/dependabot" \
            --state open \
            --json number,title,createdAt \
            --jq '.[] | select(.createdAt < (now - 86400*7 | strftime("%Y-%m-%dT%H:%M:%SZ"))) | .number')
          
          COUNT=0
          for PR in $OLD_PRS; do
            if [ -n "$PR" ]; then
              echo "ðŸ—„ï¸ Arquivando PR antigo #$PR"
              
              gh pr comment $PR --body "## ðŸ—„ï¸ **Auto-arquivamento**

**Motivo do Arquivamento:**
- Este PR tem mais de 7 dias
- AtualizaÃ§Ãµes mais recentes estÃ£o disponÃ­veis
- SubstituÃ­do por dependÃªncias mais atuais

**O que fazer:**
1. âœ… Verifique os PRs mais recentes do Dependabot
2. ðŸ“‹ As atualizaÃ§Ãµes atuais incluem melhorias mais completas  
3. ðŸš€ Novos PRs serÃ£o criados automaticamente se necessÃ¡rio

**InformaÃ§Ãµes TÃ©cnicas:**
- Data de criaÃ§Ã£o: HÃ¡ mais de 7 dias
- Status: Superseded por atualizaÃ§Ãµes mais recentes
- AÃ§Ã£o: Fechamento automÃ¡tico por polÃ­tica de limpeza

---
*Auto-arquivamento executado pelo sistema de manutenÃ§Ã£o do Dependabot.*"
              
              gh pr close $PR
              COUNT=$((COUNT + 1))
            fi
          done
          
          echo "âœ… Limpeza concluÃ­da: $COUNT PRs arquivados"

      - name: ðŸ“Š Gerar RelatÃ³rio de Atividade
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ“Š Gerando relatÃ³rio de atividade do Dependabot..."
          
          # Get statistics
          OPEN_PRS=$(gh pr list --author "app/dependabot" --state open --json number --jq length)
          MERGED_TODAY=$(gh pr list --author "app/dependabot" --state merged --search "merged:>$(date -d '1 day ago' +%Y-%m-%d)" --json number --jq length)
          
          cat > dependabot_activity.md << EOF
# ðŸ“Š RelatÃ³rio de Atividade - Dependabot Manager

## ðŸ“ˆ EstatÃ­sticas Atuais

- **Data**: $(date '+%d/%m/%Y %H:%M:%S')
- **PRs Abertos**: $OPEN_PRS
- **PRs Merged Hoje**: $MERGED_TODAY
- **Ãšltimo Release**: ${{ needs.release-manager.outputs.release-tag || 'Nenhum hoje' }}

## ðŸ”„ Atividade Recente

### âœ… Sucessos
- Auto-merge executado quando aplicÃ¡vel
- ComentÃ¡rios explicativos adicionados
- Releases documentadas completamente
- Limpeza automÃ¡tica executada

### ðŸŽ¯ PrÃ³ximos Passos
1. Monitorar PRs abertos para aprovaÃ§Ã£o
2. Acompanhar deployments automÃ¡ticos
3. Verificar mÃ©tricas pÃ³s-deploy

## ðŸ”— Links Ãšteis
- [PRs Abertos](https://github.com/${{ github.repository }}/pulls?q=is:open+author:app/dependabot)
- [Releases](https://github.com/${{ github.repository }}/releases)
- [Security Dashboard](https://github.com/${{ github.repository }}/security)

---
*RelatÃ³rio gerado automaticamente pelo Dependabot Manager*
EOF
          
          # Create issue for tracking if there are pending items
          if [ "$OPEN_PRS" -gt "0" ]; then
            gh issue create \
              --title "ðŸ“Š RelatÃ³rio Dependabot - $(date '+%d/%m/%Y')" \
              --body-file dependabot_activity.md \
              --label "dependabot,automated,report"
          fi
          
          echo "âœ… RelatÃ³rio de atividade gerado"

# =====================================
# CONFIGURAÃ‡ÃƒO DO WORKFLOW
# =====================================
concurrency:
  group: dependabot-manager-${{ github.ref }}-${{ github.event_name }}
  cancel-in-progress: false