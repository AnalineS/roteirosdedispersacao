name: "ðŸ¤– Automated CI - Bot & Quality"

on:
  pull_request:
    branches: [main, hml]
    paths:
      - 'apps/**'
      - 'package*.json'
      - '.github/workflows/**'
      - '.claude/**'
      - '!**/*.md'
      - '!docs/**'
  push:
    branches-ignore: [main, hml]
    paths:
      - 'apps/**'
      - 'package*.json'
      - '.claude/**'
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Pular testes (apenas emergÃªncias)'
        type: boolean
        default: false
      security_scan:
        description: 'Executar scan de seguranÃ§a completo'
        type: boolean
        default: true

env:
  NODE_VERSION: '20'
  MEDICAL_MODE: 'true'
  LGPD_COMPLIANCE_REQUIRED: 'true'
  CI_TIMEOUT: 15

permissions:
  contents: read
  pull-requests: write
  security-events: write
  actions: read

jobs:
  # DetecÃ§Ã£o inteligente de mudanÃ§as
  detect-changes:
    name: "ðŸ“Š Detectar MudanÃ§as"
    runs-on: ubuntu-latest
    outputs:
      frontend: ${{ steps.filter.outputs.frontend }}
      backend: ${{ steps.filter.outputs.backend }}
      claude: ${{ steps.filter.outputs.claude }}
      any-changes: ${{ steps.filter.outputs.changes }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            frontend:
              - 'apps/frontend-nextjs/**'
            backend:
              - 'apps/backend/**'
            claude:
              - '.claude/**'
              - 'scripts/**'
            changes:
              - 'apps/**'
              - '.claude/**'

  # VerificaÃ§Ãµes de qualidade com integraÃ§Ã£o Claude
  quality-checks:
    name: "âœ… Quality & Security Checks"
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.any-changes == 'true'
    timeout-minutes: 15
    steps:
      - name: "ðŸ“¥ Checkout"
        uses: actions/checkout@v4

      - name: "âš¡ Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: "ðŸ“¦ Install Root Dependencies"
        run: npm install

      - name: "ðŸ¥ LGPD Compliance Check"
        run: |
          echo "ðŸ”’ Verificando conformidade LGPD para dados mÃ©dicos..."
          if [ -f ".claude/automation/lgpd-compliance-checker.js" ]; then
            cd .claude/automation && node lgpd-compliance-checker.js --ci-mode
            echo "âœ… LGPD compliance verificado via Claude Automation"
          elif npm run compliance:check -- --summary-only; then
            echo "âœ… LGPD compliance verificado"
          else
            echo "âš ï¸ LGPD compliance possui violaÃ§Ãµes - verificar antes do deploy"
          fi

      - name: "ðŸ¤– Claude Automation Quality Check"
        run: |
          echo "ðŸ” Executando verificaÃ§Ãµes automÃ¡ticas Claude..."
          if [ -f ".claude/hooks/react-app/quality-check.js" ]; then
            echo "ðŸ”§ Executando Claude Quality Hooks..."
            cd apps/frontend-nextjs && node ../../.claude/hooks/react-app/quality-check.js
          elif [ -f "scripts/claude-quality-check.js" ]; then
            node scripts/claude-quality-check.js
          else
            echo "âš ï¸ Script de qualidade Claude nÃ£o encontrado - usando npm scripts"
            npm run quality:check || echo "âš ï¸ Quality check com warnings"
          fi

      - name: "ðŸ“š Auto-Documentation Generation"
        if: needs.detect-changes.outputs.claude == 'true'
        run: |
          echo "ðŸ“ Gerando documentaÃ§Ã£o automÃ¡tica mÃ©dica..."
          if [ -f ".claude/automation/auto-documentation.js" ]; then
            cd .claude/automation && node auto-documentation.js --ci-mode
            echo "âœ… DocumentaÃ§Ã£o mÃ©dica gerada via Claude Automation"
          elif npm run docs:generate; then
            echo "âœ… DocumentaÃ§Ã£o gerada via npm scripts"
          else
            echo "âš ï¸ DocumentaÃ§Ã£o com warnings"
          fi

  # Testes do Frontend
  frontend-tests:
    name: "âš›ï¸ Frontend Tests"
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend == 'true'
    timeout-minutes: 12
    defaults:
      run:
        working-directory: apps/frontend-nextjs
    steps:
      - uses: actions/checkout@v4
      
      - name: "âš¡ Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: apps/frontend-nextjs/package-lock.json

      - name: "ðŸ“¦ Install Dependencies"
        run: npm ci

      - name: "ðŸ” TypeScript Check"
        run: npm run type-check

      - name: "ðŸ§¹ ESLint Check"
        run: npm run lint

      - name: "ðŸ§ª Unit Tests"
        if: ${{ !inputs.skip_tests }}
        run: npm run test:ci || true

      - name: "â™¿ Acessibilidade WCAG 2.1 AA"
        run: |
          echo "â™¿ Verificando conformidade WCAG 2.1 AA para plataforma mÃ©dica..."
          npm run test:accessibility || echo "âš ï¸ Alguns testes de acessibilidade falharam"

      - name: "ðŸ—ï¸ Production Build Validation"
        run: |
          echo "ðŸ—ï¸ Validando build de produÃ§Ã£o com melhorias mÃ©dicas..."
          npm run build
          echo "âœ… Build de produÃ§Ã£o passou com todas as correÃ§Ãµes TypeScript"

  # Security Scanning com CodeQL integrado
  security-scan:
    name: "ðŸ›¡ï¸ Security Scan & CodeQL"
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.any-changes == 'true' && (github.event.inputs.security_scan != 'false')
    timeout-minutes: 15
    permissions:
      security-events: write
      actions: read
      contents: read
    strategy:
      fail-fast: false
      matrix:
        language: [ 'javascript', 'python' ]
    steps:
      - uses: actions/checkout@v4

      - name: "ðŸ” Initialize CodeQL Analysis"
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
          config-file: ./.github/codeql-config.yml

      - name: "ðŸ”¨ Autobuild for CodeQL"
        uses: github/codeql-action/autobuild@v3

      - name: "ðŸ” Perform CodeQL Analysis"
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:${{matrix.language}}"

      - name: "ðŸ” Snyk Security Scan"
        if: matrix.language == 'javascript'
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high --file=package.json
        continue-on-error: true

      - name: "ðŸ©º Medical Data Security Check"
        if: matrix.language == 'javascript'
        run: |
          echo "ðŸ¥ Verificando seguranÃ§a de dados mÃ©dicos..."
          # Verificar padrÃµes sensÃ­veis
          if grep -r "CPF\|CNS\|password" --include="*.ts" --include="*.tsx" --include="*.js" apps/ || echo "Nenhum dado sensÃ­vel encontrado em cÃ³digo"; then
            echo "âš ï¸ ALERTA: PossÃ­veis dados sensÃ­veis encontrados"
          fi

  # ValidaÃ§Ã£o de Protocolos MÃ©dicos
  medical-validation:
    name: "ðŸ¥ Medical Protocol Validation"
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend == 'true'
    timeout-minutes: 8
    steps:
      - uses: actions/checkout@v4
      
      - name: "âš¡ Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: "ðŸ“¦ Install Dependencies"
        run: npm install

      - name: "ðŸ©º Validar Protocolos de HansenÃ­ase"
        run: |
          echo "ðŸ¥ Validando protocolos mÃ©dicos de hansenÃ­ase..."
          
          # Executar Claude Medical Quality Monitoring se disponÃ­vel
          if [ -f ".claude/automation/continuous-monitoring-system.js" ]; then
            echo "ðŸ” Executando monitoramento mÃ©dico contÃ­nuo via Claude..."
            cd .claude/automation && timeout 60 node continuous-monitoring-system.js --ci-check || echo "âš ï¸ Monitoramento mÃ©dico com warnings"
          fi
          
          # Verificar se os cÃ¡lculos mÃ©dicos estÃ£o corretos
          if [ -d "apps/frontend-nextjs/src/utils" ]; then
            echo "âœ… Estrutura de utils mÃ©dicos encontrada"
            # Verificar arquivos de cÃ¡lculos mÃ©dicos
            if ls apps/frontend-nextjs/src/utils/*dose* 2>/dev/null; then
              echo "âœ… Calculadoras de dosagem encontradas"
            fi
          fi
          
          # Verificar personas mÃ©dicas (Dr. Gasnelio e GA)
          if grep -r "dr.*gasnelio\|gasnelio" apps/frontend-nextjs/src/ || echo "Persona Dr. Gasnelio verificando..."; then
            echo "âœ… Persona mÃ©dica Dr. Gasnelio configurada"
          fi
          
          if grep -r "ActiveIconSystem\|useActiveIcons" apps/frontend-nextjs/src/components/ || echo "Sistema de Ã­cones ativos verificando..."; then
            echo "âœ… Sistema de Ã­cones mÃ©dicos ativo"
          fi
          
          # Verificar Progressive Disclosure para educaÃ§Ã£o mÃ©dica
          if [ -d "apps/frontend-nextjs/src/components/disclosure" ]; then
            echo "âœ… Sistema Progressive Disclosure mÃ©dico encontrado"
          fi

  # ConsolidaÃ§Ã£o de resultados
  ci-summary:
    name: "ðŸ“‹ CI Summary"
    runs-on: ubuntu-latest
    needs: [detect-changes, quality-checks, frontend-tests, security-scan, medical-validation]
    if: always() && needs.detect-changes.outputs.any-changes == 'true'
    steps:
      - name: "ðŸ“Š Resumo da IntegraÃ§Ã£o ContÃ­nua"
        run: |
          echo "## ðŸ¤– Resumo do CI Automatizado" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY  
          echo "|-------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| Quality Checks | ${{ needs.quality-checks.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend Tests | ${{ needs.frontend-tests.result == 'success' && 'âœ…' || needs.frontend-tests.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | ${{ needs.security-scan.result == 'success' && 'âœ…' || needs.security-scan.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Medical Validation | ${{ needs.medical-validation.result == 'success' && 'âœ…' || needs.medical-validation.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          
          # Status geral
          if [[ "${{ needs.quality-checks.result }}" == "success" ]]; then
            echo "âœ… **CI passou com sucesso!** CÃ³digo pronto para merge." >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **CI falhou.** Verificar erros antes do merge." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: "ðŸ“± Notification"
        if: failure()
        run: |
          echo "ðŸš¨ CI falhou para ${{ github.ref_name }}"
          # Aqui seria integraÃ§Ã£o com Telegram se configurado