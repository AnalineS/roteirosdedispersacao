name: "ğŸš€ Production Deploy - ProduÃ§Ã£o"

on:
  push:
    branches: [main]
    paths:
      - 'apps/**'
      - 'package*.json'
      - '.github/workflows/**'
      - '.claude/**'
      - '!**/*.md'
      - '!docs/**'
  workflow_dispatch:
    inputs:
      skip_safety_checks:
        description: 'âš ï¸ Pular verificaÃ§Ãµes de seguranÃ§a (EMERGÃŠNCIA)'
        type: boolean
        default: false
      force_deploy:
        description: 'ğŸš¨ ForÃ§ar deploy (EMERGÃŠNCIA MÃ‰DICA)'
        type: boolean
        default: false
      deploy_frontend:
        description: 'Deploy frontend'
        type: boolean
        default: true
      deploy_backend:
        description: 'Deploy backend'
        type: boolean
        default: true
      create_release:
        description: 'Criar release'
        type: boolean
        default: true

env:
  NODE_VERSION: '20'
  ENVIRONMENT: 'production'
  PRODUCTION_DOMAIN: 'roteirosdispensacao.com.br'
  BACKEND_SERVICE: 'roteiro-dispensacao-api'
  MEDICAL_MODE: 'production'
  LGPD_COMPLIANCE_REQUIRED: 'strict'
  SLA_TARGET: '99.9'
  PRODUCTION_TIMEOUT: 30

permissions:
  contents: write
  id-token: write
  actions: read
  deployments: write

jobs:
  # Gate de seguranÃ§a crÃ­tica
  production-safety-gate:
    name: "ğŸ›¡ï¸ Production Safety Gate"
    runs-on: ubuntu-latest
    outputs:
      safety-approved: ${{ steps.safety-check.outputs.approved }}
      frontend-deploy: ${{ steps.deploy-decision.outputs.frontend }}
      backend-deploy: ${{ steps.deploy-decision.outputs.backend }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "ğŸ”’ Critical Safety Checks"
        id: safety-check
        if: ${{ !inputs.skip_safety_checks }}
        run: |
          echo "ğŸ›¡ï¸ Executando verificaÃ§Ãµes crÃ­ticas de seguranÃ§a para produÃ§Ã£o..."
          
          # Verificar se nÃ£o hÃ¡ dados de teste/desenvolvimento
          if grep -r -i "test\|dev\|staging" --include="*.env*" . 2>/dev/null; then
            echo "âŒ Dados de desenvolvimento encontrados!"
            echo "approved=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # Verificar se branch main estÃ¡ atualizada
          git fetch origin
          BEHIND=$(git rev-list --count HEAD..origin/main)
          if [ "$BEHIND" -gt 0 ]; then
            echo "âŒ Branch main nÃ£o estÃ¡ atualizada! $BEHIND commits atrÃ¡s."
            echo "approved=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "âœ… VerificaÃ§Ãµes de seguranÃ§a aprovadas"
          echo "approved=true" >> $GITHUB_OUTPUT

      - name: "âš ï¸ Emergency Override"
        if: ${{ inputs.skip_safety_checks }}
        run: |
          echo "ğŸš¨ ATENÃ‡ÃƒO: VerificaÃ§Ãµes de seguranÃ§a puladas por solicitaÃ§Ã£o manual!"
          echo "approved=true" >> $GITHUB_OUTPUT

      - name: "ğŸ“Š Deploy Decision"
        id: deploy-decision
        run: |
          # Detectar mudanÃ§as para decidir deploys
          if git diff --name-only HEAD~1 | grep -q "apps/frontend-nextjs/"; then
            echo "frontend=true" >> $GITHUB_OUTPUT
          else
            echo "frontend=${{ inputs.deploy_frontend }}" >> $GITHUB_OUTPUT
          fi
          
          if git diff --name-only HEAD~1 | grep -q "apps/backend/"; then
            echo "backend=true" >> $GITHUB_OUTPUT
          else
            echo "backend=${{ inputs.deploy_backend }}" >> $GITHUB_OUTPUT
          fi

  # ValidaÃ§Ãµes mÃ©dicas crÃ­ticas
  medical-compliance-validation:
    name: "ğŸ¥ Medical Compliance Validation"
    runs-on: ubuntu-latest
    needs: production-safety-gate
    if: needs.production-safety-gate.outputs.safety-approved == 'true'
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4

      - name: "âš¡ Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: "ğŸ“¦ Install Dependencies"
        run: npm install

      - name: "ğŸ”’ LGPD Strict Compliance"
        run: |
          echo "ğŸ”’ VerificaÃ§Ã£o ESTRITA de LGPD para produÃ§Ã£o..."
          if npm run compliance:check; then
            echo "âœ… LGPD compliance APROVADO para produÃ§Ã£o"
          else
            echo "âŒ LGPD compliance FALHOU - Deploy bloqueado!"
            exit 1
          fi

      - name: "ğŸ©º Medical Protocol Certification"
        run: |
          echo "ğŸ©º CertificaÃ§Ã£o de protocolos mÃ©dicos para produÃ§Ã£o..."
          cd apps/frontend-nextjs
          
          # Verificar compilaÃ§Ã£o TypeScript
          if npm run type-check; then
            echo "âœ… TypeScript medical types validated"
          else
            echo "âŒ TypeScript compilation failed"
            exit 1
          fi
          
          # Verificar calculadoras mÃ©dicas
          if ls src/components/interactive/DoseCalculator/ 2>/dev/null; then
            echo "âœ… Calculadoras mÃ©dicas encontradas"
          else
            echo "âŒ Calculadoras mÃ©dicas nÃ£o encontradas"
            exit 1
          fi
          
          # Verificar personas mÃ©dicas
          if grep -q "dr_gasnelio" src/data/personas.ts; then
            echo "âœ… Personas mÃ©dicas configuradas"
          else
            echo "âŒ Personas mÃ©dicas nÃ£o encontradas"
            exit 1
          fi

      - name: "â™¿ WCAG 2.1 AA Compliance"
        run: |
          echo "â™¿ VerificaÃ§Ã£o de acessibilidade WCAG 2.1 AA..."
          cd apps/frontend-nextjs
          if npm run test:accessibility || true; then
            echo "âœ… Acessibilidade verificada"
          fi

  # Deploy Frontend com Zero Downtime
  production-frontend-deploy:
    name: "ğŸŒ Production Frontend Deploy"
    runs-on: ubuntu-latest
    needs: [production-safety-gate, medical-compliance-validation]
    if: needs.production-safety-gate.outputs.frontend-deploy == 'true'
    timeout-minutes: 25
    defaults:
      run:
        working-directory: apps/frontend-nextjs
    steps:
      - uses: actions/checkout@v4

      - name: "âš¡ Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: apps/frontend-nextjs/package-lock.json

      - name: "ğŸ“¦ Install Dependencies"
        run: npm ci

      - name: "ğŸ—ï¸ Production Build"
        env:
          NODE_ENV: production
          NEXT_PUBLIC_ENVIRONMENT: production
          NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL }}
          NEXT_PUBLIC_FIREBASE_API_KEY: ${{ secrets.FIREBASE_API_KEY }}
          NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN: ${{ secrets.FIREBASE_AUTH_DOMAIN }}
          NEXT_PUBLIC_FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET: ${{ secrets.FIREBASE_STORAGE_BUCKET }}
          NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}
          NEXT_PUBLIC_FIREBASE_APP_ID: ${{ secrets.FIREBASE_APP_ID }}
          NEXT_PUBLIC_DOMAIN: ${{ env.PRODUCTION_DOMAIN }}
        run: |
          echo "ğŸ”¨ Building for production..."
          npm run build
          
          # Verificar build de produÃ§Ã£o
          if [ ! -d ".next" ]; then
            echo "âŒ Build failed!"
            exit 1
          fi
          
          echo "âœ… Production build completed"

      - name: "ğŸ” Pre-deploy Medical Validation"
        run: |
          echo "ğŸ©º ValidaÃ§Ã£o final antes do deploy de produÃ§Ã£o..."
          
          # Verificar se arquivos mÃ©dicos crÃ­ticos existem no build
          if find .next -name "*hanseniase*" -o -name "*calculat*" | grep -q .; then
            echo "âœ… ConteÃºdo mÃ©dico encontrado no build"
          else
            echo "âš ï¸ ConteÃºdo mÃ©dico pode estar ausente"
          fi
          
          # Verificar tamanho do build
          BUILD_SIZE=$(du -sh .next | cut -f1)
          echo "ğŸ“Š Tamanho do build: $BUILD_SIZE"

      - name: "ğŸš€ Deploy to Production (Firebase)"
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
          projectId: ${{ secrets.GCP_PROJECT_ID }}
          channelId: live
          target: prod
          entryPoint: apps/frontend-nextjs
        env:
          FIREBASE_CLI_EXPERIMENTS: webframeworks

  # Deploy Backend com Blue-Green
  production-backend-deploy:
    name: "ğŸ”§ Production Backend Deploy"
    runs-on: ubuntu-latest
    needs: [production-safety-gate, medical-compliance-validation]
    if: needs.production-safety-gate.outputs.backend-deploy == 'true'
    timeout-minutes: 25
    defaults:
      run:
        working-directory: apps/backend
    steps:
      - uses: actions/checkout@v4

      - name: "ğŸ” Debug Production Secrets"
        run: |
          echo "ğŸ” Verificando secrets de produÃ§Ã£o..."
          if [ -n "$GCP_SERVICE_ACCOUNT_KEY" ]; then
            echo "âœ… GCP_SERVICE_ACCOUNT_KEY disponÃ­vel (length: ${#GCP_SERVICE_ACCOUNT_KEY})"
          else
            echo "âŒ GCP_SERVICE_ACCOUNT_KEY nÃ£o configurado"
            exit 1
          fi
        env:
          GCP_SERVICE_ACCOUNT_KEY: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}

      - name: "ğŸ”‘ Google Cloud Auth"
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: "âš¡ Setup Cloud SDK"
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: "ğŸ” Verify Production Auth"
        run: |
          echo "ğŸ” Verificando autenticaÃ§Ã£o de produÃ§Ã£o..."
          gcloud auth list
          gcloud config get-value project

      - name: "ğŸ³ Build Production Image"
        run: |
          echo "ğŸ”¨ Building production backend image..."
          cd apps/backend
          gcloud builds submit --tag gcr.io/${{ env.PROJECT_ID }}/${{ env.BACKEND_SERVICE }}:${{ github.sha }} .

      - name: "ğŸ”„ Blue-Green Deploy"
        run: |
          echo "ğŸ”„ Executando deploy blue-green..."
          
          # Deploy nova versÃ£o sem trÃ¡fego
          gcloud run deploy ${{ env.BACKEND_SERVICE }}-green \
            --image gcr.io/${{ secrets.GCP_PROJECT_ID }}/${{ env.BACKEND_SERVICE }}:${{ github.sha }} \
            --platform managed \
            --region ${{ secrets.GCP_REGION }} \
            --no-traffic \
            --tag green \
            --timeout=900 \
            --memory=2Gi \
            --cpu=2 \
            --max-instances=50 \
            --min-instances=2 \
            --set-env-vars "ENVIRONMENT=production,LGPD_MODE=strict,SLA_TARGET=${{ env.SLA_TARGET }},PROJECT_ID=${{ secrets.GCP_PROJECT_ID }}"
          
          echo "âœ… VersÃ£o green deployada"

      - name: "ğŸ©º Health Check Green Version"
        run: |
          echo "ğŸ” Verificando saÃºde da versÃ£o green..."
          GREEN_URL=$(gcloud run services describe ${{ env.BACKEND_SERVICE }}-green --region=${{ env.REGION }} --format='value(status.url)')
          
          # Aguardar inicializaÃ§Ã£o
          sleep 60
          
          # Health check
          if curl -f -s "$GREEN_URL/health" > /dev/null; then
            echo "âœ… VersÃ£o green estÃ¡ saudÃ¡vel"
          else
            echo "âŒ VersÃ£o green falhou no health check"
            exit 1
          fi

      - name: "ğŸ”„ Switch Traffic"
        run: |
          echo "ğŸ”„ Direcionando trÃ¡fego para versÃ£o green..."
          gcloud run services update-traffic ${{ env.BACKEND_SERVICE }} \
            --to-tags green=100 \
            --region ${{ env.REGION }}
          
          echo "âœ… TrÃ¡fego direcionado para nova versÃ£o"

  # Monitoramento pÃ³s-deploy crÃ­tico
  production-monitoring:
    name: "ğŸ“Š Production Critical Monitoring"
    runs-on: ubuntu-latest
    needs: [production-frontend-deploy, production-backend-deploy]
    if: always() && (needs.production-frontend-deploy.result == 'success' || needs.production-backend-deploy.result == 'success')
    timeout-minutes: 10
    steps:
      - name: "ğŸŒ Production Health Verification"
        run: |
          echo "ğŸ” Verificando saÃºde da produÃ§Ã£o..."
          
          # Verificar frontend
          if curl -f -s "https://${{ env.PRODUCTION_DOMAIN }}" > /dev/null; then
            echo "âœ… Frontend produÃ§Ã£o respondendo"
          else
            echo "âŒ Frontend produÃ§Ã£o com problemas!"
            exit 1
          fi
          
          # Aguardar propagaÃ§Ã£o
          sleep 30

      - name: "ğŸ¥ Critical Medical Endpoints Check"
        run: |
          echo "ğŸ©º Verificando endpoints mÃ©dicos crÃ­ticos..."
          
          DOMAIN="https://${{ env.PRODUCTION_DOMAIN }}"
          CRITICAL_ENDPOINTS=(
            "/modules/hanseniase"
            "/resources/calculator" 
            "/chat"
            "/modules/tratamento"
          )
          
          for endpoint in "${CRITICAL_ENDPOINTS[@]}"; do
            if curl -f -s "$DOMAIN$endpoint" > /dev/null; then
              echo "âœ… Endpoint crÃ­tico $endpoint OK"
            else
              echo "âŒ Endpoint crÃ­tico $endpoint com problemas!"
              exit 1
            fi
          done

      - name: "ğŸ“ˆ Setup Production Monitoring"
        run: |
          echo "ğŸ“Š Configurando monitoramento de produÃ§Ã£o..."
          echo "ğŸ¯ SLA Target: ${{ env.SLA_TARGET }}%"
          echo "ğŸ” Endpoints monitorados:"
          echo "  - Frontend: https://${{ env.PRODUCTION_DOMAIN }}"
          echo "  - APIs mÃ©dicas crÃ­ticas"
          echo "  - Calculadoras de dosagem"
          echo "  - Sistema de personas (Dr. Gasnelio, GA)"

  # Sistema de rollback automÃ¡tico
  production-rollback-system:
    name: "ğŸ”„ Rollback System Setup"
    runs-on: ubuntu-latest
    needs: [production-monitoring]
    if: failure()
    steps:
      - name: "ğŸš¨ Automatic Rollback Trigger"
        run: |
          echo "ğŸš¨ FALHA DETECTADA - Preparando rollback automÃ¡tico..."
          echo "ğŸ”„ Sistema de rollback serÃ¡ ativado"
          # Aqui seria implementado o rollback automÃ¡tico real

  # IntegraÃ§Ã£o com Claude Automation System para releases
  trigger-claude-release:
    name: "ğŸ¤– Trigger Claude Release System"
    runs-on: ubuntu-latest
    needs: [production-monitoring]
    if: success() && inputs.create_release == true
    steps:
      - uses: actions/checkout@v4

      - name: "ğŸ¤– Trigger Claude Automation Release"
        run: |
          echo "ğŸ¤– Acionando Claude Automation System para criar release..."
          
          # Trigger workflow via GitHub API
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "${{ github.api_url }}/repos/${{ github.repository }}/actions/workflows/claude-automation-system.yml/dispatches" \
            -d '{
              "ref": "main",
              "inputs": {
                "force_release": "true",
                "release_type": "minor",
                "documentation_only": "false"
              }
            }'
          
          echo "âœ… Claude Automation System acionado para criar release automÃ¡tico"
          echo "ğŸ“Š O sistema irÃ¡ analisar mudanÃ§as e criar release inteligente"
          echo "ğŸ“± NotificaÃ§Ãµes serÃ£o enviadas automaticamente"

      - name: "ğŸ“‹ Production Release Summary"
        run: |
          echo "## ğŸ¥ Production Deploy & Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸš€ Deploy Status:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Deploy de produÃ§Ã£o concluÃ­do com sucesso" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… SLA ${{ env.SLA_TARGET }}% ativo" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Monitoramento em operaÃ§Ã£o" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ¤– Release Automation:" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ”„ Claude Automation System acionado" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“Š AnÃ¡lise inteligente de mudanÃ§as em andamento" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“± NotificaÃ§Ãµes automÃ¡ticas configuradas" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“š DocumentaÃ§Ã£o serÃ¡ gerada automaticamente" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ¥ Medical Platform Status:" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸŒ **ProduÃ§Ã£o**: https://${{ env.PRODUCTION_DOMAIN }}" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ”’ **LGPD**: Conformidade estrita ativa" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ©º **Protocolos**: MinistÃ©rio da SaÃºde validados" >> $GITHUB_STEP_SUMMARY
          echo "- â™¿ **Acessibilidade**: WCAG 2.1 AA mantida" >> $GITHUB_STEP_SUMMARY

  # Resumo final do deploy
  production-deploy-summary:
    name: "ğŸ“‹ Production Deploy Summary"
    runs-on: ubuntu-latest
    needs: [production-monitoring, trigger-claude-release]
    if: always()
    steps:
      - name: "âœ… Deploy Summary"
        run: |
          echo "## ğŸš€ Deploy de ProduÃ§Ã£o ConcluÃ­do" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ¯ Status do Deploy:" >> $GITHUB_STEP_SUMMARY
          echo "| Componente | Status | URL |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | ${{ needs.production-frontend-deploy.result == 'success' && 'âœ… Sucesso' || needs.production-frontend-deploy.result == 'skipped' && 'â­ï¸ Pulado' || 'âŒ Falhou' }} | https://${{ env.PRODUCTION_DOMAIN }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend | ${{ needs.production-backend-deploy.result == 'success' && 'âœ… Sucesso' || needs.production-backend-deploy.result == 'skipped' && 'â­ï¸ Pulado' || 'âŒ Falhou' }} | Cloud Run Prod |" >> $GITHUB_STEP_SUMMARY
          echo "| Monitoring | ${{ needs.production-monitoring.result == 'success' && 'âœ… Ativo' || 'âŒ Problema' }} | Dashboards Ativos |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ¥ Conformidade MÃ©dica:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… LGPD: Conformidade estrita aplicada" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… SLA: Meta de ${{ env.SLA_TARGET }}% configurada" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Acessibilidade: WCAG 2.1 AA verificada" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… SeguranÃ§a: ValidaÃ§Ãµes crÃ­ticas aprovadas" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ‰ **Plataforma mÃ©dica de hansenÃ­ase estÃ¡ em produÃ§Ã£o e operacional!**" >> $GITHUB_STEP_SUMMARY

      - name: "ğŸ“± Success Notification"
        if: success()
        run: |
          echo "ğŸ‰ Deploy de produÃ§Ã£o realizado com sucesso!"
          echo "ğŸŒ Site: https://${{ env.PRODUCTION_DOMAIN }}"
          echo "ğŸ¥ Plataforma mÃ©dica operacional"