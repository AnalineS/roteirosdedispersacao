name: "ğŸš€ Production Deploy - ProduÃ§Ã£o"

on:
  # Disabled - keeping only Dependabot workflows active
  # push:
  #   branches: [main]
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Pular testes (apenas emergÃªncias)'
        type: boolean
        default: false
      force_deploy:
        description: 'ForÃ§ar deploy mesmo com falhas'
        type: boolean
        default: false
      deploy_frontend:
        description: 'Deploy frontend'
        type: boolean
        default: true
      deploy_backend:
        description: 'Deploy backend'
        type: boolean
        default: true

env:
  NODE_VERSION: '20'
  ENVIRONMENT: 'production'
  FRONTEND_SITE: 'roteiros-de-dispensacao'
  BACKEND_SERVICE: 'roteiro-dispensacao-api'
  GCP_PROJECT_ID: 'red-truck-468923-s4'
  GCP_REGION: 'us-central1'
  MEDICAL_MODE: 'true'
  LGPD_COMPLIANCE_REQUIRED: 'true'
  PRODUCTION_TIMEOUT: 90

permissions:
  contents: read
  id-token: write
  actions: read

jobs:
  # PreparaÃ§Ã£o e validaÃ§Ã£o para produÃ§Ã£o
  production-preparation:
    name: "ğŸ”§ Production Preparation"
    runs-on: ubuntu-latest
    outputs:
      frontend-changed: ${{ steps.filter.outputs.frontend }}
      backend-changed: ${{ steps.filter.outputs.backend }}
      claude-changed: ${{ steps.filter.outputs.claude }}
      deploy-frontend: ${{ steps.deploy-config.outputs.frontend }}
      deploy-backend: ${{ steps.deploy-config.outputs.backend }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "ğŸš« Block Non-Main Branch Execution"
        if: ${{ github.ref_name != 'main' }}
        run: |
          echo "âŒ BLOQUEIO: Este workflow sÃ³ deve executar na branch 'main'"
          echo "Branch atual: ${{ github.ref_name }}"
          echo "Este workflow foi disparado incorretamente e serÃ¡ encerrado."
          exit 1

      - name: "ğŸ›¡ï¸ Production Safety Check"
        run: |
          echo "ğŸ›¡ï¸ VerificaÃ§Ãµes de seguranÃ§a para produÃ§Ã£o..."
          echo "ğŸ¯ Branch: ${{ github.ref_name }}"
          echo "ğŸ‘¤ Autor: ${{ github.actor }}"
          echo "ğŸ“ Commit: ${{ github.sha }}"

          # Verificar se nÃ£o Ã© um commit de emergÃªncia
          if git log -1 --pretty=%B | grep -i "emergency\|hotfix\|urgent"; then
            echo "ğŸš¨ Deploy de emergÃªncia detectado"
            echo "âš ï¸ Prosseguindo com validaÃ§Ãµes mÃ­nimas"
          else
            echo "âœ… Deploy regular - validaÃ§Ãµes completas"
          fi

      - name: "ğŸ“Š Detectar mudanÃ§as"
        uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            frontend:
              - 'apps/frontend-nextjs/**'
            backend:
              - 'apps/backend/**'
            claude:
              - '.claude/**'
              - 'scripts/**'

      - name: "âš™ï¸ Configurar deploys"
        id: deploy-config
        run: |
          # LÃ³gica de deploy baseada em mudanÃ§as ou inputs manuais
          if [[ "${{ github.event.inputs.deploy_frontend }}" == "true" ]] || [[ "${{ steps.filter.outputs.frontend }}" == "true" ]]; then
            echo "frontend=true" >> $GITHUB_OUTPUT
          else
            echo "frontend=false" >> $GITHUB_OUTPUT
          fi

          if [[ "${{ github.event.inputs.deploy_backend }}" == "true" ]] || [[ "${{ steps.filter.outputs.backend }}" == "true" ]]; then
            echo "backend=true" >> $GITHUB_OUTPUT
          else
            echo "backend=false" >> $GITHUB_OUTPUT
          fi

  # ValidaÃ§Ã£o completa de secrets para produÃ§Ã£o
  secrets-validation:
    name: "ğŸ” Production Secrets & Connectivity"
    runs-on: ubuntu-latest
    needs: production-preparation
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "ğŸ” Validate Production Secrets"
        run: |
          echo "ğŸ” Validando secrets obrigatÃ³rios para PRODUÃ‡ÃƒO..."

          # Secrets obrigatÃ³rios para produÃ§Ã£o
          REQUIRED_SECRETS=(
            "GCP_SERVICE_ACCOUNT_KEY"
            "GCP_PROJECT_ID"
            "GCP_REGION"
            "OPENROUTER_API_KEY"
            "SECRET_KEY"
          )

          MISSING_SECRETS=()

          for secret in "${REQUIRED_SECRETS[@]}"; do
            case $secret in
              "GCP_SERVICE_ACCOUNT_KEY")
                if [ -z "${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}" ]; then
                  MISSING_SECRETS+=("$secret")
                else
                  echo "âœ… $secret disponÃ­vel"
                fi
                ;;
              "GCP_PROJECT_ID")
                if [ -z "${{ vars.GCP_PROJECT_ID }}" ]; then
                  MISSING_SECRETS+=("$secret")
                else
                  echo "âœ… $secret: ${{ vars.GCP_PROJECT_ID }}"
                fi
                ;;
              "GCP_REGION")
                if [ -z "${{ vars.GCP_REGION }}" ]; then
                  MISSING_SECRETS+=("$secret")
                else
                  echo "âœ… $secret: ${{ vars.GCP_REGION }}"
                fi
                ;;
              "OPENROUTER_API_KEY")
                if [ -z "${{ secrets.OPENROUTER_API_KEY }}" ]; then
                  MISSING_SECRETS+=("$secret")
                else
                  echo "âœ… $secret disponÃ­vel"
                fi
                ;;
              "SECRET_KEY")
                if [ -z "${{ secrets.SECRET_KEY }}" ]; then
                  MISSING_SECRETS+=("$secret")
                else
                  echo "âœ… $secret disponÃ­vel"
                fi
                ;;
            esac
          done

          if [ ${#MISSING_SECRETS[@]} -ne 0 ]; then
            echo "âŒ Secrets obrigatÃ³rios ausentes para PRODUÃ‡ÃƒO:"
            printf '  - %s\n' "${MISSING_SECRETS[@]}"
            exit 1
          fi

          echo "âœ… Todos os secrets obrigatÃ³rios estÃ£o disponÃ­veis para produÃ§Ã£o"

      - name: "ğŸ“‹ Validate Production Variables"
        run: |
          echo "ğŸ“‹ Validando GitHub Variables para PRODUÃ‡ÃƒO Cloud Run..."

          # Variables obrigatÃ³rias para Cloud Run apenas
          REQUIRED_VARS=(
            "NEXT_PUBLIC_API_URL_PRODUCTION"
            "GCP_PROJECT_ID"
            "GCP_REGION"
          )

          MISSING_VARS=()

          for var_name in "${REQUIRED_VARS[@]}"; do
            case $var_name in
              "NEXT_PUBLIC_API_URL_PRODUCTION")
                if [ -z "${{ vars.NEXT_PUBLIC_API_URL_PRODUCTION }}" ]; then
                  MISSING_VARS+=("$var_name")
                else
                  echo "âœ… $var_name: ${{ vars.NEXT_PUBLIC_API_URL_PRODUCTION }}"
                fi
                ;;
              "GCP_PROJECT_ID")
                if [ -z "${{ vars.GCP_PROJECT_ID }}" ]; then
                  MISSING_VARS+=("$var_name")
                else
                  echo "âœ… $var_name: ${{ vars.GCP_PROJECT_ID }}"
                fi
                ;;
              "GCP_REGION")
                if [ -z "${{ vars.GCP_REGION }}" ]; then
                  MISSING_VARS+=("$var_name")
                else
                  echo "âœ… $var_name: ${{ vars.GCP_REGION }}"
                fi
                ;;
            esac
          done

          if [ ${#MISSING_VARS[@]} -ne 0 ]; then
            echo "âŒ GitHub Variables obrigatÃ³rias ausentes para PRODUÃ‡ÃƒO:"
            printf '  - %s\n' "${MISSING_VARS[@]}"
            exit 1
          fi

          echo "âœ… Todas as GitHub Variables obrigatÃ³rias estÃ£o disponÃ­veis para produÃ§Ã£o Cloud Run"

      - name: "ğŸ”— Test Production Cloud Run Connectivity"
        run: |
          echo "â˜ï¸ Testando conectividade Cloud Run para PRODUÃ‡ÃƒO..."

          # Criar arquivo temporÃ¡rio de credenciais
          echo '${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}' > /tmp/gcp-key.json
          export GOOGLE_APPLICATION_CREDENTIALS="/tmp/gcp-key.json"

          # Testar autenticaÃ§Ã£o GCP
          if gcloud auth activate-service-account --key-file=/tmp/gcp-key.json >/dev/null 2>&1; then
            echo "âœ… GCP authentication successful para produÃ§Ã£o"
          else
            echo "âŒ GCP authentication failed para produÃ§Ã£o"
            exit 1
          fi

          # Testar acesso Cloud Run especificamente
          echo "ğŸš€ Validando acesso ao Cloud Run em produÃ§Ã£o..."
          if gcloud run services list --region=${{ vars.GCP_REGION }} --project=${{ vars.GCP_PROJECT_ID }} >/dev/null 2>&1; then
            echo "âœ… Cloud Run production validated - arquitetura 100% Cloud Run"
          else
            echo "âŒ Cloud Run access failed"
            exit 1
          fi

          # Cleanup
          rm -f /tmp/gcp-key.json
          echo "ğŸ§¹ Credenciais temporÃ¡rias removidas"

  # AnÃ¡lise de SeguranÃ§a CrÃ­tica para ProduÃ§Ã£o
  production-security-analysis:
    name: "ğŸ”’ Production Security Analysis"
    runs-on: ubuntu-latest
    needs: [production-preparation, secrets-validation]
    timeout-minutes: 45
    permissions:
      security-events: write
      actions: read
      contents: read
    strategy:
      fail-fast: true
      matrix:
        language: ['javascript', 'python']
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "ğŸ” Initialize Production CodeQL"
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
          config-file: ./.github/codeql-config.yml
          queries: security-extended,security-and-quality

      - name: "âš¡ Setup Environment"
        if: matrix.language == 'javascript'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: "ğŸ Setup Python"
        if: matrix.language == 'python'
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: "ğŸ“¦ Install Dependencies"
        run: |
          if [[ "${{ matrix.language }}" == "javascript" ]]; then
            echo "ğŸ“¦ Installing JS/TS dependencies..."
            npm install
            cd apps/frontend-nextjs && npm ci
          elif [[ "${{ matrix.language }}" == "python" ]]; then
            echo "ğŸ“¦ Installing Python dependencies..."
            cd apps/backend && pip install -r requirements.txt
          fi

      - name: "ğŸ”¨ Autobuild for CodeQL"
        uses: github/codeql-action/autobuild@v3

      - name: "ğŸ” Perform Production CodeQL Analysis"
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:${{ matrix.language }}"
          output: sarif-results
          upload: true

      - name: "ğŸ¥ Critical Medical Security Validation"
        if: matrix.language == 'javascript'
        run: |
          echo "ğŸ©º Executando validaÃ§Ã£o CRÃTICA de seguranÃ§a mÃ©dica para PRODUÃ‡ÃƒO..."

          # Verificar padrÃµes sensÃ­veis em arquivos
          echo "ğŸ” Verificando dados sensÃ­veis em cÃ³digo..."
          SENSITIVE_PATTERNS=(
            "CPF.*[0-9]{11}"
            "CNS.*[0-9]{15}"
            "CRM.*[0-9]+"
            "password.*=.*[\"'].*[\"']"
            "api_key.*=.*[\"'].*[\"']"
            "secret_key.*=.*[\"'].*[\"']"
            "console\.log.*password"
            "console\.log.*secret"
            "console\.log.*key"
          )

          VIOLATIONS_FOUND=false
          for pattern in "${SENSITIVE_PATTERNS[@]}"; do
            if find apps/ -name "*.ts" -o -name "*.tsx" -o -name "*.js" -o -name "*.py" | xargs grep -l "$pattern" 2>/dev/null; then
              echo "ğŸš¨ ALERTA CRÃTICO: PadrÃ£o sensÃ­vel detectado: $pattern"
              VIOLATIONS_FOUND=true
            fi
          done

          if [[ "$VIOLATIONS_FOUND" == "true" ]]; then
            echo "âŒ VIOLAÃ‡Ã•ES CRÃTICAS de seguranÃ§a mÃ©dica encontradas!"
            echo "::error::Critical security violations detected for production"
            exit 1
          else
            echo "âœ… Nenhum dado mÃ©dico sensÃ­vel detectado no cÃ³digo"
          fi

  # Build e Deploy Frontend para ProduÃ§Ã£o
  frontend-production-deploy:
    name: "âš›ï¸ Frontend Production Deploy"
    runs-on: ubuntu-latest
    needs: [production-preparation, production-security-analysis, backend-production-deploy]
    if: needs.production-preparation.outputs.deploy-frontend == 'true' && (needs.backend-production-deploy.result == 'success' || needs.backend-production-deploy.result == 'skipped')
    timeout-minutes: 20
    defaults:
      run:
        working-directory: apps/frontend-nextjs
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "âš¡ Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: apps/frontend-nextjs/package-lock.json

      - name: "ğŸ“¦ Install Dependencies"
        run: npm ci

      - name: "ğŸ—ï¸ Build for Production"
        env:
          NODE_ENV: production
          NEXT_PUBLIC_ENVIRONMENT: production
          NEXT_PUBLIC_BACKEND_URL: ${{ vars.NEXT_PUBLIC_API_URL_PRODUCTION }}
          NEXT_PUBLIC_GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
        run: |
          echo "ğŸ”¨ Building for PRODUCTION environment..."
          npm run build

      - name: "ğŸ” Production Build Validation"
        run: |
          echo "ğŸ”¨ Validando build de produÃ§Ã£o..."

          # Verificar se o build standalone foi gerado
          if [ -d ".next/standalone" ]; then
            echo "âœ… Build standalone gerado com sucesso"
            echo "ğŸ“ ConteÃºdo da pasta standalone:"
            ls -la .next/standalone/
          else
            echo "âŒ Pasta .next/standalone nÃ£o encontrada"
            echo "ğŸ“ ConteÃºdo atual de .next:"
            ls -la .next/ || echo "Pasta .next nÃ£o existe"
            exit 1
          fi

          # Verificar se server.js existe
          if [ -f ".next/standalone/apps/frontend-nextjs/server.js" ]; then
            echo "âœ… server.js encontrado"
          else
            echo "âŒ server.js nÃ£o encontrado na pasta correta"
            exit 1
          fi

          # Verificar estrutura de pÃ¡ginas
          if [ -d ".next/standalone/apps/frontend-nextjs/.next" ]; then
            echo "âœ… Estrutura Next.js preservada no standalone"
          else
            echo "âŒ Estrutura Next.js nÃ£o encontrada no standalone"
            exit 1
          fi

          # Verificar tamanho do build
          BUILD_SIZE=$(du -sh .next/standalone | cut -f1)
          echo "ğŸ“Š Tamanho do build de produÃ§Ã£o: $BUILD_SIZE"

      - name: "ğŸ”‘ Google Cloud Auth"
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
          project_id: ${{ vars.GCP_PROJECT_ID }}

      - name: "âš¡ Setup Cloud SDK"
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ vars.GCP_PROJECT_ID }}

      - name: "ğŸ³ Build and Deploy Frontend to Cloud Run (Production)"
        working-directory: apps/frontend-nextjs
        run: |
          echo "ğŸ”¨ Building frontend para PRODUÃ‡ÃƒO..."
          echo "â° Timestamp inÃ­cio: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ğŸš€ Deploy Cloud Run Frontend - standalone Next.js"

          # Verificar Dockerfile
          if [ -f "Dockerfile" ]; then
            echo "âœ… Dockerfile encontrado"
            echo "ğŸ“‹ Tamanho do Dockerfile: $(wc -l < Dockerfile) linhas"
          else
            echo "âŒ Dockerfile nÃ£o encontrado"
            exit 1
          fi

          # Build para produÃ§Ã£o com cache otimizado
          BUILD_START=$(date +%s)

          gcloud builds submit --tag us-central1-docker.pkg.dev/red-truck-468923-s4/hml-roteiro-dispensacao/roteiro-dispensacao-frontend \
            --timeout=1800s \
            --machine-type=e2-highcpu-4 \
            --disk-size=50GB \
            --verbosity=info .

          BUILD_END=$(date +%s)
          BUILD_DURATION=$((BUILD_END - BUILD_START))
          echo "â±ï¸ Tempo de build: ${BUILD_DURATION}s ($(($BUILD_DURATION / 60))m $(($BUILD_DURATION % 60))s)"

          echo "ğŸš€ Deploying to Production Cloud Run..."
          echo "â° Timestamp deploy: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          gcloud run deploy roteiro-dispensacao-frontend \
            --image us-central1-docker.pkg.dev/red-truck-468923-s4/hml-roteiro-dispensacao/roteiro-dispensacao-frontend \
            --platform managed \
            --region us-central1 \
            --port 8080 \
            --memory 1Gi \
            --cpu 1 \
            --max-instances 10 \
            --allow-unauthenticated \
            --set-env-vars "NODE_ENV=production,NEXT_PUBLIC_BACKEND_URL=${{ vars.NEXT_PUBLIC_API_URL_PRODUCTION }}" \
            --verbosity info

          echo "âœ… Frontend Cloud Run deploy concluÃ­do!"

  # Deploy Backend para ProduÃ§Ã£o
  backend-production-deploy:
    name: "ğŸ”§ Backend Production Deploy"
    runs-on: ubuntu-latest
    needs: [production-preparation, production-security-analysis]
    if: needs.production-preparation.outputs.deploy-backend == 'true'
    timeout-minutes: 60
    defaults:
      run:
        working-directory: apps/backend
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: "ğŸ” Production Build Analysis"
        id: changes
        run: |
          echo "ğŸ” Analisando mudanÃ§as para build de produÃ§Ã£o..."

          # Verificar mudanÃ§as crÃ­ticas
          CRITICAL_CHANGES=""
          if git diff --name-only HEAD~1 HEAD | grep -E "(requirements\.txt|Dockerfile|\.dockerignore)"; then
            CRITICAL_CHANGES="dependencies"
            echo "ğŸ”„ MudanÃ§as crÃ­ticas detectadas: dependÃªncias/Dockerfile"
          elif git diff --name-only HEAD~1 HEAD | grep -E "apps/backend/"; then
            CRITICAL_CHANGES="code"
            echo "ğŸ“ MudanÃ§as de cÃ³digo Python detectadas"
          else
            echo "âœ… Nenhuma mudanÃ§a no backend detectada"
          fi

          # Calcular hash das dependÃªncias
          DEPS_HASH=$(sha256sum requirements.txt | cut -d' ' -f1)
          echo "ğŸ“‹ Hash das dependÃªncias: $DEPS_HASH"

          # Outputs
          echo "critical-changes=$CRITICAL_CHANGES" >> $GITHUB_OUTPUT
          echo "deps-hash=$DEPS_HASH" >> $GITHUB_OUTPUT

          # Skip build apenas se realmente nÃ£o hÃ¡ mudanÃ§as
          if [ -z "$CRITICAL_CHANGES" ]; then
            echo "skip-build=true" >> $GITHUB_OUTPUT
            echo "â­ï¸ Build do backend serÃ¡ pulado - sem mudanÃ§as"
          else
            echo "skip-build=false" >> $GITHUB_OUTPUT
            echo "ğŸ”¨ Build do backend necessÃ¡rio para produÃ§Ã£o"
          fi

      - name: "ğŸ”‘ Google Cloud Auth"
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
          project_id: ${{ vars.GCP_PROJECT_ID }}

      - name: "âš¡ Setup Cloud SDK"
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ vars.GCP_PROJECT_ID }}

      - name: "ğŸ³ Production Build and Deploy"
        if: steps.changes.outputs.skip-build == 'false'
        working-directory: apps/backend
        run: |
          echo "ğŸ”¨ Building backend para PRODUÃ‡ÃƒO..."
          echo "â° Timestamp inÃ­cio: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ğŸ“Š Timeout configurado: 3600s (60 minutos)"
          echo "ğŸ³ Build completo de produÃ§Ã£o: OpenCV + OCR + PostgreSQL + 60+ dependÃªncias"
          echo "ğŸ’° Machine type: e2-highcpu-8"
          echo "ğŸ¯ MudanÃ§as detectadas: ${{ steps.changes.outputs.critical-changes }}"

          # Verificar Dockerfile
          if [ -f "Dockerfile" ]; then
            echo "âœ… Dockerfile encontrado"
            echo "ğŸ“‹ Tamanho do Dockerfile: $(wc -l < Dockerfile) linhas"
          else
            echo "âŒ Dockerfile nÃ£o encontrado"
            exit 1
          fi

          # Build para produÃ§Ã£o com cache otimizado
          BUILD_START=$(date +%s)

          gcloud builds submit --tag us-central1-docker.pkg.dev/red-truck-468923-s4/hml-roteiro-dispensacao/${{ env.BACKEND_SERVICE }} \
            --timeout=3600s \
            --machine-type=e2-highcpu-8 \
            --disk-size=100GB \
            --verbosity=info .

          BUILD_END=$(date +%s)
          BUILD_DURATION=$((BUILD_END - BUILD_START))
          BUILD_COST=$(echo "scale=3; $BUILD_DURATION * 0.024 / 60" | bc -l)
          echo "â±ï¸ Tempo de build: ${BUILD_DURATION}s ($(($BUILD_DURATION / 60))m $(($BUILD_DURATION % 60))s)"
          echo "ğŸ’° Custo estimado: \$${BUILD_COST} USD"

          echo "ğŸš€ Deploying to Production Cloud Run..."
          echo "â° Timestamp deploy: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          gcloud run deploy ${{ env.BACKEND_SERVICE }} \
            --image us-central1-docker.pkg.dev/red-truck-468923-s4/hml-roteiro-dispensacao/${{ env.BACKEND_SERVICE }} \
            --platform managed \
            --region ${{ vars.GCP_REGION }} \
            --allow-unauthenticated \
            --timeout=900 \
            --memory=2Gi \
            --cpu=2 \
            --set-env-vars "ENVIRONMENT=production,LGPD_MODE=strict,PROJECT_ID=red-truck-468923-s4" \
            --max-instances=20 \
            --min-instances=2

  # Testes pÃ³s-deploy em produÃ§Ã£o
  production-post-deploy-tests:
    name: "ğŸ§ª Production Post-Deploy Tests"
    runs-on: ubuntu-latest
    needs: [frontend-production-deploy, backend-production-deploy]
    if: always() && (needs.frontend-production-deploy.result == 'success' || needs.backend-production-deploy.result == 'success')
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4

      - name: "ğŸ”‘ Google Cloud Auth for Health Checks"
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
          project_id: ${{ vars.GCP_PROJECT_ID }}

      - name: "âš¡ Setup Cloud SDK for Health Checks"
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ vars.GCP_PROJECT_ID }}

      - name: "ğŸŒ Production Frontend Health Check"
        if: needs.frontend-production-deploy.result == 'success'
        run: |
          echo "ğŸ” Verificando saÃºde do frontend PRODUÃ‡ÃƒO..."
          # Obter URL do Cloud Run Frontend
          FRONTEND_URL=$(gcloud run services describe roteiro-dispensacao-frontend --region=${{ vars.GCP_REGION }} --format='value(status.url)' 2>/dev/null || echo "")

          if [ -z "$FRONTEND_URL" ]; then
            echo "âš ï¸ Frontend Cloud Run nÃ£o encontrado, usando URL de fallback"
            FRONTEND_URL="https://roteiro-dispensacao-frontend-339202208157.us-central1.run.app"
          fi

          echo "ğŸŒ URL de produÃ§Ã£o: $FRONTEND_URL"

          # Aguardar propagaÃ§Ã£o com retry
          echo "â³ Aguardando propagaÃ§Ã£o do deploy de produÃ§Ã£o..."
          for i in {1..8}; do
            echo "ğŸ”„ Tentativa $i/8..."

            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$FRONTEND_URL")
            echo "ğŸ“¡ HTTP Code: $HTTP_CODE"

            if [ "$HTTP_CODE" = "200" ]; then
              echo "âœ… Frontend produÃ§Ã£o respondendo (HTTP 200)"

              # Verificar conteÃºdo
              CONTENT=$(curl -s "$FRONTEND_URL")
              if echo "$CONTENT" | grep -q "Next.js\|__NEXT_DATA__\|_app\|DOCTYPE html"; then
                echo "âœ… ConteÃºdo HTML/Next.js detectado"
                echo "âœ… Frontend PRODUÃ‡ÃƒO confirmado como funcional"
                exit 0
              else
                echo "âš ï¸ Resposta sem conteÃºdo HTML esperado"
              fi
            else
              echo "âŒ Frontend retornou HTTP $HTTP_CODE"
            fi

            if [ $i -lt 8 ]; then
              echo "â³ Aguardando 45s antes da prÃ³xima tentativa..."
              sleep 45
            fi
          done

          echo "âŒ Frontend PRODUÃ‡ÃƒO falhou apÃ³s 8 tentativas"
          exit 1

      - name: "ğŸ”§ Production Backend Health Check"
        if: needs.backend-production-deploy.result == 'success'
        run: |
          echo "ğŸ” Verificando saÃºde do backend PRODUÃ‡ÃƒO..."
          BACKEND_URL=$(gcloud run services describe ${{ env.BACKEND_SERVICE }} --region=${{ vars.GCP_REGION }} --format='value(status.url)')

          # Health check com versionamento correto
          if curl -f -s "$BACKEND_URL/api/v1/health" > /dev/null; then
            echo "âœ… Backend PRODUÃ‡ÃƒO respondendo"
          else
            echo "âŒ Backend PRODUÃ‡ÃƒO nÃ£o estÃ¡ respondendo"
            exit 1
          fi

      - name: "ğŸ¥ Production Medical Endpoints Test"
        run: |
          echo "ğŸ©º Testando endpoints mÃ©dicos em PRODUÃ‡ÃƒO..."
          # Obter URL do Cloud Run Frontend
          FRONTEND_URL=$(gcloud run services describe roteiro-dispensacao-frontend --region=${{ vars.GCP_REGION }} --format='value(status.url)' 2>/dev/null || echo "")

          if [ -z "$FRONTEND_URL" ]; then
            echo "âš ï¸ Frontend Cloud Run nÃ£o encontrado, usando URL de fallback"
            FRONTEND_URL="https://roteiro-dispensacao-frontend-339202208157.us-central1.run.app"
          fi

          # Testar pÃ¡ginas mÃ©dicas crÃ­ticas
          MEDICAL_PAGES=("/modules/hanseniase" "/resources/calculator" "/chat")

          for page in "${MEDICAL_PAGES[@]}"; do
            if curl -f -s "$FRONTEND_URL$page" > /dev/null; then
              echo "âœ… PÃ¡gina mÃ©dica $page acessÃ­vel em produÃ§Ã£o"
            else
              echo "âš ï¸ PÃ¡gina mÃ©dica $page pode ter problemas em produÃ§Ã£o"
            fi
          done

  # Monitoramento e notificaÃ§Ãµes para produÃ§Ã£o
  production-monitoring:
    name: "ğŸ“Š Production Monitoring"
    runs-on: ubuntu-latest
    needs: [production-post-deploy-tests]
    if: success()
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "âœ… Production Deploy Summary"
        run: |
          echo "## ğŸš€ Deploy de ProduÃ§Ã£o ConcluÃ­do" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š Status dos ServiÃ§os em ProduÃ§Ã£o:" >> $GITHUB_STEP_SUMMARY
          echo "| ServiÃ§o | Status | URL |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | âœ… | Cloud Run Production |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend | ${{ needs.backend-production-deploy.result == 'success' && 'âœ…' || 'â­ï¸' }} | Cloud Run Production |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ¥ Funcionalidades MÃ©dicas em ProduÃ§Ã£o:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… LGPD Compliance validado" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… SeguranÃ§a mÃ©dica verificada" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Personas Dr. Gasnelio e GA" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Calculadoras de dosagem" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… API versionada (/api/v1/)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ¯ **Sistema em produÃ§Ã£o totalmente funcional!**" >> $GITHUB_STEP_SUMMARY

      - name: "ğŸ“± Production Success Notification"
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [[ -n "$TELEGRAM_TOKEN" && -n "$TELEGRAM_CHAT_ID" ]]; then
            echo "ğŸ“± Enviando notificaÃ§Ã£o de sucesso para PRODUÃ‡ÃƒO..."

            MESSAGE="ğŸš€ <b>PRODUÃ‡ÃƒO Deploy ConcluÃ­do com Sucesso</b>%0A"
            MESSAGE="${MESSAGE}%0AğŸŸ¢ <b>Status:</b> PRODUÃ‡ÃƒO ATIVA"
            MESSAGE="${MESSAGE}%0AğŸ¯ <b>Branch:</b> ${{ github.ref_name }}"
            MESSAGE="${MESSAGE}%0Aâ° <b>HorÃ¡rio:</b> $(date '+%H:%M - %d/%m/%Y')"
            MESSAGE="${MESSAGE}%0A%0AğŸ¥ <b>Funcionalidades MÃ©dicas:</b>%0A"
            MESSAGE="${MESSAGE}âœ… LGPD Compliance em produÃ§Ã£o%0A"
            MESSAGE="${MESSAGE}âœ… SeguranÃ§a mÃ©dica validada%0A"
            MESSAGE="${MESSAGE}âœ… Protocolos mÃ©dicos ativos%0A"
            MESSAGE="${MESSAGE}âœ… Personas Dr. Gasnelio e GA%0A"
            MESSAGE="${MESSAGE}âœ… API versionada funcionando%0A"
            MESSAGE="${MESSAGE}%0AğŸŒ <b>ProduÃ§Ã£o:</b> Cloud Run Active"
            MESSAGE="${MESSAGE}%0AğŸ‘¤ <b>Autor:</b> ${{ github.actor }}"
            MESSAGE="${MESSAGE}%0AğŸ”— <b>Commit:</b> <a href=\"${{ github.event.head_commit.url }}\">${{ github.sha }}</a>"

            curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage" \
              -d chat_id="$TELEGRAM_CHAT_ID" \
              -d text="$MESSAGE" \
              -d parse_mode="HTML" \
              -d disable_web_page_preview="true" >/dev/null

            echo "âœ… NotificaÃ§Ã£o de produÃ§Ã£o enviada"
          else
            echo "âš ï¸ Tokens Telegram nÃ£o configurados"
          fi

      - name: "ğŸš¨ Production Failure Alert"
        if: failure() || needs.production-post-deploy-tests.result == 'failure'
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [[ -n "$TELEGRAM_TOKEN" && -n "$TELEGRAM_CHAT_ID" ]]; then
            echo "ğŸš¨ Enviando alerta CRÃTICO de falha em PRODUÃ‡ÃƒO..."

            ALERT_MESSAGE="ğŸš¨ <b>ALERTA CRÃTICO - PRODUÃ‡ÃƒO FALHOU</b>%0A"
            ALERT_MESSAGE="${ALERT_MESSAGE}%0AâŒ <b>Status:</b> FALHA CRÃTICA NO PIPELINE"
            ALERT_MESSAGE="${ALERT_MESSAGE}%0AğŸ¯ <b>Branch:</b> ${{ github.ref_name }}"
            ALERT_MESSAGE="${ALERT_MESSAGE}%0Aâ° <b>HorÃ¡rio:</b> $(date '+%H:%M - %d/%m/%Y')"
            ALERT_MESSAGE="${ALERT_MESSAGE}%0A%0Aâš ï¸ <b>AÃ‡ÃƒO URGENTE NECESSÃRIA</b>"
            ALERT_MESSAGE="${ALERT_MESSAGE}%0AğŸ”— <b>Workflow:</b> <a href=\"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\">Ver Logs</a>"
            ALERT_MESSAGE="${ALERT_MESSAGE}%0AğŸ‘¤ <b>ResponsÃ¡vel:</b> ${{ github.actor }}"
            ALERT_MESSAGE="${ALERT_MESSAGE}%0A%0AğŸ¥ <b>Impacto:</b> Sistema de produÃ§Ã£o pode estar comprometido"

            curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage" \
              -d chat_id="$TELEGRAM_CHAT_ID" \
              -d text="$ALERT_MESSAGE" \
              -d parse_mode="HTML" \
              -d disable_web_page_preview="true" >/dev/null

            echo "ğŸš¨ Alerta CRÃTICO de produÃ§Ã£o enviado"
          else
            echo "âš ï¸ Tokens Telegram nÃ£o configurados"
          fi