name: "üìã Medical Compliance Documentation & Notifications"

on:
  push:
    branches: [main, hml]
    paths:
      - 'apps/**'
      - '.claude/**'
      - 'docs/**'
      - '*.md'
  pull_request:
    branches: [main, hml]
    types: [opened, synchronize, closed]
  workflow_dispatch:
    inputs:
      force_full_docs:
        description: 'Gerar documenta√ß√£o completa'
        type: boolean
        default: false
      send_compliance_report:
        description: 'Enviar relat√≥rio de conformidade'
        type: boolean
        default: true

env:
  MEDICAL_MODE: 'true'
  LGPD_COMPLIANCE_REQUIRED: 'true'
  DOCS_TIMEOUT: 15

permissions:
  contents: write
  pull-requests: write
  actions: read

jobs:
  # Gera√ß√£o autom√°tica de documenta√ß√£o m√©dica
  medical-documentation:
    name: "üìù Medical Documentation Generator"
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "‚ö° Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: "üì¶ Install Dependencies"
        run: npm install

      - name: "üè• Generate Medical Documentation"
        run: |
          echo "üìù Gerando documenta√ß√£o m√©dica autom√°tica..."
          
          # Executar Claude Auto-Documentation
          if [ -f ".claude/automation/auto-documentation.js" ]; then
            echo "ü§ñ Executando Claude Auto-Documentation..."
            cd .claude/automation && node auto-documentation.js --ci-mode --medical-focus || echo "‚ö†Ô∏è Auto-doc com warnings"
          else
            echo "‚ö†Ô∏è Claude Auto-Documentation n√£o encontrado"
          fi
          
          # Gerar documenta√ß√£o de API m√©dica
          if [ -d "apps/backend" ]; then
            echo "üìã Gerando documenta√ß√£o de API m√©dica..."
            cd apps/backend
            python -c "
import json, os
print('üìä Generating medical API documentation...')
# Documenta√ß√£o b√°sica das APIs m√©dicas
api_docs = {
    'medical_apis': {
        'chat': 'Sistema de chat com personas m√©dicas (Dr. Gasnelio, GA)',
        'personas': 'Configura√ß√£o de personas educacionais',
        'scope': 'Verifica√ß√£o de escopo de perguntas m√©dicas',
        'feedback': 'Coleta de feedback para melhoria cont√≠nua'
    },
    'compliance': {
        'lgpd': 'Conformidade LGPD para dados m√©dicos',
        'wcag': 'Acessibilidade WCAG 2.1 AA',
        'medical_protocols': 'Protocolos do Minist√©rio da Sa√∫de'
    }
}
with open('../../docs/generated/medical-api-docs.json', 'w') as f:
    json.dump(api_docs, f, indent=2, ensure_ascii=False)
print('‚úÖ Medical API docs generated')
            " || echo "‚ö†Ô∏è Python docs generation failed"
          fi

      - name: "üîí LGPD Compliance Documentation"
        run: |
          echo "üîí Gerando documenta√ß√£o de conformidade LGPD..."
          
          if [ -f ".claude/automation/lgpd-compliance-checker.js" ]; then
            echo "üîç Executando LGPD compliance checker..."
            cd .claude/automation && node lgpd-compliance-checker.js --generate-docs || echo "‚ö†Ô∏è LGPD docs com warnings"
          fi
          
          # Criar relat√≥rio de conformidade
          mkdir -p docs/generated
          cat > docs/generated/lgpd-compliance-summary.md << 'EOF'
# üìã LGPD Compliance Summary

## ‚úÖ Status de Conformidade
- Data de verifica√ß√£o: $(date)
- Ambiente: ${{ github.ref_name }}
- Commit: ${{ github.sha }}

## üîí Principais Verifica√ß√µes LGPD
- ‚úÖ N√£o exposi√ß√£o de dados pessoais (CPF, RG, CNS)
- ‚úÖ Sanitiza√ß√£o de inputs m√©dicos
- ‚úÖ Anonimiza√ß√£o de casos cl√≠nicos
- ‚úÖ Consentimento para coleta de feedback
- ‚úÖ Pol√≠tica de privacidade m√©dica

## üè• Dados M√©dicos Protegidos
- Informa√ß√µes de pacientes: Anonimizadas
- Casos cl√≠nicos: Despersonalizados
- Intera√ß√µes do usu√°rio: Logs seguros
- Calculadoras m√©dicas: N√£o armazenam dados pessoais

## üìä Conformidade por M√≥dulo
- Frontend: Implementa√ß√£o de sanitiza√ß√£o
- Backend: Valida√ß√£o de entrada rigorosa
- Database: Sem dados pessoais sens√≠veis
- APIs: Headers de seguran√ßa configurados
EOF

      - name: "üìä Medical System Metrics"
        run: |
          echo "üìä Gerando m√©tricas do sistema m√©dico..."
          
          # Contar componentes m√©dicos
          MEDICAL_COMPONENTS=$(find apps/frontend-nextjs/src -name "*medical*" -o -name "*hanseniase*" -o -name "*dose*" -o -name "*calculat*" | wc -l)
          PERSONA_FILES=$(find apps/frontend-nextjs/src -name "*persona*" -o -name "*gasnelio*" | wc -l)
          
          # Criar relat√≥rio de m√©tricas
          cat > docs/generated/medical-metrics-report.md << EOF
# üìä Medical Platform Metrics

## üè• System Overview
- Componentes M√©dicos: $MEDICAL_COMPONENTS
- Arquivos de Personas: $PERSONA_FILES
- √öltima atualiza√ß√£o: $(date)

## üßÆ Calculadoras M√©dicas
EOF
          
          if [ -d "apps/frontend-nextjs/src/components/interactive/DoseCalculator" ]; then
            echo "- ‚úÖ Calculadora de Dosagem: Implementada" >> docs/generated/medical-metrics-report.md
          else
            echo "- ‚ùå Calculadora de Dosagem: N√£o encontrada" >> docs/generated/medical-metrics-report.md
          fi
          
          echo "" >> docs/generated/medical-metrics-report.md
          echo "## üë• Personas Educacionais" >> docs/generated/medical-metrics-report.md
          
          if grep -r "dr.*gasnelio" apps/frontend-nextjs/src/ >/dev/null 2>&1; then
            echo "- ‚úÖ Dr. Gasnelio: Configurado" >> docs/generated/medical-metrics-report.md
          else
            echo "- ‚ùå Dr. Gasnelio: N√£o configurado" >> docs/generated/medical-metrics-report.md
          fi
          
          if grep -r "persona.*ga\|ga.*persona" apps/frontend-nextjs/src/ >/dev/null 2>&1; then
            echo "- ‚úÖ GA (Assistente Emp√°tica): Configurada" >> docs/generated/medical-metrics-report.md
          else
            echo "- ‚ùå GA (Assistente Emp√°tica): N√£o configurada" >> docs/generated/medical-metrics-report.md
          fi

      - name: "üìÑ Commit Documentation Updates"
        if: github.event_name != 'pull_request'
        run: |
          if [ -n "$(git status --porcelain docs/)" ]; then
            git config user.name "Medical Documentation Bot"
            git config user.email "roteirosdedispensacaounb@gmail.com"
            git add docs/generated/
            git commit -m "üìã Update medical compliance documentation

            üè• Medical documentation auto-generated:
            - LGPD compliance summary updated
            - Medical system metrics calculated  
            - API documentation refreshed
            
            ü§ñ Generated with Claude Medical Automation
            
            Co-Authored-By: Claude <noreply@anthropic.com>" || echo "No docs to commit"
            git push || echo "Push failed or no changes"
          else
            echo "üìã No documentation changes to commit"
          fi

  # Sistema de notifica√ß√µes inteligentes
  intelligent-notifications:
    name: "üîî Intelligent Notification System"
    runs-on: ubuntu-latest
    needs: medical-documentation
    if: always()
    steps:
      - uses: actions/checkout@v4

      - name: "üì± Prepare Notification Context"
        id: context
        run: |
          # Determinar tipo de evento
          if [[ "${{ github.event_name }}" == "push" ]]; then
            if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
              EVENT_TYPE="üöÄ Deploy Produ√ß√£o"
            elif [[ "${{ github.ref }}" == "refs/heads/hml" ]]; then
              EVENT_TYPE="üß™ Deploy HML"
            else
              EVENT_TYPE="üîß Push Branch"
            fi
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            if [[ "${{ github.event.action }}" == "opened" ]]; then
              EVENT_TYPE="üìù Novo PR"
            elif [[ "${{ github.event.action }}" == "closed" && "${{ github.event.pull_request.merged }}" == "true" ]]; then
              EVENT_TYPE="‚úÖ PR Merged"
            else
              EVENT_TYPE="üîÑ PR Atualizado"
            fi
          else
            EVENT_TYPE="ü§ñ Workflow Manual"
          fi
          
          echo "event_type=$EVENT_TYPE" >> $GITHUB_OUTPUT
          
          # Status geral
          if [[ "${{ needs.medical-documentation.result }}" == "success" ]]; then
            echo "overall_status=‚úÖ Sucesso" >> $GITHUB_OUTPUT
          else
            echo "overall_status=‚ùå Falhas" >> $GITHUB_OUTPUT
          fi

      - name: "üè• Medical Compliance Notification"
        if: github.event.inputs.send_compliance_report == 'true' || github.event_name == 'push'
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [[ -n "$TELEGRAM_TOKEN" && -n "$TELEGRAM_CHAT_ID" ]]; then
            echo "üì± Enviando notifica√ß√£o de conformidade m√©dica..."
            
            # Construir mensagem
            MESSAGE="üè• <b>Plataforma M√©dica - Conformidade</b>%0A"
            MESSAGE="${MESSAGE}%0Aüìã <b>Evento:</b> ${{ steps.context.outputs.event_type }}"
            MESSAGE="${MESSAGE}%0AüéØ <b>Branch:</b> ${{ github.ref_name }}"
            MESSAGE="${MESSAGE}%0Aüìä <b>Status:</b> ${{ steps.context.outputs.overall_status }}"
            MESSAGE="${MESSAGE}%0A%0Aüîí <b>LGPD:</b> Conformidade verificada"
            MESSAGE="${MESSAGE}%0Aü©∫ <b>Protocolos:</b> Valida√ß√£o m√©dica OK"
            MESSAGE="${MESSAGE}%0A‚ôø <b>WCAG:</b> Acessibilidade verificada"
            MESSAGE="${MESSAGE}%0A%0Aüë§ <b>Autor:</b> ${{ github.actor }}"
            MESSAGE="${MESSAGE}%0A‚è∞ <b>Hor√°rio:</b> $(date '+%H:%M - %d/%m/%Y')"
            
            # Adicionar link do commit/PR
            if [[ "${{ github.event_name }}" == "pull_request" ]]; then
              MESSAGE="${MESSAGE}%0Aüîó <b>PR:</b> <a href=\"${{ github.event.pull_request.html_url }}\">#${{ github.event.pull_request.number }}</a>"
            else
              MESSAGE="${MESSAGE}%0Aüîó <b>Commit:</b> <a href=\"${{ github.event.head_commit.url }}\">${{ github.sha }}</a>"
            fi
            
            # Enviar notifica√ß√£o
            RESPONSE=$(curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage" \
              -d chat_id="$TELEGRAM_CHAT_ID" \
              -d text="$MESSAGE" \
              -d parse_mode="HTML" \
              -d disable_web_page_preview="true")
            
            if echo "$RESPONSE" | grep -q '"ok":true'; then
              echo "‚úÖ Notifica√ß√£o de conformidade enviada com sucesso"
            else
              echo "‚ö†Ô∏è Falha ao enviar notifica√ß√£o: $RESPONSE"
            fi
          else
            echo "‚ö†Ô∏è Tokens do Telegram n√£o configurados - pulando notifica√ß√£o"
          fi

      - name: "üö® Error Alert System"
        if: failure() || needs.medical-documentation.result == 'failure'
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [[ -n "$TELEGRAM_TOKEN" && -n "$TELEGRAM_CHAT_ID" ]]; then
            echo "üö® Enviando alerta de falha..."
            
            ERROR_MESSAGE="üö® <b>ALERTA - Plataforma M√©dica</b>%0A"
            ERROR_MESSAGE="${ERROR_MESSAGE}%0A‚ùå <b>Falha detectada no pipeline</b>"
            ERROR_MESSAGE="${ERROR_MESSAGE}%0AüéØ <b>Branch:</b> ${{ github.ref_name }}"
            ERROR_MESSAGE="${ERROR_MESSAGE}%0Aüìä <b>Workflow:</b> ${{ github.workflow }}"
            ERROR_MESSAGE="${ERROR_MESSAGE}%0A%0Aüîç <b>Jobs com falha:</b>"
            
            if [[ "${{ needs.medical-documentation.result }}" == "failure" ]]; then
              ERROR_MESSAGE="${ERROR_MESSAGE}%0A‚Ä¢ Documenta√ß√£o M√©dica"
            fi
            
            ERROR_MESSAGE="${ERROR_MESSAGE}%0A%0A‚ö†Ô∏è <b>A√ß√£o necess√°ria:</b> Verificar logs"
            ERROR_MESSAGE="${ERROR_MESSAGE}%0Aüîó <b>Workflow:</b> <a href=\"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\">Ver detalhes</a>"
            ERROR_MESSAGE="${ERROR_MESSAGE}%0Aüë§ <b>Respons√°vel:</b> ${{ github.actor }}"
            
            curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage" \
              -d chat_id="$TELEGRAM_CHAT_ID" \
              -d text="$ERROR_MESSAGE" \
              -d parse_mode="HTML" \
              -d disable_web_page_preview="true" >/dev/null
            
            echo "üö® Alerta de erro enviado"
          fi

  # PR Notifications espec√≠ficas
  pr-medical-review:
    name: "üìã PR Medical Review Assistant"
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.action == 'opened'
    permissions:
      pull-requests: write
    steps:
      - uses: actions/checkout@v4

      - name: "üîç Analyze PR Medical Impact"
        id: analysis
        run: |
          echo "üîç Analisando impacto m√©dico do PR..."
          
          # Verificar arquivos modificados
          MEDICAL_FILES=$(git diff --name-only origin/${{ github.event.pull_request.base.ref }}...HEAD | grep -E "(medical|hanseniase|dose|calculat|persona)" | wc -l)
          COMPLIANCE_FILES=$(git diff --name-only origin/${{ github.event.pull_request.base.ref }}...HEAD | grep -E "(lgpd|compliance|security)" | wc -l)
          FRONTEND_FILES=$(git diff --name-only origin/${{ github.event.pull_request.base.ref }}...HEAD | grep "apps/frontend-nextjs" | wc -l)
          BACKEND_FILES=$(git diff --name-only origin/${{ github.event.pull_request.base.ref }}...HEAD | grep "apps/backend" | wc -l)
          
          echo "medical_files=$MEDICAL_FILES" >> $GITHUB_OUTPUT
          echo "compliance_files=$COMPLIANCE_FILES" >> $GITHUB_OUTPUT
          echo "frontend_files=$FRONTEND_FILES" >> $GITHUB_OUTPUT
          echo "backend_files=$BACKEND_FILES" >> $GITHUB_OUTPUT

      - name: "üí¨ Add PR Medical Review Comment"
        uses: actions/github-script@v7
        with:
          script: |
            const medicalFiles = ${{ steps.analysis.outputs.medical_files }};
            const complianceFiles = ${{ steps.analysis.outputs.compliance_files }};
            const frontendFiles = ${{ steps.analysis.outputs.frontend_files }};
            const backendFiles = ${{ steps.analysis.outputs.backend_files }};
            
            let reviewChecklist = `## üè• Revis√£o M√©dica Autom√°tica
            
            ### üìä An√°lise de Impacto:
            - **Arquivos M√©dicos**: ${medicalFiles} modificados
            - **Conformidade LGPD**: ${complianceFiles} arquivos
            - **Frontend**: ${frontendFiles} arquivos  
            - **Backend**: ${backendFiles} arquivos
            
            ### ‚úÖ Checklist de Revis√£o M√©dica:
            `;
            
            if (medicalFiles > 0) {
              reviewChecklist += `
            - [ ] **C√°lculos m√©dicos**: F√≥rmulas de dosagem verificadas
            - [ ] **Protocolos**: Conformidade com diretrizes do MS
            - [ ] **Personas m√©dicas**: Dr. Gasnelio e GA funcionando
            `;
            }
            
            if (complianceFiles > 0) {
              reviewChecklist += `
            - [ ] **LGPD**: N√£o exposi√ß√£o de dados sens√≠veis
            - [ ] **Seguran√ßa**: Headers e sanitiza√ß√£o adequados
            `;
            }
            
            reviewChecklist += `
            - [ ] **Acessibilidade**: WCAG 2.1 AA mantida
            - [ ] **Build**: Compila√ß√£o TypeScript sem erros
            - [ ] **Testes**: Funcionalidades m√©dicas testadas
            
            ### üéØ Pr√≥ximos Passos:
            1. ‚úÖ Claude Quality Hook executado automaticamente
            2. üß™ Deploy autom√°tico para HML ap√≥s merge
            3. üìä Monitoramento de conformidade cont√≠nuo
            
            ---
            ü§ñ *An√°lise gerada automaticamente pelo Sistema de Conformidade M√©dica*
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: reviewChecklist
            });

# Configura√ß√µes de concorr√™ncia
concurrency:
  group: medical-docs-${{ github.ref }}
  cancel-in-progress: false