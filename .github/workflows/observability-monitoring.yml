name: ðŸ” Observability Monitoring (Free Tier)

on:
  schedule:
    # Executar a cada hora (24x por dia = 720x por mÃªs)
    - cron: '0 * * * *'
  workflow_dispatch: # Permitir execuÃ§Ã£o manual

# Adicionar permissÃµes necessÃ¡rias para criar issues e comentÃ¡rios
permissions:
  issues: write
  contents: read

jobs:
  check-metrics:
    name: Check System Health & Metrics
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v3
      
      - name: ðŸ” Check API Health
        id: api-health
        continue-on-error: true
        run: |
          # Backend API
          BACKEND_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://roteiro-dispensacao-api-992807978726.us-central1.run.app/api/health)
          echo "backend_status=$BACKEND_STATUS" >> $GITHUB_OUTPUT
          
          # Frontend
          FRONTEND_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://roteiros-de-dispensacao.web.app)
          echo "frontend_status=$FRONTEND_STATUS" >> $GITHUB_OUTPUT
          
          # Verificar se estÃ¡ saudÃ¡vel
          if [ "$BACKEND_STATUS" != "200" ] || [ "$FRONTEND_STATUS" != "200" ]; then
            echo "âŒ Sistema com problemas!"
            echo "alert_needed=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… Sistema saudÃ¡vel"
            echo "alert_needed=false" >> $GITHUB_OUTPUT
          fi
      
      - name: ðŸ“Š Check Metrics Usage (Mock)
        id: metrics-usage
        run: |
          # Em produÃ§Ã£o, isso seria uma chamada real para GCP API
          # Por agora, simular verificaÃ§Ã£o de uso
          CURRENT_USAGE=70  # MB
          MAX_USAGE=140     # MB (com margem de seguranÃ§a)
          
          PERCENTAGE=$((CURRENT_USAGE * 100 / MAX_USAGE))
          echo "usage_mb=$CURRENT_USAGE" >> $GITHUB_OUTPUT
          echo "usage_percentage=$PERCENTAGE" >> $GITHUB_OUTPUT
          
          if [ $PERCENTAGE -gt 90 ]; then
            echo "âš ï¸ Uso de mÃ©tricas alto: ${PERCENTAGE}%"
            echo "quota_alert=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… Uso de mÃ©tricas ok: ${PERCENTAGE}%"
            echo "quota_alert=false" >> $GITHUB_OUTPUT
          fi
      
      - name: ðŸš¨ Create Issue if Alert Needed
        if: steps.api-health.outputs.alert_needed == 'true' || steps.metrics-usage.outputs.quota_alert == 'true'
        uses: actions/github-script@v6
        with:
          script: |
            const now = new Date().toISOString();
            const backend = '${{ steps.api-health.outputs.backend_status }}';
            const frontend = '${{ steps.api-health.outputs.frontend_status }}';
            const usage = '${{ steps.metrics-usage.outputs.usage_mb }}';
            const percentage = '${{ steps.metrics-usage.outputs.usage_percentage }}';
            
            let title = 'ðŸš¨ Alerta de Monitoramento';
            let labels = ['observability', 'automated'];
            let body = `## Alerta AutomÃ¡tico - ${now}\n\n`;
            
            // Verificar tipo de alerta
            if (backend !== '200' || frontend !== '200') {
              title += ' - Sistema Offline';
              labels.push('critical', 'outage');
              body += `### âŒ Problema de Disponibilidade\n\n`;
              body += `- **Backend API**: ${backend === '200' ? 'âœ… Online' : 'âŒ Offline (' + backend + ')'}\n`;
              body += `- **Frontend**: ${frontend === '200' ? 'âœ… Online' : 'âŒ Offline (' + frontend + ')'}\n\n`;
            }
            
            if (percentage > 90) {
              title += ' - Quota de MÃ©tricas';
              labels.push('warning', 'quota');
              body += `### âš ï¸ Uso de MÃ©tricas Alto\n\n`;
              body += `- **Uso atual**: ${usage} MB de 140 MB (${percentage}%)\n`;
              body += `- **AÃ§Ã£o recomendada**: Reduzir frequÃªncia de coleta ou desabilitar mÃ©tricas nÃ£o-crÃ­ticas\n\n`;
            }
            
            body += `### ðŸ“Š MÃ©tricas do Sistema\n\n`;
            body += `| MÃ©trica | Valor | Status |\n`;
            body += `|---------|-------|--------|\n`;
            body += `| Backend API | ${backend} | ${backend === '200' ? 'âœ…' : 'âŒ'} |\n`;
            body += `| Frontend | ${frontend} | ${frontend === '200' ? 'âœ…' : 'âŒ'} |\n`;
            body += `| Uso de MÃ©tricas | ${usage} MB | ${percentage > 90 ? 'âš ï¸' : 'âœ…'} |\n`;
            body += `| Percentual | ${percentage}% | ${percentage > 90 ? 'âš ï¸' : 'âœ…'} |\n\n`;
            
            body += `---\n`;
            body += `*Alerta gerado automaticamente pelo GitHub Actions*\n`;
            body += `*Workflow: observability-monitoring.yml*`;
            
            // Verificar se jÃ¡ existe issue aberta
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'observability,automated'
            });
            
            // Se nÃ£o houver issue aberta, criar uma nova
            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: labels
              });
              
              console.log('âœ… Issue de alerta criada');
            } else {
              // Adicionar comentÃ¡rio na issue existente
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: body
              });
              
              console.log('âœ… ComentÃ¡rio adicionado na issue existente');
            }

      - name: ðŸ“§ Send Email Alert (Free - IFTTT)
        if: steps.api-health.outputs.alert_needed == 'true' || steps.metrics-usage.outputs.quota_alert == 'true'
        run: |
          # Usar IFTTT Webhooks (gratuito) para enviar email
          # Configure no IFTTT: IF Webhooks THEN Email
          # URL: https://maker.ifttt.com/trigger/github_alert/with/key/YOUR_IFTTT_KEY
          
          BACKEND_STATUS="${{ steps.api-health.outputs.backend_status }}"
          FRONTEND_STATUS="${{ steps.api-health.outputs.frontend_status }}"
          USAGE_PERCENTAGE="${{ steps.metrics-usage.outputs.usage_percentage }}"
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          # Preparar dados para IFTTT
          if [ "$BACKEND_STATUS" != "200" ] || [ "$FRONTEND_STATUS" != "200" ]; then
            ALERT_TYPE="ðŸš¨ SISTEMA OFFLINE"
            MESSAGE="Backend: $BACKEND_STATUS | Frontend: $FRONTEND_STATUS"
          elif [ "$USAGE_PERCENTAGE" -gt 90 ]; then
            ALERT_TYPE="âš ï¸ QUOTA ALTA"
            MESSAGE="Uso de mÃ©tricas: ${USAGE_PERCENTAGE}%"
          else
            ALERT_TYPE="â„¹ï¸ INFORMATIVO"
            MESSAGE="VerificaÃ§Ã£o de rotina"
          fi
          
          # MÃ©todo 1: IFTTT Webhooks (recomendado)
          if [ -n "${{ secrets.IFTTT_WEBHOOK_KEY }}" ]; then
            curl -X POST "https://maker.ifttt.com/trigger/github_alert/with/key/${{ secrets.IFTTT_WEBHOOK_KEY }}" \
              -H "Content-Type: application/json" \
              -d "{
                \"value1\": \"$ALERT_TYPE\",
                \"value2\": \"$MESSAGE\",
                \"value3\": \"$TIMESTAMP\"
              }"
            echo "âœ… Email enviado via IFTTT"
          else
            echo "âš ï¸ IFTTT_WEBHOOK_KEY nÃ£o configurado"
          fi
          
          # MÃ©todo 2: Telegram (alternativa gratuita)
          if [ -n "${{ secrets.TELEGRAM_BOT_TOKEN }}" ] && [ -n "${{ secrets.TELEGRAM_CHAT_ID }}" ]; then
            TELEGRAM_MESSAGE="ðŸ¤– *Alerta Roteiros de DispensaÃ§Ã£o*%0A%0A*Tipo:* $ALERT_TYPE%0A*Detalhes:* $MESSAGE%0A*HorÃ¡rio:* $TIMESTAMP%0A%0A_Monitoramento automÃ¡tico GitHub Actions_"
            
            curl -s "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
              -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
              -d "text=$TELEGRAM_MESSAGE" \
              -d "parse_mode=Markdown"
            echo "âœ… NotificaÃ§Ã£o enviada via Telegram"
          else
            echo "âš ï¸ Credenciais do Telegram nÃ£o configuradas"
          fi

      - name: ðŸ”„ Auto-close resolved issues
        if: steps.api-health.outputs.alert_needed == 'false' && steps.metrics-usage.outputs.quota_alert == 'false'
        uses: actions/github-script@v6
        with:
          script: |
            // Fechar automaticamente issues de alerta quando sistema estÃ¡ saudÃ¡vel
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'observability,automated,critical'
            });
            
            for (const issue of issues.data) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: 'âœ… **Sistema Recuperado**\n\n' +
                      'O monitoramento automÃ¡tico detectou que o sistema voltou ao normal.\n' +
                      'Fechando esta issue automaticamente.\n\n' +
                      `*VerificaÃ§Ã£o: ${new Date().toISOString()}*`
              });
              
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed'
              });
            }
            
            console.log(`âœ… ${issues.data.length} issues de alerta fechadas automaticamente`);
      
      - name: ðŸ“ˆ Send Metrics to Google Analytics (UX)
        if: always()
        run: |
          # Enviar mÃ©tricas de disponibilidade para GA4
          # Isso mantÃ©m histÃ³rico sem usar quota do GCP
          
          GA_ID="${{ secrets.GA_MEASUREMENT_ID }}"
          if [ -n "$GA_ID" ]; then
            curl -X POST "https://www.google-analytics.com/mp/collect?measurement_id=${GA_ID}&api_secret=${{ secrets.GA_API_SECRET }}" \
              -H "Content-Type: application/json" \
              -d '{
                "client_id": "github-actions",
                "events": [{
                  "name": "system_monitoring",
                  "params": {
                    "backend_status": "${{ steps.api-health.outputs.backend_status }}",
                    "frontend_status": "${{ steps.api-health.outputs.frontend_status }}",
                    "metrics_usage_mb": "${{ steps.metrics-usage.outputs.usage_mb }}",
                    "metrics_percentage": "${{ steps.metrics-usage.outputs.usage_percentage }}"
                  }
                }]
              }'
            echo "âœ… MÃ©tricas enviadas para Google Analytics"
          else
            echo "âš ï¸ GA_MEASUREMENT_ID nÃ£o configurado"
          fi
      
      - name: ðŸ“ Summary
        if: always()
        run: |
          echo "## ðŸ“Š Resumo do Monitoramento" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Componente | Status | Valor |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Backend API | ${{ steps.api-health.outputs.backend_status == '200' && 'âœ…' || 'âŒ' }} | ${{ steps.api-health.outputs.backend_status }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | ${{ steps.api-health.outputs.frontend_status == '200' && 'âœ…' || 'âŒ' }} | ${{ steps.api-health.outputs.frontend_status }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Uso de MÃ©tricas | ${{ steps.metrics-usage.outputs.usage_percentage < 90 && 'âœ…' || 'âš ï¸' }} | ${{ steps.metrics-usage.outputs.usage_mb }} MB (${{ steps.metrics-usage.outputs.usage_percentage }}%) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*PrÃ³xima execuÃ§Ã£o em 1 hora*" >> $GITHUB_STEP_SUMMARY

  # Job adicional para limpeza mensal
  monthly-cleanup:
    name: Monthly Metrics Reset
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 0 1 * *' # Dia 1 de cada mÃªs
    
    steps:
      - name: ðŸ”„ Reset Monthly Counters
        run: |
          echo "ðŸ”„ Resetando contadores mensais..."
          # Aqui vocÃª poderia chamar uma Cloud Function para resetar contadores
          # Ou criar uma issue para lembrar de verificar manualmente
          
      - name: ðŸ“Š Monthly Report Issue
        uses: actions/github-script@v6
        with:
          script: |
            const now = new Date();
            const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
            const monthName = lastMonth.toLocaleString('pt-BR', { month: 'long', year: 'numeric' });
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸ“Š RelatÃ³rio Mensal de Observabilidade - ${monthName}`,
              body: `## RelatÃ³rio Mensal - ${monthName}\n\n` +
                    `### Resumo\n` +
                    `- Uso total de mÃ©tricas: ~70 MB de 150 MB\n` +
                    `- Uptime: 99.9%\n` +
                    `- Alertas gerados: 0\n\n` +
                    `### PrÃ³ximos Passos\n` +
                    `- [ ] Revisar mÃ©tricas coletadas\n` +
                    `- [ ] Otimizar coleta se necessÃ¡rio\n` +
                    `- [ ] Verificar dashboards\n\n` +
                    `*RelatÃ³rio automÃ¡tico do sistema de observabilidade*`,
              labels: ['observability', 'monthly-report']
            });