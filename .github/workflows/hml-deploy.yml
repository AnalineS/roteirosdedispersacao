name: ğŸ—ï¸ Deploy HML (HomologaÃ§Ã£o)

on:
  push:
    branches: [ hml ]
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deploy (skip some checks)'
        required: false
        default: 'false'

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  SERVICE_NAME: hml-roteiro-dispensacao-api
  REGION: ${{ secrets.GCP_REGION }}
  FRONTEND_SITE: hml-roteiros-de-dispensacao

jobs:
  # =====================================
  # Quality Gates com Snyk
  # =====================================
  quality-gates:
    name: ğŸ” Quality Gates & Security
    runs-on: ubuntu-latest
    if: github.event.inputs.force_deploy != 'true'
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“Š Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: apps/frontend-nextjs/package-lock.json

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: apps/backend/requirements.txt

      # Snyk Security Scanning
      - name: ğŸ”’ Run Snyk Security Scan
        uses: snyk/actions/setup@master
      
      - name: ğŸ” Snyk Code Analysis
        uses: snyk/actions/node@master
        continue-on-error: false
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=medium --fail-on=all
          command: code test

      - name: ğŸ“¦ Snyk Open Source Scan
        uses: snyk/actions/node@master
        continue-on-error: false
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=medium --fail-on=all
          command: test

      # Frontend Quality Gates
      - name: ğŸ“± Install Frontend Dependencies
        run: |
          cd apps/frontend-nextjs
          npm ci

      - name: ğŸ§ª Frontend Tests & Coverage
        run: |
          cd apps/frontend-nextjs
          npm run test:coverage
          
      - name: ğŸ“Š Check Coverage Threshold (95%)
        run: |
          cd apps/frontend-nextjs
          COVERAGE=$(npm run test:coverage:check | grep -o '[0-9]*\.[0-9]*' | tail -1)
          echo "Coverage: $COVERAGE%"
          if (( $(echo "$COVERAGE < 95" | bc -l) )); then
            echo "âŒ Coverage $COVERAGE% is below 95% threshold"
            exit 1
          fi
          echo "âœ… Coverage $COVERAGE% meets 95% threshold"

      - name: ğŸ” Frontend Lint & TypeScript
        run: |
          cd apps/frontend-nextjs
          npm run lint
          npm run type-check

      # Backend Quality Gates
      - name: ğŸ Install Backend Dependencies
        run: |
          cd apps/backend
          pip install -r requirements.txt
          pip install pytest pytest-cov flake8 mypy

      - name: ğŸ§ª Backend Tests & Coverage
        run: |
          cd apps/backend
          pytest --cov=. --cov-report=term-missing --cov-fail-under=95

      - name: ğŸ” Backend Code Quality
        run: |
          cd apps/backend
          flake8 . --count --max-complexity=10 --max-line-length=127 --statistics
          mypy . --ignore-missing-imports

      # Build Test
      - name: ğŸ—ï¸ Test Docker Build
        run: |
          cd apps/backend
          docker build -f Dockerfile.hml -t test-hml-build .

  # =====================================
  # Deploy Backend (Cloud Run)
  # =====================================
  deploy-backend:
    name: ğŸš€ Deploy Backend HML
    runs-on: ubuntu-latest
    needs: quality-gates
    if: always() && (needs.quality-gates.result == 'success' || github.event.inputs.force_deploy == 'true')
    
    outputs:
      service-url: ${{ steps.deploy.outputs.url }}
      
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ” Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: ğŸ› ï¸ Setup Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: ğŸ”§ Configure Docker Auth
        run: gcloud auth configure-docker --quiet

      - name: ğŸ—ï¸ Build Docker Image
        run: |
          cd apps/backend
          docker build -f Dockerfile.hml -t gcr.io/$PROJECT_ID/$SERVICE_NAME:$GITHUB_SHA .
          docker tag gcr.io/$PROJECT_ID/$SERVICE_NAME:$GITHUB_SHA gcr.io/$PROJECT_ID/$SERVICE_NAME:latest

      - name: ğŸ“¤ Push Docker Image
        run: |
          docker push gcr.io/$PROJECT_ID/$SERVICE_NAME:$GITHUB_SHA
          docker push gcr.io/$PROJECT_ID/$SERVICE_NAME:latest

      - name: ğŸš€ Deploy to Cloud Run
        id: deploy
        run: |
          # Carregar variÃ¡veis de ambiente
          ENV_VARS=""
          while IFS='=' read -r key value || [ -n "$key" ]; do
            if [[ ! $key =~ ^# ]] && [[ -n $key ]]; then
              ENV_VARS="${ENV_VARS}${key}=${value},"
            fi
          done < <(cat environments/shared.env environments/hml.env)
          ENV_VARS=${ENV_VARS%,}  # Remove trailing comma
          
          # Deploy no Cloud Run
          gcloud run deploy $SERVICE_NAME \
            --image=gcr.io/$PROJECT_ID/$SERVICE_NAME:$GITHUB_SHA \
            --platform=managed \
            --region=$REGION \
            --allow-unauthenticated \
            --port=8080 \
            --memory=1Gi \
            --cpu=1 \
            --concurrency=100 \
            --max-instances=10 \
            --min-instances=0 \
            --timeout=300 \
            --set-env-vars="$ENV_VARS" \
            --tag=hml-$(echo $GITHUB_SHA | cut -c1-7) \
            --quiet
          
          # Obter URL do serviÃ§o
          SERVICE_URL=$(gcloud run services describe $SERVICE_NAME --region=$REGION --format="value(status.url)")
          echo "url=$SERVICE_URL" >> $GITHUB_OUTPUT
          echo "ğŸŒ Backend URL: $SERVICE_URL"

      - name: ğŸ¥ Backend Health Check
        run: |
          echo "â³ Aguardando backend inicializar..."
          sleep 30
          
          for i in {1..10}; do
            if curl -f "${{ steps.deploy.outputs.url }}/health" > /dev/null 2>&1; then
              echo "âœ… Backend health check passed"
              break
            fi
            echo "â³ Tentativa $i/10 - aguardando..."
            sleep 10
          done

  # =====================================
  # Deploy Frontend (Firebase)
  # =====================================
  deploy-frontend:
    name: ğŸ¨ Deploy Frontend HML
    runs-on: ubuntu-latest
    needs: deploy-backend
    if: always() && needs.deploy-backend.result == 'success'
    
    outputs:
      frontend-url: ${{ steps.deploy.outputs.url }}
      
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ“Š Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: apps/frontend-nextjs/package-lock.json

      - name: ğŸ“¦ Install Dependencies
        run: |
          cd apps/frontend-nextjs
          npm ci

      - name: ğŸ”§ Configure Environment
        run: |
          cd apps/frontend-nextjs
          cp .env.hml .env.production.local
          echo "NEXT_PUBLIC_API_URL=${{ needs.deploy-backend.outputs.service-url }}" >> .env.production.local

      - name: ğŸ—ï¸ Build Frontend
        run: |
          cd apps/frontend-nextjs
          npm run build

      - name: ğŸ”¥ Setup Firebase CLI
        run: npm install -g firebase-tools

      - name: ğŸš€ Deploy to Firebase
        run: |
          cd apps/frontend-nextjs
          
          # Autenticar Firebase
          echo "${{ secrets.FIREBASE_TOKEN }}" | firebase login:ci
          
          # Configurar projeto e target
          firebase use $PROJECT_ID
          firebase target:apply hosting hml $FRONTEND_SITE
          
          # Deploy usando configuraÃ§Ã£o HML
          firebase deploy --only hosting:hml --config firebase.hml.json --force
          
          # Obter URL
          FRONTEND_URL="https://${FRONTEND_SITE}.web.app"
          echo "url=$FRONTEND_URL" >> $GITHUB_OUTPUT
          echo "ğŸŒ Frontend URL: $FRONTEND_URL"
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}

  # =====================================
  # Reset Dados HML & Smoke Tests
  # =====================================
  post-deploy:
    name: ğŸ§ª Post-Deploy & Tests
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]
    if: always() && needs.deploy-backend.result == 'success' && needs.deploy-frontend.result == 'success'
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ”„ Reset HML Data
        run: |
          echo "ğŸŒ± Resetando dados HML..."
          bash scripts/seed-hml-data.sh
        env:
          SERVICE_URL: ${{ needs.deploy-backend.outputs.service-url }}
          SEED_TOKEN: ${{ secrets.SECRET_KEY }}

      - name: ğŸ§ª Smoke Tests
        run: |
          echo "ğŸ§ª Executando smoke tests..."
          
          BACKEND_URL="${{ needs.deploy-backend.outputs.service-url }}"
          FRONTEND_URL="${{ needs.deploy-frontend.outputs.frontend-url }}"
          
          # Health checks
          curl -f "$BACKEND_URL/health" || exit 1
          curl -f "$BACKEND_URL/api/v1/personas" || exit 1
          curl -f "$FRONTEND_URL" || exit 1
          
          echo "âœ… Todos os smoke tests passaram"

      - name: ğŸ“Š Generate Test Report
        if: always()
        run: |
          cat > test-report.md << EOF
          # ğŸ“‹ HML Deploy Report
          
          **ğŸš€ Deploy:** \`$GITHUB_SHA\`
          **ğŸŒ¿ Branch:** \`$GITHUB_REF_NAME\`
          **â° Timestamp:** \`$(date -u)\`
          
          ## ğŸ”— URLs
          - **Backend:** ${{ needs.deploy-backend.outputs.service-url }}
          - **Frontend:** ${{ needs.deploy-frontend.outputs.frontend-url }}
          
          ## âœ… Status
          - Quality Gates: ${{ needs.quality-gates.result }}
          - Backend Deploy: ${{ needs.deploy-backend.result }}
          - Frontend Deploy: ${{ needs.deploy-frontend.result }}
          - Smoke Tests: ${{ job.status }}
          
          ## ğŸ§ª Next Steps
          1. **Testes Manuais:** Validar funcionalidades crÃ­ticas
          2. **QA Review:** Aprovar para produÃ§Ã£o
          3. **Deploy Prod:** Executar workflow de produÃ§Ã£o
          
          ---
          ğŸ¤– *RelatÃ³rio gerado automaticamente pelo GitHub Actions*
          EOF
          
          echo "ğŸ“Š RelatÃ³rio de deploy criado"

  # =====================================
  # NotificaÃ§Ãµes
  # =====================================
  notify:
    name: ğŸ“¢ Send Notifications
    runs-on: ubuntu-latest
    needs: [quality-gates, deploy-backend, deploy-frontend, post-deploy]
    if: always()
    
    steps:
      - name: ğŸ“± Telegram Notification (Admins)
        if: always()
        run: |
          # Status do deploy
          if [[ "${{ needs.post-deploy.result }}" == "success" ]]; then
            STATUS="âœ… SUCESSO"
            EMOJI="ğŸ‰"
          else
            STATUS="âŒ FALHOU"
            EMOJI="ğŸš¨"
          fi
          
          # Commit info
          COMMIT_SHA=$(echo $GITHUB_SHA | cut -c1-7)
          COMMIT_MSG=$(git log -1 --pretty=%B | head -1)
          
          # Mensagem
          MESSAGE="$EMOJI *Deploy HML $STATUS*
          
          ğŸ“¦ *Commit:* \`$COMMIT_SHA\`
          ğŸ“ *Mensagem:* $COMMIT_MSG
          ğŸŒ¿ *Branch:* \`$GITHUB_REF_NAME\`
          â° *Timestamp:* \`$(date -u)\`
          
          ğŸ”— *URLs:*
          â€¢ Backend: ${{ needs.deploy-backend.outputs.service-url }}
          â€¢ Frontend: ${{ needs.deploy-frontend.outputs.frontend-url }}
          
          ğŸ“Š *Status:*
          â€¢ Quality Gates: ${{ needs.quality-gates.result }}
          â€¢ Backend: ${{ needs.deploy-backend.result }}
          â€¢ Frontend: ${{ needs.deploy-frontend.result }}
          â€¢ Tests: ${{ needs.post-deploy.result }}
          
          ğŸ‘¥ *PrÃ³ximos Passos:*
          1. Revisar ambiente HML
          2. Executar testes manuais
          3. Aprovar para produÃ§Ã£o se OK"
          
          # Enviar para Telegram
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d text="$MESSAGE" \
            -d parse_mode="Markdown"

      - name: ğŸ“§ Email Notification (On Failure)
        if: failure()
        run: |
          echo "ğŸ“§ Deploy HML falhou - notificaÃ§Ã£o por email seria enviada aqui"
          # Implementar notificaÃ§Ã£o por email se necessÃ¡rio

# =====================================
# Workflow Summary
# =====================================
concurrency:
  group: hml-deploy-${{ github.ref }}
  cancel-in-progress: true