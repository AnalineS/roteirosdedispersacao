============================= test session starts =============================
platform win32 -- Python 3.13.5, pytest-8.4.1, pluggy-1.6.0 -- C:\Python313\python.exe
cachedir: .pytest_cache
rootdir: C:\Users\Ana\Meu Drive\Site roteiro de dispensação
plugins: anyio-4.9.0, cov-6.2.1, mock-3.14.1
collecting ... collected 7 items

tests/security/test_stack_trace_exposure.py::TestStackTraceExposurePrevention::test_error_handler_no_stack_trace_in_logs PASSED [ 14%]
tests/security/test_stack_trace_exposure.py::TestStackTraceExposurePrevention::test_import_error_sanitization PASSED [ 28%]
tests/security/test_stack_trace_exposure.py::TestStackTraceExposurePrevention::test_configuration_error_sanitization PASSED [ 42%]
tests/security/test_stack_trace_exposure.py::TestStackTraceExposurePrevention::test_startup_error_sanitization PASSED [ 57%]
tests/security/test_stack_trace_exposure.py::TestStackTraceExposurePrevention::test_log_injection_prevention PASSED [ 71%]
tests/security/test_stack_trace_exposure.py::TestSecurityComplianceValidation::test_cwe_209_information_exposure_prevention FAILED [ 85%]
tests/security/test_stack_trace_exposure.py::TestSecurityComplianceValidation::test_cwe_497_information_exposure_prevention PASSED [100%]

================================== FAILURES ===================================
_ TestSecurityComplianceValidation.test_cwe_209_information_exposure_prevention _

self = <test_stack_trace_exposure.TestSecurityComplianceValidation object at 0x000001DBE8D8C550>

    def test_cwe_209_information_exposure_prevention(self):
        """Test compliance with CWE-209: Information Exposure Through Error Messages"""
    
        # List of sensitive information that should never appear in error messages
        sensitive_patterns = [
            'password',
            'secret_key',
            'api_key',
            'database',
            'localhost',
            '127.0.0.1',
            'admin',
            'root',
            'config',
            'environment',
            'token',
            'credential'
        ]
    
        # Test error messages don't contain sensitive patterns
        error_messages = [
            "Erro interno [Exception]: Erro processamento request",
            "\u274c Erro ao carregar Fallback Inteligente: ImportError",
            "\u26a0\ufe0f Erro ao inicializar Security Middleware [Exception]: Configura\xe7\xe3o indispon\xedvel",
            "\u26a0\ufe0f Erro ao configurar JWT [Exception]: Configura\xe7\xe3o de autentica\xe7\xe3o indispon\xedvel"
        ]
    
        for message in error_messages:
            for pattern in sensitive_patterns:
>               assert pattern.lower() not in message.lower(), f"Sensitive pattern '{pattern}' found in: {message}"
E               AssertionError: Sensitive pattern 'config' found in: \u26a0\ufe0f Erro ao inicializar Security Middleware [Exception]: Configura\xe7\xe3o indispon\xedvel
E               assert 'config' not in '\u26a0\ufe0f erro ao ...indispon\xedvel'
E                 
E                 'config' is contained here:
E                   \u26a0\ufe0f erro ao inicializar security middleware [exception]: configura\xe7\xe3o indispon\xedvel
E                 ?                                                         ++++++

tests\security\test_stack_trace_exposure.py:223: AssertionError
============================== warnings summary ===============================
tests/security/test_stack_trace_exposure.py: 168 warnings
  C:\Users\Ana\Meu Drive\Site roteiro de dispensação\tests\security\../../apps/backend\core\logging\advanced_logger.py:134: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    'timestamp': datetime.utcnow().isoformat() + 'Z',

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ===========================
FAILED tests/security/test_stack_trace_exposure.py::TestSecurityComplianceValidation::test_cwe_209_information_exposure_prevention
================== 1 failed, 6 passed, 168 warnings in 1.03s ==================
