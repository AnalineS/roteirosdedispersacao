<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Conectividade - Roteiros de Dispensação</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
        }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 Diagnóstico do Sistema - Roteiros de Dispensação</h1>
        <p><strong>Data:</strong> <span id="timestamp"></span></p>
        
        <div id="basic-test" class="status info">
            ✅ HTML carregado corretamente
        </div>

        <div id="js-test" class="status warning">
            ⏳ Testando JavaScript...
        </div>

        <div id="api-test" class="status warning">
            ⏳ Testando conectividade com API...
        </div>

        <div id="firebase-test" class="status warning">
            ⏳ Testando configuração Firebase...
        </div>

        <div style="margin: 20px 0;">
            <button onclick="runFullTest()">🔄 Executar Todos os Testes</button>
            <button onclick="testMainApp()">🚀 Testar App Principal</button>
            <button onclick="clearResults()">🧹 Limpar Resultados</button>
        </div>

        <div id="results" class="hidden">
            <h3>📊 Resultados Detalhados:</h3>
            <pre id="results-content"></pre>
        </div>

        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;">
            <h3>🔗 Links de Teste:</h3>
            <ul>
                <li><a href="/" target="_blank">🏠 Homepage Principal (React)</a></li>
                <li><a href="/chat" target="_blank">💬 Página de Chat</a></li>
                <li><a href="/test.html" target="_blank">🔧 Esta Página de Teste</a></li>
            </ul>
        </div>
    </div>

    <script>
        // Set timestamp
        document.getElementById('timestamp').textContent = new Date().toLocaleString('pt-BR');

        // Test JavaScript execution
        setTimeout(() => {
            const jsTest = document.getElementById('js-test');
            jsTest.className = 'status success';
            jsTest.textContent = '✅ JavaScript executando corretamente';
        }, 100);

        let testResults = {
            timestamp: new Date().toISOString(),
            tests: {}
        };

        async function testAPI() {
            const apiTest = document.getElementById('api-test');
            
            try {
                // Test multiple API endpoints
                const apiUrls = [
                    'https://roteiro-dispensacao-api-1016586236354.us-central1.run.app/api/health',
                    'https://roteiros-de-dispensacao.web.app/api/health',
                    'https://api.roteirosdedispensacao.com/api/health'
                ];

                let successfulConnection = false;
                let lastError = null;

                for (const url of apiUrls) {
                    try {
                        console.log(`🔍 Testando API: ${url}`);
                        const response = await fetch(url, {
                            method: 'GET',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            timeout: 10000
                        });

                        if (response.ok) {
                            const data = await response.json();
                            apiTest.className = 'status success';
                            apiTest.textContent = `✅ API conectada: ${url}`;
                            testResults.tests.api = { success: true, url, status: response.status, data };
                            successfulConnection = true;
                            break;
                        }
                    } catch (error) {
                        console.warn(`❌ Falha na API ${url}:`, error);
                        lastError = error;
                    }
                }

                if (!successfulConnection) {
                    apiTest.className = 'status error';
                    apiTest.textContent = `❌ Todas as APIs falharam. Último erro: ${lastError?.message || 'Desconhecido'}`;
                    testResults.tests.api = { success: false, error: lastError?.message || 'Connection failed' };
                }

            } catch (error) {
                console.error('Erro no teste de API:', error);
                apiTest.className = 'status error';
                apiTest.textContent = `❌ Erro no teste de API: ${error.message}`;
                testResults.tests.api = { success: false, error: error.message };
            }
        }

        function testFirebaseConfig() {
            const firebaseTest = document.getElementById('firebase-test');
            
            try {
                // Test current URL and environment
                const currentUrl = window.location.href;
                const isFirebase = currentUrl.includes('web.app') || currentUrl.includes('firebaseapp.com');
                const isLocal = currentUrl.includes('localhost') || currentUrl.includes('127.0.0.1');
                
                let status = '';
                if (isFirebase) {
                    status = '✅ Rodando no Firebase Hosting';
                    firebaseTest.className = 'status success';
                } else if (isLocal) {
                    status = '⚠️ Rodando localmente';
                    firebaseTest.className = 'status warning';
                } else {
                    status = '❓ Ambiente desconhecido';
                    firebaseTest.className = 'status info';
                }
                
                firebaseTest.textContent = `${status} - URL: ${currentUrl}`;
                
                testResults.tests.firebase = {
                    url: currentUrl,
                    isFirebase,
                    isLocal,
                    userAgent: navigator.userAgent,
                    timestamp: new Date().toISOString()
                };

            } catch (error) {
                console.error('Erro no teste Firebase:', error);
                firebaseTest.className = 'status error';
                firebaseTest.textContent = `❌ Erro no teste Firebase: ${error.message}`;
                testResults.tests.firebase = { success: false, error: error.message };
            }
        }

        async function runFullTest() {
            console.log('🚀 Iniciando diagnóstico completo...');
            
            // Reset results
            testResults = {
                timestamp: new Date().toISOString(),
                tests: {}
            };

            // Run tests
            testFirebaseConfig();
            await testAPI();
            
            // Show results
            displayResults();
        }

        function testMainApp() {
            // Try to navigate to main app
            window.location.href = '/';
        }

        function displayResults() {
            const resultsDiv = document.getElementById('results');
            const resultsContent = document.getElementById('results-content');
            
            resultsContent.textContent = JSON.stringify(testResults, null, 2);
            resultsDiv.classList.remove('hidden');
            
            console.log('📊 Resultados completos:', testResults);
        }

        function clearResults() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.classList.add('hidden');
            console.clear();
        }

        // Auto-run basic tests on load
        window.addEventListener('load', () => {
            setTimeout(() => {
                testFirebaseConfig();
                testAPI();
            }, 500);
        });

        // Log any errors
        window.addEventListener('error', (event) => {
            console.error('🚨 Erro JavaScript capturado:', event.error);
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error('🚨 Promise rejeitada:', event.reason);
        });

        console.log('🔧 Página de diagnóstico carregada com sucesso!');
    </script>
</body>
</html>