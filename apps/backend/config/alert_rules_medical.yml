# Regras de Alerta Prometheus para Plataforma M√©dico-Educacional
# Roteiros de Dispensa√ß√£o PQT-U
#
# Alertas espec√≠ficos para sistemas cr√≠ticos de uma plataforma educacional m√©dica
# com foco em seguran√ßa de dados m√©dicos, performance de IA e compliance

groups:
  # ===== ALERTAS CR√çTICOS DE SISTEMA =====
  - name: medical_platform_critical
    interval: 30s
    rules:
      # Sistema indispon√≠vel
      - alert: MedicalPlatformDown
        expr: up{job="roteiro-dispensacao-backend"} == 0
        for: 1m
        labels:
          severity: critical
          medical_impact: system_unavailable
          compliance_risk: high
        annotations:
          summary: "üö® Plataforma m√©dica educacional indispon√≠vel"
          description: "A plataforma educacional para dispensa√ß√£o PQT-U est√° indispon√≠vel h√° {{ $value }} minutos. Isso afeta profissionais de sa√∫de que dependem do sistema para consultas m√©dicas."
          impact: "Profissionais de sa√∫de sem acesso a informa√ß√µes cr√≠ticas sobre hansen√≠ase"
          action: "Verificar logs do sistema e restaurar servi√ßo imediatamente"
          
      # CPU cr√≠tico - pode afetar c√°lculos m√©dicos
      - alert: MedicalPlatformHighCPU
        expr: medical_platform_system_cpu_usage_percent > 90
        for: 5m
        labels:
          severity: critical
          medical_impact: performance_degradation
          compliance_risk: medium
        annotations:
          summary: "üî• CPU alto na plataforma m√©dica ({{ $value }}%)"
          description: "CPU acima de 90% por mais de 5 minutos pode afetar c√°lculos de dosagem e performance de IA m√©dica"
          impact: "Risco de lentid√£o em c√°lculos m√©dicos cr√≠ticos"
          action: "Investigar processos consumindo CPU e escalar recursos se necess√°rio"
          
      # Mem√≥ria cr√≠tica
      - alert: MedicalPlatformHighMemory
        expr: medical_platform_system_memory_usage_percent > 95
        for: 3m
        labels:
          severity: critical
          medical_impact: system_stability
          compliance_risk: medium
        annotations:
          summary: "üß† Mem√≥ria cr√≠tica na plataforma m√©dica ({{ $value }}%)"
          description: "Uso de mem√≥ria acima de 95% pode causar instabilidade em sistemas de IA m√©dica"
          impact: "Risco de falhas em processamento de consultas m√©dicas"
          action: "Liberar mem√≥ria ou escalar recursos imediatamente"
          
      # Disco cheio - cr√≠tico para logs de auditoria m√©dica
      - alert: MedicalPlatformDiskFull
        expr: medical_platform_system_disk_usage_percent > 95
        for: 2m
        labels:
          severity: critical
          medical_impact: data_loss_risk
          compliance_risk: high
        annotations:
          summary: "üíæ Disco quase cheio na plataforma m√©dica ({{ $value }}%)"
          description: "Espa√ßo em disco cr√≠tico pode interromper logs de auditoria e conformidade LGPD"
          impact: "Risco de perda de dados de auditoria m√©dica"
          action: "Limpar logs antigos ou expandir armazenamento urgentemente"

  # ===== ALERTAS DE PERFORMANCE M√âDICA =====
  - name: medical_platform_performance
    interval: 1m
    rules:
      # Tempo de resposta alto para consultas m√©dicas
      - alert: SlowMedicalQueries
        expr: rate(medical_platform_http_request_duration_seconds_sum{endpoint=~".*chat.*|.*calculate.*"}[5m]) / rate(medical_platform_http_request_duration_seconds_count{endpoint=~".*chat.*|.*calculate.*"}[5m]) > 10
        for: 3m
        labels:
          severity: warning
          medical_impact: user_experience
          compliance_risk: low
        annotations:
          summary: "üêå Consultas m√©dicas lentas ({{ $value }}s m√©dia)"
          description: "Tempo de resposta para consultas m√©dicas acima de 10 segundos"
          impact: "Experi√™ncia degradada para profissionais de sa√∫de"
          action: "Otimizar queries RAG ou escalar recursos de IA"
          
      # Taxa de erro alta em endpoints m√©dicos
      - alert: HighMedicalErrorRate
        expr: rate(medical_platform_http_requests_total{status_code=~"5.*",endpoint=~".*chat.*|.*calculate.*"}[5m]) / rate(medical_platform_http_requests_total{endpoint=~".*chat.*|.*calculate.*"}[5m]) * 100 > 5
        for: 2m
        labels:
          severity: warning
          medical_impact: service_reliability
          compliance_risk: medium
        annotations:
          summary: "‚ùå Alta taxa de erro em servi√ßos m√©dicos ({{ $value }}%)"
          description: "Taxa de erro acima de 5% em endpoints de consulta m√©dica"
          impact: "Consultas m√©dicas falhando, afetando profissionais de sa√∫de"
          action: "Investigar logs de erro e corrigir problemas de backend"
          
      # Sistema RAG lento
      - alert: SlowRAGSystem
        expr: rate(medical_platform_ai_rag_query_duration_seconds_sum[5m]) / rate(medical_platform_ai_rag_query_duration_seconds_count[5m]) > 5
        for: 2m
        labels:
          severity: warning
          medical_impact: ai_performance
          compliance_risk: low
        annotations:
          summary: "ü§ñ Sistema RAG m√©dico lento ({{ $value }}s m√©dia)"
          description: "Queries RAG para conhecimento m√©dico levando mais de 5 segundos"
          impact: "IA m√©dica respondendo lentamente"
          action: "Otimizar √≠ndices de busca ou cache de conhecimento m√©dico"

  # ===== ALERTAS DE SEGURAN√áA M√âDICA =====
  - name: medical_platform_security
    interval: 30s
    rules:
      # Eventos de seguran√ßa cr√≠ticos
      - alert: CriticalSecurityEvent
        expr: increase(medical_platform_security_events_total{severity="critical"}[5m]) > 0
        for: 0m
        labels:
          severity: critical
          medical_impact: data_security
          compliance_risk: critical
        annotations:
          summary: "üö® Evento de seguran√ßa cr√≠tico detectado"
          description: "{{ $value }} eventos de seguran√ßa cr√≠ticos nos √∫ltimos 5 minutos"
          impact: "Poss√≠vel comprometimento de dados m√©dicos"
          action: "Investigar imediatamente e ativar protocolo de seguran√ßa"
          
      # Falhas de valida√ß√£o de entrada m√©dica
      - alert: MedicalInputValidationFailures
        expr: increase(medical_platform_input_validation_failures_total[10m]) > 10
        for: 1m
        labels:
          severity: warning
          medical_impact: data_integrity
          compliance_risk: medium
        annotations:
          summary: "‚ö†Ô∏è M√∫ltiplas falhas de valida√ß√£o de dados m√©dicos"
          description: "{{ $value }} falhas de valida√ß√£o de entrada nos √∫ltimos 10 minutos"
          impact: "Poss√≠vel tentativa de inser√ß√£o de dados m√©dicos inv√°lidos"
          action: "Revisar logs de valida√ß√£o e fortalecer controles de entrada"
          
      # Tentativas de acesso n√£o autorizadas
      - alert: UnauthorizedMedicalAccess
        expr: increase(medical_platform_http_requests_total{status_code="403"}[5m]) > 5
        for: 2m
        labels:
          severity: warning
          medical_impact: access_control
          compliance_risk: high
        annotations:
          summary: "üîí M√∫ltiplas tentativas de acesso n√£o autorizado"
          description: "{{ $value }} tentativas de acesso negado nos √∫ltimos 5 minutos"
          impact: "Poss√≠vel tentativa de acesso n√£o autorizado a dados m√©dicos"
          action: "Verificar logs de autentica√ß√£o e considerar bloqueio de IP"

  # ===== ALERTAS DE IA M√âDICA =====
  - name: medical_ai_system
    interval: 1m
    rules:
      # QA Score baixo para respostas m√©dicas
      - alert: LowMedicalQAScore
        expr: medical_platform_ai_qa_score < 0.7
        for: 3m
        labels:
          severity: warning
          medical_impact: response_quality
          compliance_risk: medium
        annotations:
          summary: "üìâ Score de qualidade de IA m√©dica baixo ({{ $value }})"
          description: "Score m√©dio de QA para respostas m√©dicas abaixo de 0.7"
          impact: "Qualidade das respostas m√©dicas pode estar comprometida"
          action: "Revisar configura√ß√µes de IA e treinar modelos se necess√°rio"
          
      # Desbalanceamento entre personas m√©dicas
      - alert: PersonaImbalance
        expr: abs(medical_platform_persona_requests_total{persona="dr_gasnelio"} - medical_platform_persona_requests_total{persona="ga"}) / (medical_platform_persona_requests_total{persona="dr_gasnelio"} + medical_platform_persona_requests_total{persona="ga"}) > 0.8
        for: 10m
        labels:
          severity: info
          medical_impact: user_preference
          compliance_risk: low
        annotations:
          summary: "‚öñÔ∏è Desbalanceamento no uso de personas m√©dicas"
          description: "Uma das personas (Dr. Gasnelio ou G√°) est√° sendo muito mais utilizada que a outra"
          impact: "Poss√≠vel prefer√™ncia por estilo de comunica√ß√£o m√©dica"
          action: "Monitorar padr√µes de uso e ajustar interface se necess√°rio"
          
      # Cache m√©dico com baixa efici√™ncia
      - alert: LowMedicalCacheHitRate
        expr: rate(medical_platform_cache_requests_total{hit_miss="hit"}[10m]) / rate(medical_platform_cache_requests_total[10m]) < 0.3
        for: 5m
        labels:
          severity: info
          medical_impact: performance
          compliance_risk: low
        annotations:
          summary: "üì¶ Taxa de hit do cache m√©dico baixa ({{ $value }})"
          description: "Cache de conhecimento m√©dico com efici√™ncia abaixo de 30%"
          impact: "Consultas m√©dicas mais lentas devido a cache ineficiente"
          action: "Revisar estrat√©gia de cache para dados m√©dicos"

  # ===== ALERTAS DE COMPLIANCE M√âDICO =====
  - name: medical_compliance
    interval: 5m
    rules:
      # Visualiza√ß√µes de disclaimer m√©dico baixas
      - alert: LowMedicalDisclaimerViews
        expr: increase(medical_platform_medical_disclaimer_views_total{action="view"}[1h]) < 10
        for: 30m
        labels:
          severity: info
          medical_impact: legal_compliance
          compliance_risk: medium
        annotations:
          summary: "üìã Poucas visualiza√ß√µes de disclaimers m√©dicos"
          description: "Menos de 10 visualiza√ß√µes de disclaimers m√©dicos na √∫ltima hora"
          impact: "Poss√≠vel problema com exibi√ß√£o de avisos legais m√©dicos"
          action: "Verificar sistema de disclaimers e interface de usu√°rio"
          
      # C√°lculos de dosagem com falhas
      - alert: DosageCalculationFailures
        expr: increase(medical_platform_dosage_calculations_total{success="false"}[10m]) > 2
        for: 1m
        labels:
          severity: critical
          medical_impact: medication_safety
          compliance_risk: critical
        annotations:
          summary: "üíä Falhas em c√°lculos de dosagem m√©dica"
          description: "{{ $value }} falhas em c√°lculos de dosagem nos √∫ltimos 10 minutos"
          impact: "Risco de c√°lculos incorretos de medica√ß√£o PQT-U"
          action: "Investigar algoritmos de c√°lculo e validar f√≥rmulas m√©dicas IMEDIATAMENTE"
          
      # Eventos LGPD
      - alert: LGPDComplianceEvent
        expr: increase(medical_platform_lgpd_compliance_events_total[1h]) > 0
        for: 0m
        labels:
          severity: info
          medical_impact: data_privacy
          compliance_risk: high
        annotations:
          summary: "‚öñÔ∏è Evento de compliance LGPD registrado"
          description: "{{ $value }} eventos relacionados a LGPD nas √∫ltimas horas"
          impact: "Atividade relacionada a prote√ß√£o de dados pessoais de sa√∫de"
          action: "Revisar logs de LGPD e documentar conformidade"