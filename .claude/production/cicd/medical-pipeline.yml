# CI/CD Pipeline M√©dico para Plataforma de Hansen√≠ase
# Pipeline espec√≠fico para ambiente m√©dico com valida√ß√µes LGPD

name: Medical CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    # Builds automatizados di√°rios para ambiente m√©dico
    - cron: '0 2 * * *'

env:
  NODE_VERSION: '20'
  MEDICAL_MODE: 'true'
  LGPD_COMPLIANCE: 'required'
  SLA_TARGET: '99.9'

jobs:
  # Verifica√ß√µes de Compliance M√©dico
  medical-compliance-check:
    name: üè• Medical Compliance Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: LGPD Compliance Check
        run: |
          echo "üîí Verificando compliance LGPD..."
          npm run compliance:lgpd
      
      - name: Medical Protocol Validation
        run: |
          echo "ü©∫ Validando protocolos m√©dicos..."
          npm run validate:medical-protocols
      
      - name: Security Scan
        run: |
          echo "üõ°Ô∏è Executando scan de seguran√ßa m√©dica..."
          npm audit --audit-level=moderate
          npm run security:scan
      
      - name: Data Encryption Check
        run: |
          echo "üîê Verificando criptografia de dados m√©dicos..."
          npm run validate:encryption

  # Testes M√©dicos Espec√≠ficos
  medical-tests:
    name: üß™ Medical Tests
    runs-on: ubuntu-latest
    needs: medical-compliance-check
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: hanseniase_test
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run Medical Unit Tests
        run: |
          echo "üß¨ Executando testes de unidade m√©dicos..."
          npm run test:medical:unit
      
      - name: Run Protocol Tests
        run: |
          echo "üìã Testando protocolos m√©dicos..."
          npm run test:protocols
      
      - name: Run Calculation Tests
        run: |
          echo "üßÆ Testando calculadoras m√©dicas..."
          npm run test:calculations
      
      - name: Run Dr. Gasnelio Tests
        run: |
          echo "üë®‚Äç‚öïÔ∏è Testando persona Dr. Gasnelio..."
          npm run test:gasnelio
      
      - name: Run Integration Tests
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/hanseniase_test
          REDIS_URL: redis://localhost:6379
        run: |
          echo "üîó Executando testes de integra√ß√£o m√©dica..."
          npm run test:medical:integration
      
      - name: Generate Test Report
        run: |
          echo "üìä Gerando relat√≥rio de testes m√©dicos..."
          npm run test:report
      
      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        with:
          name: medical-test-results
          path: test-results/

  # Performance Tests para SLA 99.9%
  performance-tests:
    name: ‚ö° Performance Tests
    runs-on: ubuntu-latest
    needs: medical-tests
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Medical Response Time Test
        run: |
          echo "‚è±Ô∏è Testando tempos de resposta m√©dicos..."
          npm run perf:response-time
      
      - name: Load Test Medical Endpoints
        run: |
          echo "üöÄ Teste de carga em endpoints m√©dicos..."
          npm run perf:load-test
      
      - name: Memory Leak Detection
        run: |
          echo "üß† Detectando vazamentos de mem√≥ria..."
          npm run perf:memory-leak
      
      - name: SLA Validation
        run: |
          echo "üìä Validando SLA de 99.9%..."
          npm run validate:sla

  # Build e Containeriza√ß√£o
  build-medical:
    name: üèóÔ∏è Build Medical Application
    runs-on: ubuntu-latest
    needs: [medical-compliance-check, medical-tests, performance-tests]
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      image-digest: ${{ steps.build.outputs.digest }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to Docker Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.DOCKER_REGISTRY }}
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.DOCKER_REGISTRY }}/hanseniase/app
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-
            type=raw,value=medical-{{date 'YYYYMMDD-HHmmss'}}
      
      - name: Build and push medical image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.medical
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            MEDICAL_MODE=true
            LGPD_COMPLIANCE=true
            NODE_ENV=production
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Medical Image Security Scan
        run: |
          echo "üîç Executando scan de seguran√ßa na imagem m√©dica..."
          docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
            aquasec/trivy image ${{ steps.meta.outputs.tags }}

  # Deploy para Staging M√©dico
  deploy-staging:
    name: üöÄ Deploy to Medical Staging
    runs-on: ubuntu-latest
    needs: build-medical
    environment: medical-staging
    if: github.ref == 'refs/heads/develop'
    steps:
      - uses: actions/checkout@v4
      
      - name: Deploy to Medical Staging
        env:
          KUBECONFIG: ${{ secrets.KUBECONFIG_STAGING }}
          IMAGE_TAG: ${{ needs.build-medical.outputs.image-tag }}
        run: |
          echo "üè• Iniciando deploy para staging m√©dico..."
          
          # Atualizar manifests Kubernetes
          sed -i "s|hanseniase/app:.*|$IMAGE_TAG|g" k8s/staging/*.yaml
          
          # Aplicar configura√ß√µes m√©dicas
          kubectl apply -f k8s/staging/
          
          # Aguardar rollout
          kubectl rollout status deployment/hanseniase-app -n medical-staging
      
      - name: Medical Staging Health Check
        run: |
          echo "ü©∫ Verificando sa√∫de do staging m√©dico..."
          curl -f https://staging-medical.hanseniase.edu.br/api/health
          curl -f https://staging-medical.hanseniase.edu.br/api/medical/protocols/health
      
      - name: Run Smoke Tests
        run: |
          echo "üí® Executando smoke tests m√©dicos..."
          npm run test:smoke:medical -- --env=staging

  # Deploy para Produ√ß√£o M√©dica
  deploy-production:
    name: üè• Deploy to Medical Production
    runs-on: ubuntu-latest
    needs: [build-medical, deploy-staging]
    environment: medical-production
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      
      - name: Medical Pre-deployment Checks
        run: |
          echo "üîç Executando verifica√ß√µes pr√©-deploy m√©dico..."
          npm run pre-deploy:medical
      
      - name: Create Medical Backup
        env:
          KUBECONFIG: ${{ secrets.KUBECONFIG_PRODUCTION }}
        run: |
          echo "üíæ Criando backup m√©dico pr√©-deploy..."
          kubectl exec -n medical-production deployment/hanseniase-db -- \
            pg_dump hanseniase_medical > backup-pre-deploy-$(date +%Y%m%d-%H%M%S).sql
      
      - name: Deploy to Medical Production
        env:
          KUBECONFIG: ${{ secrets.KUBECONFIG_PRODUCTION }}
          IMAGE_TAG: ${{ needs.build-medical.outputs.image-tag }}
        run: |
          echo "üöÄ Iniciando deploy m√©dico zero-downtime..."
          
          # Blue-Green Deployment
          sed -i "s|hanseniase/app:.*|$IMAGE_TAG|g" k8s/production/*.yaml
          
          kubectl apply -f k8s/production/
          kubectl rollout status deployment/hanseniase-app -n medical-production --timeout=600s
      
      - name: Medical Production Validation
        run: |
          echo "‚úÖ Validando produ√ß√£o m√©dica..."
          
          # Health checks cr√≠ticos
          curl -f https://hanseniase.edu.br/api/health
          curl -f https://hanseniase.edu.br/api/medical/protocols/health
          curl -f https://hanseniase.edu.br/api/gasnelio/health
          curl -f https://hanseniase.edu.br/api/patient/data-protection/health
          
          # Valida√ß√£o LGPD
          curl -f https://hanseniase.edu.br/api/audit/lgpd-status
      
      - name: Run Production Medical Tests
        run: |
          echo "üß™ Executando testes m√©dicos em produ√ß√£o..."
          npm run test:production:medical
      
      - name: Update Medical Monitoring
        env:
          MONITORING_WEBHOOK: ${{ secrets.MEDICAL_MONITORING_WEBHOOK }}
        run: |
          echo "üìä Atualizando monitoramento m√©dico..."
          curl -X POST $MONITORING_WEBHOOK \
            -H "Content-Type: application/json" \
            -d '{"event": "deployment_completed", "version": "${{ needs.build-medical.outputs.image-tag }}", "medical": true}'

  # Notifica√ß√µes M√©dicas
  notify-medical-team:
    name: üì± Notify Medical Team
    runs-on: ubuntu-latest
    needs: [deploy-production]
    if: always()
    steps:
      - name: Send Medical Deployment Notification
        env:
          SLACK_WEBHOOK: ${{ secrets.MEDICAL_SLACK_WEBHOOK }}
          DEPLOYMENT_STATUS: ${{ needs.deploy-production.result }}
        run: |
          if [ "$DEPLOYMENT_STATUS" = "success" ]; then
            MESSAGE="‚úÖ üè• Deploy m√©dico conclu√≠do com sucesso!\n\nSLA 99.9% mantido\nCompliance LGPD validado\nTodos os sistemas m√©dicos operacionais"
            COLOR="good"
          else
            MESSAGE="‚ùå üö® Falha no deploy m√©dico!\n\nInterven√ß√£o necess√°ria\nEquipe m√©dica deve ser notificada\nRollback pode ser necess√°rio"
            COLOR="danger"
          fi
          
          curl -X POST $SLACK_WEBHOOK \
            -H "Content-Type: application/json" \
            -d "{\"text\": \"$MESSAGE\", \"color\": \"$COLOR\", \"channel\": \"#medical-alerts\"}"
      
      - name: Send Email to Medical Team
        if: failure()
        env:
          MEDICAL_EMAIL_LIST: ${{ secrets.MEDICAL_EMAIL_LIST }}
        run: |
          echo "üìß Enviando notifica√ß√£o por email para equipe m√©dica..."
          # Implementar envio de email cr√≠tico